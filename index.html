<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ì²œê´‘ì—­ì‹œ íƒêµ¬ë™í˜¸íšŒ í† ìš”ë¦¬ê·¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;700;800;900&display=swap');
        body { font-family: 'Pretendard', -apple-system, sans-serif; background-color: #f1f5f9; letter-spacing: -0.02em; }
        ::-webkit-scrollbar { width: 4px; height: 4px; background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        body:not(.admin-mode-active) .admin-only { display: none !important; }
        body:not(.admin-mode-active) .admin-only-table-cell { display: none !important; }
        .member-inactive { opacity: 0.5; filter: grayscale(100%); }

        .tab-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-active { color: #4f46e5 !important; font-weight: 800; transform: translateY(-4px); }
        .tab-active::after { content: ''; position: absolute; bottom: -4px; width: 4px; height: 4px; background-color: #4f46e5; border-radius: 50%; }
        
        .btn-press { transition: transform 0.15s ease, box-shadow 0.15s ease; }
        .btn-press:active { transform: scale(0.96); box-shadow: none !important; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }

        .name-chip { display: inline-flex; align-items: center; background-color: #e0e7ff; color: #4338ca; font-size: 0.75rem; font-weight: bold; padding: 0.25rem 0.6rem; border-radius: 9999px; margin: 0.15rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .name-chip-empty { color: #9ca3af; font-size: 0.75rem; font-weight: 500; padding: 0.25rem; }
        
        /* ëŒ€ì§„í‘œìš© ìŠ¤íƒ€ì¼ */
        .diagonal-strike { background: linear-gradient(to top right, transparent calc(50% - 1px), #cbd5e1, transparent calc(50% + 1px)); background-color: #e2e8f0; }
        
        /* í† ë„ˆë¨¼íŠ¸ íŠ¸ë¦¬ CSS (ì–‘ë°©í–¥ ëŒ€ì¹­ ë° ìŠ¹íŒ¨ ì»¬ëŸ¬ë§) */
        .tourn-node { position: relative; }
        .border-r-line { border-right: 2px solid #94a3b8; }
        .border-l-line { border-left: 2px solid #94a3b8; }
        .border-t-line { border-top: 2px solid #94a3b8; }
        .border-b-line { border-bottom: 2px solid #94a3b8; }
        .rounded-bl-xl { border-bottom-left-radius: 0.75rem; }
        .rounded-tl-xl { border-top-left-radius: 0.75rem; }
        .rounded-br-xl { border-bottom-right-radius: 0.75rem; }
        .rounded-tr-xl { border-top-right-radius: 0.75rem; }
        
        .t-winner { background-color: #eff6ff !important; border: 2px solid #3b82f6 !important; color: #1d4ed8 !important; }
        .t-loser { background-color: #f8fafc !important; border: 1px solid #e2e8f0 !important; color: #94a3b8 !important; filter: grayscale(100%); opacity: 0.6; }

        /* ğŸ“¸ ì¹´í†¡ ìº¡ì²˜ë¥¼ ìœ„í•œ íŠ¹ìˆ˜ í´ë˜ìŠ¤ */
        .capture-mode { border: 2px solid #000 !important; border-radius: 0 !important; overflow: visible !important; box-shadow: none !important; background-color: #fff !important; margin: 0 auto !important; width: max-content !important; height: max-content !important; transform-origin: top left; }
        .capture-mode table { border-top: 2px solid #000 !important; border-bottom: 2px solid #000 !important; border-collapse: collapse !important; }
        .capture-mode th, .capture-mode td { border: 1px solid #000 !important; padding: 6px !important; color: #000 !important; font-weight: 900 !important; }
        .capture-mode input { display: none !important; }
        .capture-mode .capture-text { display: block !important; width: 100%; height: 100%; text-align: center; color: #000 !important; font-weight: 900 !important; }
        .capture-text { display: none; }
        .capture-mode .diagonal-strike { background: linear-gradient(to top right, transparent calc(50% - 1.5px), #000, transparent calc(50% + 1.5px)) !important; background-color: #f1f5f9 !important; }
        
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        #op-tourn-container::-webkit-scrollbar { height: 8px; }
        #op-tourn-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="mx-auto bg-slate-50 min-h-screen shadow-2xl relative pb-28 overflow-x-hidden transition-all duration-300 max-w-md" id="app-body">

    <header class="bg-gradient-to-r from-blue-700 to-indigo-600 p-4 text-white flex justify-between items-center relative z-20 shadow-md rounded-b-[2.5rem]">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight">ğŸ“ ì¸ì²œê´‘ì—­ì‹œ íƒêµ¬ë™í˜¸íšŒ</h1>
            <p class="text-[11px] opacity-80 font-medium mt-0.5">í† ìš”ë¦¬ê·¸ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleViewMode()" id="btn-view-toggle" class="bg-white/20 hover:bg-white/30 text-white backdrop-blur-sm px-3 py-1.5 rounded-xl transition text-[11px] font-extrabold shadow-inner border border-white/20 btn-press">
                ğŸ’» 
            </button>
            <button onclick="toggleAdmin()" id="btn-admin-lock" class="bg-white/20 hover:bg-white/30 text-white backdrop-blur-sm p-2 rounded-full transition w-9 h-9 flex items-center justify-center shadow-inner border border-white/20 btn-press">
                ğŸ”’
            </button>
        </div>
    </header>

    <div class="relative z-30 mt-4 px-4">
        
        <div id="view-ranking" class="animate-fade-in">
            <div class="flex justify-between items-center mb-3 px-1 gap-2">
                <select id="season-selector" class="flex-1 text-[12px] font-extrabold text-indigo-800 bg-white border-2 border-indigo-100 rounded-xl px-2.5 py-1.5 shadow-sm focus:ring-2 focus:ring-indigo-400 outline-none truncate" onchange="renderRanking()">
                    <option value="current">ğŸ“ í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì‹œì¦Œ</option>
                </select>
                <button onclick="downloadRankingExcel()" class="text-[11px] bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-xl border border-emerald-200 hover:bg-emerald-100 font-extrabold btn-press shadow-sm flex items-center gap-1 shrink-0">
                    ğŸ“Š ì—‘ì…€ ì €ì¥
                </button>
            </div>
            <div class="mb-2 px-1 text-right">
                <span id="ranking-instruction" class="text-[11px] text-indigo-600 font-bold bg-white/80 backdrop-blur-sm px-2.5 py-1.5 rounded-lg border border-indigo-100 shadow-sm transition-all">ğŸ‘† ì´ë¦„ì„ í„°ì¹˜í•˜ë©´ ìƒì„¸ê¸°ë¡</span>
            </div>
            
            <div class="shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 rounded-2xl bg-white overflow-hidden mb-2">
                <table class="w-full text-sm text-left text-slate-700">
                    <thead class="text-[10px] text-slate-400 uppercase bg-slate-50/80 border-b border-slate-100 font-bold tracking-wider">
                        <tr><th class="px-1 py-3 text-center w-8">ìˆœìœ„</th><th class="px-1 py-3 text-left w-14">ì„ ìˆ˜ëª…</th><th class="px-1 py-3 text-center w-8">ì¶œì„</th><th class="px-1 py-3 text-center w-6">ğŸ¥‡</th><th class="px-1 py-3 text-center w-6">ğŸ¥ˆ</th><th class="px-1 py-3 text-center w-6">ğŸ¥‰</th><th class="px-1 py-3 text-right w-10">ì´ì </th><th class="px-1 py-3 text-center w-10">ë³€ë™</th></tr>
                    </thead>
                    <tbody id="ranking-table-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <p class="text-[10px] text-slate-400 text-right px-2 mb-6">â€» ìˆœìœ„ëŠ” <b>ì—°íšŒì›</b> ë“±ê¸‰ë§Œ ì‚°ì •ë©ë‹ˆë‹¤. 0ì  íšŒì›ì€ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.</p>
        </div>

        <div id="view-operation" class="hidden animate-fade-in pb-10">
            <div class="bg-white p-4 rounded-2xl border border-indigo-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-6xl opacity-5">ğŸ‘¥</div>
                <div class="flex justify-between items-center mb-3 border-b border-indigo-50 pb-2 relative z-10">
                    <div>
                        <h3 class="font-extrabold text-indigo-800 text-base">âœ… ì˜¤ëŠ˜ ê²½ê¸° ì°¸ì„ì ëª…ë‹¨</h3>
                        <p class="text-[10px] text-slate-500 font-medium mt-0.5">ì—¬ê¸°ì„œ ëª…ë‹¨ì„ ì„ íƒí•˜ë©´, ì¡°í¸ì„± ì‹œ ì´ ëª…ë‹¨ë§Œ ëœ¹ë‹ˆë‹¤.</p>
                    </div>
                    <button onclick="openSelector('opAttend', 'ì˜¤ëŠ˜ ê²½ê¸° ì°¸ì„ì ì„ íƒ', false)" class="text-[11px] bg-indigo-600 text-white px-3 py-2 rounded-lg font-bold shadow-md btn-press">ëª…ë‹¨ ì„ íƒ</button>
                </div>
                <div id="ui-box-opAttend" class="min-h-[44px] bg-slate-50 rounded-xl p-2.5 border border-slate-200 cursor-pointer relative z-10" onclick="openSelector('opAttend', 'ì˜¤ëŠ˜ ê²½ê¸° ì°¸ì„ì ì„ íƒ', false)">
                    <span class="name-chip-empty text-slate-400">ğŸ‘† ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜¤ëŠ˜ ê²½ê¸° ì°¸ì„ìë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</span>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                    <div>
                        <h3 class="font-extrabold text-slate-800 text-base">ğŸ“ ì˜ˆì„  ì¡°ë³„ ë¦¬ê·¸ì „í‘œ</h3>
                        <p class="text-[10px] text-slate-400 font-medium mt-0.5">ì„ ìˆ˜ ì¹¸ì„ í„°ì¹˜í•˜ì—¬ ëª…ë‹¨ì„ ë°°ì¹˜í•˜ì„¸ìš”.</p>
                    </div>
                </div>
                
                <div class="flex flex-col gap-2 mb-4 bg-slate-50 p-2.5 rounded-xl border border-slate-200">
                    <div class="flex flex-wrap items-center gap-2">
                        <div class="flex items-center gap-1.5">
                            <span class="text-xs font-bold text-slate-600">ì¡° ê°œìˆ˜</span>
                            <select id="op-group-count" class="text-xs border border-slate-200 rounded p-1.5 font-bold text-indigo-700 bg-white" onchange="generateGroupSizeInputs()">
                                <option value="1">1ì¡°</option><option value="2" selected>2ì¡°</option><option value="3">3ì¡°</option><option value="4">4ì¡°</option>
                                <option value="5">5ì¡°</option><option value="6">6ì¡°</option><option value="7">7ì¡°</option><option value="8">8ì¡°</option>
                            </select>
                        </div>
                        
                        <div id="dynamic-group-sizes" class="flex flex-wrap gap-1.5 items-center border-l border-slate-300 pl-2"></div>
                        
                        <div class="ml-auto flex gap-1.5 mt-2 w-full justify-end flex-wrap items-center">
                            <button onclick="calculateGroupRankings()" class="text-[11px] bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-2.5 py-1.5 rounded-lg font-extrabold shadow-sm btn-press">ğŸ§® ìë™ìˆœìœ„</button>
                            <button onclick="loadTempTable()" class="text-[11px] bg-amber-500 text-white px-2.5 py-1.5 rounded-lg font-bold shadow-sm btn-press">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                            <button onclick="saveTempTable()" class="text-[11px] bg-amber-600 text-white px-2.5 py-1.5 rounded-lg font-bold shadow-sm btn-press">ğŸ’¾ ì„ì‹œì €ì¥</button>
                            <button onclick="sortGroupPlayers()" class="text-[11px] bg-emerald-600 text-white px-2.5 py-1.5 rounded-lg font-bold shadow-sm btn-press">ğŸ”€ ì •ë ¬</button>
                            <button onclick="renderGroupTable()" class="text-[11px] bg-slate-800 text-white px-3 py-1.5 rounded-lg font-bold shadow-sm btn-press">í‘œ ìƒì„±</button>
                        </div>
                    </div>
                </div>

                <div id="op-group-container" class="w-full overflow-x-auto pb-4">
                    <div class="text-center text-slate-400 text-xs py-8 bg-slate-50 rounded-xl border border-dashed border-slate-200">ì¡°ê±´ì„ ì„¤ì •í•˜ê³  í‘œ ìƒì„±ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                    <div>
                        <h3 class="font-extrabold text-slate-800 text-base">âš”ï¸ ë³¸ì„  ëŒ€ì§„í‘œ</h3>
                        <p class="text-[10px] text-slate-400 font-medium mt-0.5">ìµœëŒ€ 128ê°•ê¹Œì§€ ìë™ ìƒì„± ì§€ì›</p>
                    </div>
                    <button onclick="printTournament()" class="text-[11px] bg-rose-600 text-white px-3 py-2 rounded-lg font-bold shadow-md btn-press flex items-center gap-1">ğŸ–¨ï¸ ëŒ€ì§„í‘œ ì¸ì‡„</button>
                </div>

                <div class="flex flex-wrap items-center gap-2 mb-4 bg-slate-50 p-2.5 rounded-xl border border-slate-200">
                    <div class="flex items-center gap-1.5">
                        <span class="text-xs font-bold text-slate-600">ì˜ˆì„  ì¡°</span>
                        <select id="op-tourn-groups" class="text-xs border border-slate-200 rounded p-1 font-bold text-rose-600 bg-white"><option value="1">1ì¡°</option><option value="2">2ì¡°</option><option value="3">3ì¡°</option><option value="4" selected>4ì¡°</option><option value="5">5ì¡°</option><option value="6">6ì¡°</option><option value="7">7ì¡°</option><option value="8">8ì¡°</option></select>
                    </div>
                    <div class="w-px h-4 bg-slate-300"></div>
                    <div class="flex items-center gap-1.5">
                        <span class="text-xs font-bold text-slate-600">ì§„ì¶œì(ì¡°ë‹¹)</span>
                        <select id="op-tourn-adv" class="text-xs border border-slate-200 rounded p-1 font-bold text-rose-600 bg-white"><option value="1">1ëª…</option><option value="2" selected>2ëª…</option><option value="3">3ëª…</option><option value="4">4ëª…</option><option value="5">5ëª…</option><option value="6">6ëª…</option><option value="7">7ëª…</option><option value="8">8ëª…</option><option value="9">9ëª…</option><option value="10">10ëª…</option><option value="11">11ëª…</option><option value="12">12ëª…</option></select>
                    </div>
                    <button onclick="initTournamentState()" class="ml-auto text-[11px] bg-slate-800 text-white px-3 py-1.5 rounded-lg font-bold shadow-sm btn-press">ëŒ€ì§„í‘œ ìƒì„±</button>
                </div>
                
                <div class="mb-3 flex justify-between items-center gap-2">
                    <button onclick="loadQualifierResults()" class="flex-1 bg-indigo-50 text-indigo-700 border border-indigo-200 py-2 rounded-xl text-[11px] font-extrabold shadow-sm btn-press">ğŸ“¥ ì˜ˆì„  ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <div id="op-tourn-info" class="flex-[2] text-[10px] font-extrabold text-rose-700 bg-rose-50 p-2 rounded-xl text-center border border-rose-100 hidden"></div>
                </div>

                <div id="tourn-filter-container" class="flex flex-wrap gap-1.5 mb-3 hidden"></div>

                <div id="tourn-quick-nav" class="flex justify-between items-center gap-1.5 mb-2 sticky left-0 right-0 z-20 px-1 no-print hidden">
                    <button onclick="scrollTourn('left')" class="flex-1 py-2 bg-white text-slate-600 text-[11px] font-extrabold rounded-xl shadow-sm border border-slate-200 btn-press">ğŸ‘ˆ ì¢Œì¸¡</button>
                    <button onclick="scrollTourn('center')" class="flex-1 py-2 bg-yellow-50 text-yellow-700 text-[11px] font-extrabold rounded-xl shadow-sm border border-yellow-200 btn-press">ğŸ† ì¤‘ì•™</button>
                    <button onclick="scrollTourn('right')" class="flex-1 py-2 bg-white text-slate-600 text-[11px] font-extrabold rounded-xl shadow-sm border border-slate-200 btn-press">ìš°ì¸¡ ğŸ‘‰</button>
                    <button onclick="copyTournamentImage()" id="btn-capture-tourn" class="flex-1 py-2 bg-emerald-500 text-white text-[11px] font-black rounded-xl shadow-sm border border-emerald-600 btn-press flex items-center justify-center gap-1">ğŸ“¸ ì¹´í†¡ ë³µì‚¬</button>
                </div>

                <div id="op-tourn-container" class="w-full overflow-x-auto overflow-y-auto max-h-[75vh] pb-4 relative scroll-smooth rounded-xl border border-slate-200 bg-slate-50/50">
                    <div class="text-center text-slate-400 text-xs py-8">ì¡°ê±´ì„ ì„ íƒí•˜ê³  ëŒ€ì§„í‘œ ìƒì„±ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
                </div>
            </div>
        </div>

        <div id="view-history" class="hidden animate-fade-in">
            <div class="flex justify-between items-center mb-4 pl-1 gap-2">
                <h2 class="font-bold text-lg text-gray-800 tracking-tight">ì €ì¥ëœ ê²½ê¸° ê¸°ë¡</h2>
                <select id="history-season-selector" class="flex-1 max-w-[180px] text-[12px] font-extrabold text-indigo-800 bg-white border-2 border-indigo-100 rounded-xl px-2.5 py-1.5 shadow-sm focus:ring-2 focus:ring-indigo-400 outline-none truncate" onchange="renderHistory()">
                    <option value="current">ğŸ“ í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì‹œì¦Œ</option>
                </select>
            </div>
            <div class="shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 rounded-2xl bg-white overflow-hidden">
                <table class="w-full text-sm text-center text-slate-700">
                    <thead class="text-xs text-slate-500 uppercase bg-gray-50 border-b border-gray-200">
                        <tr><th class="px-2 py-3 w-20">ë‚ ì§œ/ì¢…ë¥˜</th><th class="px-2 py-3 text-left">ì°¸ì„ ë° ì…ìƒ ë‚´ì—­</th><th class="px-2 py-3 admin-only-table-cell w-16" id="history-admin-th">ê¸°ëŠ¥</th></tr>
                    </thead>
                    <tbody id="match-history-list" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
        
        <div id="view-input" class="hidden admin-only-block animate-fade-in">
            <div id="input-step-1" class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-4">
                <h2 id="input-form-title" class="font-extrabold text-xl mb-5 text-slate-800 tracking-tight">1. ëª¨ì„ ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>
                <div class="mb-5"><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ë‚ ì§œ ì„ íƒ</label><input type="date" id="match-date" class="block w-full border-0 bg-slate-100 p-3.5 rounded-xl font-medium text-slate-700 focus:ring-2 focus:ring-indigo-500 transition-all"></div>
                <div class="mb-8"><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ëª¨ì„ ì¢…ë¥˜</label><select id="match-type" class="block w-full border-0 bg-slate-100 p-3.5 rounded-xl font-medium text-slate-700 focus:ring-2 focus:ring-indigo-500 transition-all"><option>ì •ê¸°ëª¨ì„</option>
    <option>ì›”ë¡€ëŒ€íšŒ</option>
    <option>êµë¥˜ì „</option>
    <option>ê²°ì‚°ëª¨ì„</option>
    <option>ì†¡ë…„ëª¨ì„</option>
    <option>ì‹ ë…„ëª¨ì„</option>
    <option>í›ˆë ¨</option>
</select></select></div>
                <button onclick="openInputStep2()" class="w-full bg-gradient-to-r from-indigo-500 to-violet-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-xl transition-all btn-press text-lg">ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™ ğŸ‘‰</button>
            </div>
            
            <div id="input-step-2" class="hidden mt-2 bg-gray-50 p-4 rounded-xl border border-indigo-200 shadow-inner mb-6">
                <div class="flex justify-between items-center mb-4 pl-1"><h2 class="font-extrabold text-lg text-indigo-800">2. ìƒì„¸ ê²°ê³¼ ì„ íƒ</h2><span id="display-match-info" class="text-xs text-indigo-700 font-bold bg-indigo-100/50 px-3 py-1.5 rounded-full"></span></div>
                <div class="mb-5 bg-white p-4 border rounded-xl border-gray-200 shadow-sm relative">
                    <div class="flex justify-between items-center mb-2 border-b pb-2"><label class="block text-sm font-extrabold text-gray-800">âœ… ì˜¤ëŠ˜ ì°¸ì„ì</label><div class="flex gap-1"><button onclick="generateTeams()" class="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-200 font-bold hover:bg-indigo-100 btn-press">ğŸ¤– ì¡°í¸ì„±</button><button onclick="openSelector('attend', 'ì˜¤ëŠ˜ ì°¸ì„ì ì„ íƒ', false)" class="text-[10px] bg-blue-600 text-white px-2 py-1 rounded shadow-sm font-bold btn-press">ëª…ë‹¨ ì„ íƒ</button></div></div>
                    <div id="ui-box-attend" class="min-h-[40px] bg-gray-50 rounded-lg p-2 border border-gray-200 cursor-pointer" onclick="openSelector('attend', 'ì˜¤ëŠ˜ ì°¸ì„ì ì„ íƒ', false)"><span class="name-chip-empty">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì°¸ì„ìë¥¼ ì„ íƒí•˜ì„¸ìš”.</span></div>
                    <div class="flex justify-between items-center mt-4 mb-2 border-b pb-2"><label class="block text-sm font-extrabold text-red-600">ğŸš¨ ë¶ˆì„±ì‹¤ì (ì„±ì‹¤ì ìˆ˜ ì œì™¸)</label><button onclick="openSelector('lazy', 'ë¶ˆì„±ì‹¤ì ì„ íƒ', true)" class="text-[10px] bg-red-50 text-red-600 border border-red-200 px-2 py-1 rounded font-bold btn-press">ì„ íƒ</button></div>
                    <div id="ui-box-lazy" class="min-h-[30px] bg-red-50/50 rounded-lg p-2 border border-red-100 cursor-pointer" onclick="openSelector('lazy', 'ë¶ˆì„±ì‹¤ì ì„ íƒ', true)"><span class="name-chip-empty text-red-300">í•´ë‹¹ì ì—†ìŒ</span></div>
                </div>
                
<div class="space-y-4">
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">ğŸ…</span> ê°œì¸ ë¦¬ê·¸ì „</h3><div class="space-y-2.5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-lg1" onclick="openSelector('lg1', 'ë¦¬ê·¸ì „ 1ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-lg2" onclick="openSelector('lg2', 'ë¦¬ê·¸ì „ 2ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-lg3" onclick="openSelector('lg3', 'ë¦¬ê·¸ì „ 3ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div></div></div>
                    
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">ğŸ¤</span> ë‹¨ì²´ì „</h3><div class="space-y-2.5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-tm1" onclick="openSelector('tm1', 'ë‹¨ì²´ì „ 1ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-tm2" onclick="openSelector('tm2', 'ë‹¨ì²´ì „ 2ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-tm3" onclick="openSelector('tm3', 'ë‹¨ì²´ì „ 3ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div></div></div>
                    
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]">
                        <h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">âš”ï¸</span> ê¸°ë³¸ í† ë„ˆë¨¼íŠ¸</h3>
                        <div class="space-y-2.5">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-tn1" onclick="openSelector('tn1', 'ê¸°ë³¸ í† ë„ˆë¨¼íŠ¸ 1ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div>
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-tn2" onclick="openSelector('tn2', 'ê¸°ë³¸ í† ë„ˆë¨¼íŠ¸ 2ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div>
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-tn3" onclick="openSelector('tn3', 'ê¸°ë³¸ í† ë„ˆë¨¼íŠ¸ 3ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">âš”ï¸</span> ìƒìœ„ í† ë„ˆë¨¼íŠ¸</h3><div class="space-y-2.5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-utn1" onclick="openSelector('utn1', 'ìƒìœ„ í† ë„ˆë¨¼íŠ¸ 1ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-utn2" onclick="openSelector('utn2', 'ìƒìœ„ í† ë„ˆë¨¼íŠ¸ 2ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-utn3" onclick="openSelector('utn3', 'ìƒìœ„ í† ë„ˆë¨¼íŠ¸ 3ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div></div></div>

                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]">
                        <h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">âš”ï¸</span> í•˜ìœ„ í† ë„ˆë¨¼íŠ¸</h3>
                        <div class="space-y-2.5">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-ltn1" onclick="openSelector('ltn1', 'í•˜ìœ„ 1ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div>
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-ltn2" onclick="openSelector('ltn2', 'í•˜ìœ„ 2ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div>
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-ltn3" onclick="openSelector('ltn3', 'í•˜ìœ„ 3ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]">
                        <h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">ğŸ‘¥</span> ë³µì‹ì „</h3>
                        <div class="space-y-2.5">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-db1" onclick="openSelector('db1', 'ë³µì‹ 1ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div>
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-db2" onclick="openSelector('db2', 'ë³µì‹ 2ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div>
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-db3" onclick="openSelector('db3', 'ë³µì‹ 3ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-4 border rounded-2xl border-yellow-200/60 shadow-[0_4px_20px_rgba(250,204,21,0.15)]"><h3 class="font-extrabold text-sm text-yellow-800 mb-3 flex items-center gap-2"><span class="text-lg">ğŸ‰</span> ì´ë²¤íŠ¸ì „</h3><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-white flex justify-center items-center font-black text-yellow-600 shadow-sm">ğŸ‘‘</div><div id="ui-box-ev1" onclick="openSelector('ev1', 'ì´ë²¤íŠ¸ ìš°ìŠ¹ì ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-white rounded-xl bg-white/60 backdrop-blur-sm p-2 cursor-pointer flex items-center flex-wrap gap-1 shadow-sm hover:bg-white transition"></div></div></div>
                </div>
                
                <div class="flex gap-3 mt-8 sticky bottom-16 z-20 pb-2"><button onclick="cancelInputStep2()" class="flex-1 bg-white text-slate-700 py-4 rounded-2xl font-extrabold shadow-sm border border-slate-200 hover:bg-slate-50 btn-press">ì‘ì„± ì·¨ì†Œ</button><button onclick="saveMatch()" class="flex-[2] bg-gradient-to-r from-indigo-500 to-violet-500 text-white py-4 rounded-2xl font-extrabold shadow-lg shadow-indigo-200 btn-press text-lg border border-indigo-700">ìµœì¢… ì ìˆ˜ ì €ì¥</button></div>
            </div>
        </div>
        
        <div id="view-member" class="hidden p-4 admin-only-block animate-fade-in"><div class="bg-white border border-indigo-100 p-5 rounded-2xl mb-6 shadow-sm"><h3 class="font-extrabold text-indigo-800 mb-3 text-sm flex items-center gap-1.5"><span class="text-lg">ğŸ“Š</span> ì—‘ì…€ë¡œ ì¼ê´„ ë“±ë¡</h3><input type="file" id="excel-upload" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-5 file:rounded-xl file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition cursor-pointer mb-3" onchange="handleExcelUpload(event)"><button onclick="downloadExcelTemplate()" class="w-full bg-white border border-indigo-200 text-indigo-600 py-2.5 rounded-xl text-xs font-bold btn-press shadow-sm">ë“±ë¡ìš© ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button></div><div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6" id="member-form-container"><h2 id="form-title" class="font-extrabold text-xl mb-5 text-slate-800">ìƒˆ íšŒì› ê°œë³„ ë“±ë¡</h2><div class="mb-5 flex items-center gap-5 bg-slate-50 p-4 rounded-xl border border-slate-100"><div class="w-20 h-20 rounded-full overflow-hidden border-4 border-white shadow-md flex-shrink-0 bg-slate-200 relative"><img id="photo-preview" src="" class="w-full h-full object-cover hidden"><div id="photo-placeholder" class="w-full h-full flex flex-col items-center justify-center text-slate-400 text-xs font-bold"><span>ğŸ“·</span><span>ì‚¬ì§„</span></div></div><div class="flex-1"><input type="file" id="mem-photo" accept="image/*" class="w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition cursor-pointer" onchange="handlePhotoUpload(event)"></div></div><div class="grid grid-cols-2 gap-4 mb-6 text-sm">
            <div><label class="block font-bold text-slate-600 mb-1.5 text-xs">êµ¬ë¶„</label><select id="mem-affiliation" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition"><option value="ì‹œ">ì‹œ</option><option value="êµ¬">êµ¬</option><option value="ë ˆì „ë“œ">ë ˆì „ë“œ</option><option value="ì´ˆì²­">ì´ˆì²­</option></select></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">ë¶€ì„œ/ì†Œì†</label><input type="text" id="mem-dept" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="ì˜ˆ: ì²´ìœ¡ì§„í¥ê³¼"></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">ë“±ê¸‰</label><select id="mem-type" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition"><option value="ì—°íšŒì›" selected>ì—°íšŒì›</option><option value="ì¤€íšŒì›">ì¤€íšŒì›</option><option value="ë¹„íšŒì›">ë¹„íšŒì›</option></select></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">ì§ì±…</label><input type="text" id="mem-duty" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="ì˜ˆ: ì´ë¬´"></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">ì§ê¸‰</label><input type="text" id="mem-rank" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="ì˜ˆ: ì£¼ë¬´ê´€"></div><div><label class="block font-bold text-indigo-600 mb-1.5 text-xs">* ì´ë¦„ (í•„ìˆ˜)</label><input type="text" id="mem-name" class="w-full border border-indigo-200 bg-indigo-50/50 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition font-bold" placeholder="í™ê¸¸ë™"></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">* ë¶€ìˆ˜ (í•„ìˆ˜)</label><select id="mem-handicap" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 font-bold text-indigo-700"><option value="1">1ë¶€</option><option value="2">2ë¶€</option><option value="3">3ë¶€</option><option value="4">4ë¶€</option><option value="5" selected>5ë¶€</option><option value="6">6ë¶€</option><option value="7">7ë¶€</option><option value="8">8ë¶€</option><option value="9">9ë¶€</option><option value="10">10ë¶€</option></select></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">ì„±ë³„</label><select id="mem-gender" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition"><option value="ë‚¨">ë‚¨</option><option value="ì—¬">ì—¬</option></select></div><div class="col-span-2"><label class="block font-bold text-slate-600 mb-1.5 text-xs">ìƒíƒœ</label><select id="mem-status" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition font-bold"><option value="active" selected>ğŸŸ¢ ì •ìƒ í™œë™</option><option value="inactive">ğŸ”´ íœ´ë©´ (ìˆœìœ„/ëª…ë‹¨ì—ì„œ ìˆ¨ê¹€)</option></select></div><div class="col-span-2"><label class="block font-bold text-slate-800 mb-1"><span class="bg-yellow-100 px-1.5 rounded">ğŸ“ ì—°ë½ì²˜</span></label><input type="tel" id="mem-phone" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="010-0000-0000"></div></div><div class="flex gap-3"><button onclick="saveMember()" id="btn-save-member" class="flex-1 bg-slate-800 text-white py-4 rounded-xl font-extrabold shadow-md btn-press">íšŒì› ì €ì¥í•˜ê¸°</button><button onclick="cancelEdit()" id="btn-cancel-edit" class="hidden flex-1 bg-slate-200 text-slate-700 py-4 rounded-xl font-extrabold btn-press">ì·¨ì†Œ</button></div></div><div class="flex justify-between items-end mb-3 px-1"><h3 class="font-extrabold text-lg text-slate-800">ì „ì²´ íšŒì› ëª©ë¡</h3><span class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2.5 py-1 rounded-full border border-indigo-100" id="total-members-count">ì´ 0ëª…</span></div><ul id="member-list-display" class="text-sm divide-y divide-slate-100 bg-white border border-slate-100 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6 overflow-hidden"></ul></div>
        
        <div id="view-setting" class="hidden p-4 pb-20 admin-only-block animate-fade-in">
            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-2xl shadow-lg mb-6 text-white relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-8xl opacity-10">ğŸŒ±</div>
                <h2 class="font-extrabold text-xl mb-2 relative z-10">ìƒˆë¡œìš´ ì‹œì¦Œ ì‹œì‘</h2>
                <p class="text-[11px] text-emerald-50 mb-4 leading-relaxed relative z-10 font-medium">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë°ì´í„°ë¥¼ ì•„ë˜ ì´ë¦„ìœ¼ë¡œ <b>ë³´ê´€ì†Œì— ì €ì¥</b>í•˜ê³ , ì ìˆ˜ë¥¼ 0ì ìœ¼ë¡œ ë¦¬ì…‹í•˜ì—¬ ìƒˆ ê¸°ìˆ˜ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</p>
                <div class="mb-4 relative z-10">
                    <label class="block text-[11px] font-extrabold text-emerald-100 mb-1.5">ğŸ—„ï¸ ë³´ê´€í•  ì‹œì¦Œ ì´ë¦„ (ì˜ˆ: 25ë…„ ìƒë°˜ê¸° ë¦¬ê·¸)</label>
                    <input type="text" id="cfg-season-name" class="w-full border border-emerald-400 bg-white/20 text-white placeholder-emerald-100/60 p-3 rounded-xl text-sm focus:ring-2 focus:ring-white transition font-bold outline-none" placeholder="ì‹œì¦Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button onclick="startNewSeason()" class="w-full bg-white text-emerald-700 py-3.5 rounded-xl font-extrabold shadow-md btn-press relative z-10">ë³´ê´€í•˜ê³  ìƒˆ ì‹œì¦Œ ì‹œì‘í•˜ê¸°</button>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6">
    <h2 class="font-extrabold text-lg text-slate-800 mb-4 flex items-center gap-2"><span>ğŸ—„ï¸</span> ë³´ê´€ëœ ê³¼ê±° ì‹œì¦Œ ê´€ë¦¬</h2>
    <div id="past-season-list" class="space-y-2">
        </div>
</div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6">
                <h2 class="font-extrabold text-lg text-slate-800 mb-5 flex items-center gap-2"><span>ğŸ”¢</span> íšë“ ì ìˆ˜ ë£° ì„¤ì •</h2>
                <div class="space-y-5 text-sm">
                    <div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-xl"><div><label class="block font-bold text-slate-500 mb-1.5 text-xs text-center">ê¸°ë³¸ ì°¸ì„</label><input type="number" id="cfg-score-attend" step="0.5" class="w-full border-0 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 text-center font-extrabold text-slate-700 shadow-sm"></div><div><label class="block font-bold text-slate-500 mb-1.5 text-xs text-center">ì„±ì‹¤ ì ìˆ˜</label><input type="number" id="cfg-score-sincerity" step="0.5" class="w-full border-0 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 text-center font-extrabold text-slate-700 shadow-sm"></div></div>
                    <div><div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">ğŸ… ê°œì¸ ë¦¬ê·¸ì „ ì…ìƒ</div><div class="grid grid-cols-3 gap-3"><div><input type="number" id="cfg-score-lg1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">1ë“±</div></div><div><input type="number" id="cfg-score-lg2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">2ë“±</div></div><div><input type="number" id="cfg-score-lg3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">3ë“±</div></div></div></div>
                    <div>
                        <div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">ğŸ¤ ë‹¨ì²´ì „ ì…ìƒ</div>
                        <div class="grid grid-cols-3 gap-3">
                            <div><input type="number" id="cfg-score-tm1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">1ìœ„</div></div>
                            <div><input type="number" id="cfg-score-tm2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">2ìœ„</div></div>
                            <div><input type="number" id="cfg-score-tm3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">3ìœ„</div></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">âš”ï¸ ê¸°ë³¸ í† ë„ˆë¨¼íŠ¸ ì…ìƒ</div>
                        <div class="grid grid-cols-3 gap-3">
                            <div><input type="number" id="cfg-score-tn1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">1ìœ„</div></div>
                            <div><input type="number" id="cfg-score-tn2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">2ìœ„</div></div>
                            <div><input type="number" id="cfg-score-tn3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">3ìœ„</div></div>
                        </div>
                    </div>

                    <div>
                        <div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">ğŸ† ìƒìœ„ í† ë„ˆë¨¼íŠ¸ ì…ìƒ</div>
                        <div class="grid grid-cols-3 gap-3">
                            <div><input type="number" id="cfg-score-utn1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">1ìœ„</div></div>
                            <div><input type="number" id="cfg-score-utn2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">2ìœ„</div></div>
                            <div><input type="number" id="cfg-score-utn3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">3ìœ„</div></div>
                        </div>
                    </div>

                    <div>
                        <div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">ğŸ† í•˜ìœ„ í† ë„ˆë¨¼íŠ¸ ì…ìƒ</div>
                        <div class="grid grid-cols-3 gap-3">
                            <div><input type="number" id="cfg-score-ltn1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">1ìœ„</div></div>
                            <div><input type="number" id="cfg-score-ltn2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">2ìœ„</div></div>
                            <div><input type="number" id="cfg-score-ltn3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">3ìœ„</div></div>
                        </div>
                    </div>
                    <div>
                        <div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">ğŸ‘¥ ë³µì‹ì „ ì…ìƒ</div>
                        <div class="grid grid-cols-3 gap-3">
                            <div><input type="number" id="cfg-score-db1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">1ë“±</div></div>
                            <div><input type="number" id="cfg-score-db2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">2ë“±</div></div>
                            <div><input type="number" id="cfg-score-db3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">3ë“±</div></div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="font-extrabold text-yellow-600 mb-2 text-xs border-b border-yellow-200 pb-1">ğŸ‰ ì´ë²¤íŠ¸ ìš°ìŠ¹</div>
                        <input type="number" id="cfg-score-ev1" step="0.5" class="w-full border border-yellow-200 p-2 rounded-lg text-center font-bold text-yellow-600 bg-yellow-50">
                    </div>
                    
                    <button onclick="saveScoreRules()" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold shadow-md mt-4 btn-press">ë£° ì €ì¥ ë° ì¦‰ì‹œ ì¬ê³„ì‚°</button>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6"><h2 class="font-extrabold text-lg text-slate-800 mb-4 flex items-center gap-2"><span>ğŸ’¬</span> ì¹´í†¡ ê³µì§€ í…œí”Œë¦¿</h2><div class="mb-4"><label class="block text-xs font-bold text-slate-500 mb-1.5">ë¨¸ë¦¿ë§ (ì‹œì‘ ë¬¸êµ¬)</label><textarea id="cfg-announce-prefix" rows="2" class="w-full border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition"></textarea></div><div class="mb-5"><label class="block text-xs font-bold text-slate-500 mb-1.5">ê¼¬ë¦¿ë§ (ì•ˆë‚´/ê³„ì¢Œ ë¬¸êµ¬)</label><textarea id="cfg-announce-suffix" rows="3" class="w-full border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition"></textarea></div><div class="mb-5"><label class="block text-xs font-bold text-slate-500 mb-1.5">ì•± ì ‘ì† ì‹œ ê¸°ë³¸ í™”ë©´</label><select id="cfg-default-tab" class="w-full border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition"><option value="ranking">ğŸ† ì „ì²´ ìˆœìœ„ í™”ë©´</option><option value="history">ğŸ“… ê²½ê¸° ê¸°ë¡ í™”ë©´</option></select></div><button onclick="saveUIConfig()" class="w-full bg-slate-200 text-slate-700 py-3 rounded-xl font-bold btn-press">í™˜ê²½ ì„¤ì • ì €ì¥</button></div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6"><h2 class="font-extrabold text-lg text-slate-800 mb-4 flex items-center gap-2"><span>ğŸ’¾</span> ë°ì´í„° ë°±ì—… ë° ë³µì›</h2><p class="text-xs text-slate-500 mb-4 leading-relaxed">ì¸í„°ë„· ë¶ˆì•ˆì •ìœ¼ë¡œ ì €ì¥ì´ ì•ˆ ë  ë•Œë¥¼ ëŒ€ë¹„í•´ ë°ì´í„°ë¥¼ ê¸°ê¸°ì— íŒŒì¼ë¡œ ì €ì¥í•˜ê³  ì–¸ì œë“  ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><div class="flex gap-3"><button onclick="exportData()" class="flex-1 bg-indigo-50 text-indigo-700 py-3 rounded-xl font-bold border border-indigo-200 hover:bg-indigo-100 btn-press">ğŸ“¥ ë°±ì—… ì €ì¥</button><div class="flex-1 relative"><input type="file" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importData(event)"><div class="bg-emerald-50 text-emerald-700 py-3 rounded-xl font-bold border border-emerald-200 hover:bg-emerald-100 btn-press text-center flex items-center justify-center h-full">ğŸ“¤ ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</div></div></div></div>
            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-4"><h2 class="font-extrabold text-lg text-slate-800 mb-4 flex items-center gap-2"><span>ğŸ”‘</span> ë³´ì•ˆ ì„¤ì •</h2><label class="block text-xs font-bold text-slate-500 mb-1.5">ìƒˆë¡œìš´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</label><div class="flex gap-2 mb-3"><input type="password" id="cfg-password" class="flex-1 border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-500 transition" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"><button onclick="changePassword()" class="bg-red-500 text-white px-5 rounded-xl font-bold shadow-md btn-press">ë³€ê²½</button></div></div>
            <div class="bg-rose-50 p-5 rounded-2xl border border-rose-200 shadow-sm mt-8"><h2 class="font-extrabold text-lg text-rose-800 mb-2 flex items-center gap-2"><span>âš ï¸</span> íšŒì› ëª…ë‹¨ ì „ì²´ ì´ˆê¸°í™”</h2><p class="text-xs text-rose-600 mb-4 leading-relaxed font-medium">ë“±ë¡ëœ ëª¨ë“  íšŒì› ëª…ë‹¨ì„ ì™„ì „íˆ ì‚­ì œí•©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><button onclick="resetAllMembers()" class="w-full bg-rose-600 text-white py-3.5 rounded-xl font-bold shadow-md btn-press">íšŒì› ì „ì²´ ì‚­ì œí•˜ê¸°</button></div>
        </div>
    </div>

    <div id="print-option-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex justify-center items-center p-4 animate-fade-in" onclick="if(event.target === this) closePrintModal()">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl flex flex-col overflow-hidden"><div class="px-5 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><h3 class="font-extrabold text-lg text-slate-800" id="print-modal-title">ğŸ–¨ï¸ ì¸ì‡„ ì˜µì…˜</h3><button onclick="closePrintModal()" class="text-slate-400 hover:text-slate-600 text-2xl font-bold btn-press">&times;</button></div><div class="p-5 flex flex-col gap-3"><button onclick="executePrint('table')" class="w-full bg-indigo-50 text-indigo-700 py-3.5 rounded-xl font-extrabold border border-indigo-200 hover:bg-indigo-100 transition btn-press">ğŸ“Š ëŒ€ì§„í‘œë§Œ ì¸ì‡„</button><button onclick="executePrint('order')" class="w-full bg-emerald-50 text-emerald-700 py-3.5 rounded-xl font-extrabold border border-emerald-200 hover:bg-emerald-100 transition btn-press">ğŸ”„ ê²Œì„ìˆœì„œë§Œ ì¸ì‡„</button><button onclick="executePrint('both')" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-extrabold shadow-md hover:bg-slate-700 transition btn-press">ì „ì²´(ëŒ€ì§„í‘œ+ê²Œì„ìˆœì„œ) í•¨ê»˜ ì¸ì‡„</button></div></div>
    </div>

    <div id="announcement-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex justify-center items-center p-4 animate-fade-in" onclick="if(event.target === this) closeAnnouncement()">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl flex flex-col overflow-hidden"><div class="px-5 py-4 flex justify-between items-center border-b border-slate-100 bg-indigo-50"><h3 class="font-extrabold text-lg text-indigo-800">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ê³µì§€ ë³µì‚¬</h3><button onclick="closeAnnouncement()" class="text-slate-400 hover:text-slate-600 text-2xl font-bold btn-press">&times;</button></div><div class="p-4 bg-slate-50 flex-1"><textarea id="announcement-text" class="w-full h-[40vh] p-3 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 resize-none bg-white font-medium" readonly></textarea><p class="text-[11px] text-slate-500 mt-2 text-center">ë¨¸ë¦¿ë§/ê¼¬ë¦¿ë§ì€ [ì„¤ì •] íƒ­ì—ì„œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div><div class="p-4 border-t border-slate-100 bg-white"><button onclick="copyAnnouncement()" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-extrabold shadow-lg shadow-indigo-200 hover:bg-indigo-700 btn-press text-lg">ì¹´í†¡ì— ë§ê²Œ ë³µì‚¬í•˜ê¸°</button></div></div>
    </div>
    
    <div id="team-maker-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex justify-center items-end sm:items-center p-0 sm:p-4 animate-fade-in" onclick="if(event.target === this) closeTeamMaker()">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col max-h-[85vh]"><div class="sheet-handle sm:hidden"></div><div class="px-5 py-3 flex justify-between items-center shrink-0 border-b border-slate-100"><h3 class="font-extrabold text-lg text-slate-800">ğŸ¤– ë°¸ëŸ°ìŠ¤ ì¡° í¸ì„± ê²°ê³¼</h3><button onclick="closeTeamMaker()" class="text-slate-400 hover:text-slate-600 text-2xl font-bold">&times;</button></div><div class="p-5 flex-1 overflow-y-auto bg-slate-50/50"><div id="team-result-box" class="space-y-2 text-sm min-h-[150px]"></div></div><div class="p-4 shrink-0 border-t border-slate-100 bg-white flex gap-3 pb-8 sm:pb-4"><button onclick="generateTeams()" class="flex-1 bg-slate-100 text-slate-700 py-3.5 rounded-xl font-bold hover:bg-slate-200 btn-press">ë‹¤ì‹œ ì„ê¸°</button><button onclick="copyTeams()" class="flex-[2] bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 btn-press text-lg">ê²°ê³¼ ë³µì‚¬í•˜ê¸°</button></div></div>
    </div>
    
    <div id="member-selector-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex justify-end flex-col animate-fade-in" onclick="if(event.target === this) closeSelector()">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-3xl shadow-2xl flex flex-col max-h-[85vh]"><div class="sheet-handle"></div><div class="px-5 pb-3 pt-1 border-b border-slate-100 flex justify-between items-center"><h3 class="font-extrabold text-xl text-slate-800" id="selector-title">ëª…ë‹¨ ì„ íƒ</h3><span id="selector-count" class="text-xs font-extrabold bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-full shadow-inner">0ëª… ì„ íƒë¨</span></div><div class="px-4 py-2 bg-slate-50 border-b border-slate-200"><input type="text" id="selector-search" placeholder="ğŸ” ì´ë¦„ ê²€ìƒ‰ (í„°ì¹˜í•˜ì—¬ ì…ë ¥)" class="w-full bg-white border border-slate-200 p-2.5 rounded-xl text-sm outline-none font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 shadow-sm" oninput="filterSelector(this.value)"></div><div class="p-4 flex-1 overflow-y-auto bg-slate-50/50"><p id="selector-empty-msg" class="hidden text-sm text-slate-400 text-center py-10 font-medium">ì„ íƒ ê°€ëŠ¥í•œ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p><div id="selector-list" class="grid grid-cols-3 gap-2.5"></div></div><div class="p-4 border-t border-slate-100 bg-white flex gap-3 pb-6"><button onclick="closeSelector()" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-xl font-bold btn-press">ì·¨ì†Œ</button><button onclick="confirmSelector()" id="btn-selector-confirm" class="flex-[2] bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 btn-press text-lg">ì„ íƒ ì™„ë£Œ</button></div></div>
    </div>

    <div id="winner-selector-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex justify-center items-center p-4 animate-fade-in" onclick="if(event.target === this) closeWinnerSelector()">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="px-5 py-4 border-b border-slate-100 bg-indigo-50 flex justify-between items-center">
                <h3 class="font-extrabold text-lg text-indigo-800">âš”ï¸ ìŠ¹ì ì„ íƒ</h3>
                <button onclick="closeWinnerSelector()" class="text-slate-400 hover:text-slate-600 text-2xl font-bold btn-press">&times;</button>
            </div>
            <div class="p-6 bg-slate-50">
                <p class="text-center text-xs text-slate-500 mb-4 font-medium">ë‹¤ìŒ ë¼ìš´ë“œë¡œ ì§„ì¶œí•  ìŠ¹ìë¥¼ í„°ì¹˜í•˜ì„¸ìš”.</p>
                <div class="flex flex-col gap-3">
                    <button id="btn-winner-p1" class="w-full bg-white text-indigo-700 py-4 rounded-xl font-black text-lg border-2 border-indigo-200 hover:bg-indigo-600 hover:text-white hover:border-indigo-600 transition-colors shadow-sm btn-press"></button>
                    <div class="text-center text-slate-300 font-extrabold italic">VS</div>
                    <button id="btn-winner-p2" class="w-full bg-white text-rose-700 py-4 rounded-xl font-black text-lg border-2 border-rose-200 hover:bg-rose-600 hover:text-white hover:border-rose-600 transition-colors shadow-sm btn-press"></button>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 w-full border-t border-slate-200/50 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.08)] glass-panel z-50 px-3 py-2 pb-5 flex justify-between items-center text-[10px] text-slate-400 font-medium no-print transition-all duration-300 max-w-md mx-auto left-0 right-0" id="bottom-tab-bar">
        <button onclick="switchTab('ranking')" id="btn-ranking" class="tab-item flex-1 flex flex-col items-center justify-center py-2 relative tab-active btn-press"><span class="tab-icon">ğŸ†</span><span class="mt-1">ìˆœìœ„</span></button>
        <button onclick="switchTab('history')" id="btn-history" class="tab-item flex-1 flex flex-col items-center justify-center py-2 relative btn-press"><span class="tab-icon">ğŸ“…</span><span class="mt-1">ê¸°ë¡</span></button>
        <button onclick="switchTab('operation')" id="btn-operation" class="tab-item flex-1 flex flex-col items-center justify-center py-2 relative admin-only btn-press"><span class="tab-icon">ğŸ®</span><span class="mt-1">ìš´ì˜</span></button>
        <button onclick="switchTab('input')" id="btn-input" class="tab-item flex-1 flex-col items-center justify-center py-2 relative admin-only btn-press"><span class="tab-icon">ğŸ“</span><span class="mt-1">ì…ë ¥</span></button>
        <button onclick="switchTab('member')" id="btn-member" class="tab-item flex-1 flex-col items-center justify-center py-2 relative admin-only btn-press"><span class="tab-icon">ğŸ‘¥</span><span class="mt-1">íšŒì›</span></button>
        <button onclick="switchTab('setting')" id="btn-setting" class="tab-item flex-1 flex-col items-center justify-center py-2 relative admin-only btn-press"><span class="tab-icon">âš™ï¸</span><span class="mt-1">ì„¤ì •</span></button>
    </div>

    <script>
        // -------------------------------------------------------------
        // ğŸ”´ Firebase ì—°ê²° ì„¤ì •
        // -------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyC1t-mJJXV6GBZ7-kWcvpRd35vpPZU0wmA",
            authDomain: "table-tennis-6334b.firebaseapp.com",
            projectId: "table-tennis-6334b",
            storageBucket: "table-tennis-6334b.firebasestorage.app",
            messagingSenderId: "967760713131",
            appId: "1:967760713131:web:17288e738222768aa1aeee",
            measurementId: "G-V3FBQ4FZB7"
        };
        
        let db; let isFirebaseActive = false;
        try { if(firebaseConfig.apiKey && firebaseConfig.apiKey !== "ë³¸ì¸ì˜ ì‹¤ì œ APIí‚¤ê°’") { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); isFirebaseActive = true; } } catch(e) { console.error("Firebase ì—°ê²° ì•ˆë¨:", e); }

        function escapeHTML(str) {
            if(typeof str !== 'string') return str;
            return str.replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag] || tag));
        }

        const ROUND_ROBIN_ORDERS = {
            2: [[1,2]], 3: [[2,3], [1,3], [1,2]], 4: [[1,4], [2,3], [1,3], [4,2], [1,2], [3,4]], 
            5: [[2,5], [3,4], [1,5], [2,3], [1,4], [5,3], [1,3], [4,2], [1,2], [4,5]], 
            6: [[1,6], [2,5], [3,4], [1,5], [6,4], [2,3], [1,4], [5,3], [6,2], [1,3], [4,2], [5,6], [1,2], [3,6], [4,5]], 
            7: [[2,7], [3,6], [4,5], [1,7], [2,5], [3,4], [1,6], [2,3], [5,7], [1,5], [3,7], [4,6], [1,4], [2,6], [3,5], [1,3], [2,4], [6,7], [1,2], [4,7], [5,6]], 
            8: [[1,8], [2,7], [3,6], [4,5], [1,7], [2,5], [3,4], [6,8], [1,6], [2,3], [4,8], [5,7], [1,5], [2,8], [3,7], [4,6], [1,4], [2,6], [3,5], [7,8], [1,3], [2,4], [5,8], [6,7], [1,2], [3,8], [4,7], [5,6]], 
            9: [[2,9], [3,8], [4,7], [5,6], [1,9], [2,7], [3,6], [4,5], [1,8], [2,5], [3,4], [7,9], [1,7], [2,3], [5,9], [6,8], [1,6], [3,9], [4,8], [5,7], [1,5], [2,8], [3,7], [4,6], [1,4], [2,6], [3,5], [8,9], [1,3], [2,4], [6,9], [7,8], [1,2], [4,9], [5,8], [6,7]], 
            10: [[1,10], [2,9], [3,8], [4,7], [5,6], [1,9], [2,7], [3,6], [4,5], [8,10], [1,8], [2,5], [3,4], [6,10], [7,9], [1,7], [2,3], [4,10], [5,9], [6,8], [1,6], [2,10], [3,9], [4,8], [5,7], [1,5], [2,8], [3,7], [4,6], [9,10], [1,4], [2,6], [3,5], [7,10], [8,9], [1,3], [2,4], [5,10], [6,9], [7,8], [1,2], [3,10], [4,9], [5,8], [6,7]], 
            11: [[2,11], [3,10], [4,9], [5,8], [6,7], [1,11], [2,9], [3,8], [4,7], [5,6], [1,10], [2,7], [3,6], [4,5], [9,11], [1,9], [2,5], [3,4], [7,11], [8,10], [1,8], [2,3], [5,11], [6,10], [7,9], [1,7], [3,11], [4,10], [5,9], [6,8], [1,6], [2,10], [3,9], [4,8], [5,7], [1,5], [2,8], [3,7], [4,6], [10,11], [1,4], [2,6], [3,5], [8,11], [9,10], [1,3], [2,4], [6,11], [7,10], [8,9], [1,2], [4,11], [5,10], [6,9], [7,8]], 
            12: [[1,12], [2,11], [3,10], [4,9], [5,8], [6,7], [1,11], [2,9], [3,8], [4,7], [5,6], [10,12], [1,10], [2,7], [3,6], [4,5], [8,12], [9,11], [1,9], [2,5], [3,4], [6,12], [7,11], [8,10], [1,8], [2,3], [4,12], [5,11], [6,10], [7,9], [1,7], [2,12], [3,11], [4,10], [5,9], [6,8], [1,6], [2,10], [3,9], [4,8], [5,7], [11,12], [1,5], [2,8], [3,7], [4,6], [9,12], [10,11], [1,4], [2,6], [3,5], [7,12], [8,11], [9,10], [1,3], [2,4], [5,12], [6,11], [7,10], [8,9], [1,2], [3,12], [4,11], [5,10], [6,9], [7,8]]
        };
        function getRoundRobinPairs(n) { return ROUND_ROBIN_ORDERS[n] || []; }

        let isAdmin = false; let editingMatchId = null; let editingMemberId = null; let currentPhotoBase64 = "";
        let defaultAppConfig = { password: "0000", defaultTab: "ranking", announcePrefix: "ğŸ“ [ {date} {type} ê²°ê³¼ ]\n\n", announceSuffix: "\nëª¨ë‘ ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ë‹¤ìŒ ëª¨ì„ì—ì„œ ëµ™ê² ìŠµë‹ˆë‹¤. ğŸ‘", pastSeasons: [] };
        // ìˆ˜ì •ë¨: db3 ë³€ìˆ˜ ì¶”ê°€


        let defaultScoreRules = { attend: 3.0, sincerity: 0.5, lg1: 2.5, lg2: 2.0, lg3: 1.5, tm1: 2.5, tm2: 2.0, tm3: 1.5, tn1: 2.5, tn2: 2.0, tn3: 1.5, utn1: 2.5, utn2: 2.0, utn3: 1.5, ltn1: 2.5, ltn2: 2.0, ltn3: 1.5, db1: 2.0, db2: 1.5, db3: 1.0, ev1: 2.0 };
        let appConfig = {...defaultAppConfig}; let scoreRules = {...defaultScoreRules}; let members = []; let matchHistory = []; let nextMemberId = 1; let nextMatchId = 1; 
        
        let formState = { attend: [], lazy: [], lg1: [], lg2: [], lg3: [], tm1: [], tm2: [], tm3: [], tn1: [], tn2: [], tn3: [], utn1: [], utn2: [], utn3: [], ltn1: [], ltn2: [], ltn3: [], db1: [], db2: [], db3: [], ev1: [], opAttend: [] };
        let currentSelectorTarget = ''; let tempSelectorList = []; let isSinglePickMode = false;
        window.leaguePlayers = {}; 

        let isPcMode = sessionStorage.getItem('isPcMode') === 'true';
        function applyViewMode() {
            const body = document.getElementById('app-body'); const tabbar = document.getElementById('bottom-tab-bar');
            if(isPcMode) { body.classList.remove('max-w-md'); body.classList.add('max-w-[1200px]'); tabbar.classList.remove('max-w-md'); tabbar.classList.add('max-w-[1200px]'); document.getElementById('btn-view-toggle').innerText = "ğŸ“±"; } 
            else { body.classList.add('max-w-md'); body.classList.remove('max-w-[1200px]'); tabbar.classList.add('max-w-md'); tabbar.classList.remove('max-w-[1200px]'); document.getElementById('btn-view-toggle').innerText = "ğŸ’»"; }
        }
        function toggleViewMode() { isPcMode = !isPcMode; sessionStorage.setItem('isPcMode', isPcMode); applyViewMode(); }
        function restoreAdminState() { if (sessionStorage.getItem('isAdminLoggedIn') === 'true') { isAdmin = true; document.getElementById('app-body').classList.add('admin-mode-active'); document.getElementById('btn-admin-lock').innerText = "ğŸ”“"; } applyViewMode(); }
        restoreAdminState();

// 1. ë°ì´í„° ë¡œë”© ì‹œ ëˆ„ë½ëœ ì„¤ì •ê°’ ìë™ ë³µêµ¬ (Migration ë¡œì§) ë° íˆìŠ¤í† ë¦¬ ì•ˆì „ì„± ë³´ì¥
function applyParsedData(parsed) {
            members = parsed.members || []; 
            matchHistory = (parsed.matchHistory || []).map(m => ({...m, attend: m.attend||[], lazy: m.lazy||[], lg1: m.lg1||[], lg2: m.lg2||[], lg3: m.lg3||[], tm1: m.tm1||[], tm2: m.tm2||[], tm3: m.tm3||[], tn1: m.tn1||[], tn2: m.tn2||[], tn3: m.tn3||[], utn1: m.utn1||[], utn2: m.utn2||[], utn3: m.utn3||[], ltn1: m.ltn1||[], ltn2: m.ltn2||[], ltn3: m.ltn3||[], db1: m.db1||[], db2: m.db2||[], db3: m.db3||[], ev1: m.ev1||[] }));
            appConfig = parsed.appConfig || {...defaultAppConfig}; 
            if (!appConfig.pastSeasons) appConfig.pastSeasons = []; 
            
            scoreRules = { ...defaultScoreRules, ...(parsed.scoreRules || {}) };
            scoreRules.db3 = scoreRules.db3 ?? 1.0; 
            scoreRules.utn1 = scoreRules.utn1 ?? 2.5; scoreRules.utn2 = scoreRules.utn2 ?? 2.0; scoreRules.utn3 = scoreRules.utn3 ?? 1.5;
            scoreRules.ltn1 = scoreRules.ltn1 ?? 2.5; scoreRules.ltn2 = scoreRules.ltn2 ?? 2.0; scoreRules.ltn3 = scoreRules.ltn3 ?? 1.5;

            nextMemberId = parsed.nextMemberId || 1; nextMatchId = parsed.nextMatchId || 1;
            renderAll(); switchTab(appConfig.defaultTab); if (isAdmin) loadSettingsUI();
        }
        function loadLocalFallback() { try { const localData = localStorage.getItem('pingpongLocalData'); if(localData) { applyParsedData(JSON.parse(localData)); } else { injectSampleData(); } } catch(e) { injectSampleData(); } }
        function loadDataFromStorage() { if(isFirebaseActive && db) { db.collection("tableTennis").doc("leagueData").get().then((doc) => { if (doc.exists) applyParsedData(doc.data()); else loadLocalFallback(); }).catch((error) => { loadLocalFallback(); }); } else { loadLocalFallback(); } }
        function saveDataToStorage() { 
            try { localStorage.setItem('pingpongLocalData', JSON.stringify({ members, matchHistory, appConfig, scoreRules, nextMemberId, nextMatchId })); } catch(e) {}
            if(isFirebaseActive && db) { db.collection("tableTennis").doc("leagueData").set({ members, matchHistory, appConfig, scoreRules, nextMemberId, nextMatchId }).catch((error) => { console.error("FB ì €ì¥ ì˜¤ë¥˜"); }); }
        }
        function injectSampleData() { members = [{ id: 1, name: "ë°•ì„ í–‰", handicap: 5, score: 0, prevRank: 1, status: "active", type: "ì—°íšŒì›", affiliation: "ì‹œ", dept: "í˜ì‹ ì„±ì¥ë„ì‹œê³¼", rank: "ì£¼ë¬´ê´€", phone: "" }]; saveDataToStorage(); renderAll(); switchTab(appConfig.defaultTab); }
        document.getElementById('match-date').value = new Date().toISOString().substring(0, 10);
        
        function exportData() { try { const dataStr = JSON.stringify({ members, matchHistory, appConfig, scoreRules, nextMemberId, nextMatchId }, null, 2); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([dataStr], {type: "application/json"})); a.download = `íƒêµ¬ë¦¬ê·¸_ë°±ì—…_${new Date().toISOString().substring(0,10)}.json`; a.click(); } catch(e) { alert("ë°±ì—… ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"); } }
        function importData(event) { const file = event.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); applyParsedData(data); saveDataToStorage(); alert("ë°ì´í„° ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"); } catch(err) { alert("ì˜ëª»ëœ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤."); } event.target.value = ""; }; reader.readAsText(file); }
        
        function resetAllMembers() {
            if(confirm("âš ï¸ ê²½ê³ : ë“±ë¡ëœ ëª¨ë“  íšŒì› ëª…ë‹¨ì´ ì‚­ì œë©ë‹ˆë‹¤.\n\nê¸°ì¡´ ê²½ê¸° ê¸°ë¡ì— ìˆëŠ” ì´ë¦„ì€ ìœ ì§€ë˜ì§€ë§Œ, íšŒì› ì •ë³´(ë¶€ìˆ˜, ì—°ë½ì²˜ ë“±)ëŠ” ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.\n\nì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const check = prompt("ì§„í–‰ì„ ì›í•˜ì‹œë©´ 'ì´ˆê¸°í™”' ë¼ê³  ì…ë ¥í•´ì£¼ì„¸ìš”.");
                if(check === "ì´ˆê¸°í™”") { members = []; nextMemberId = 1; renderAll(); saveDataToStorage(); alert("ëª¨ë“  íšŒì› ëª…ë‹¨ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); switchTab('member'); } else { alert("ì´ˆê¸°í™”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); }
            }
        }

        function toggleAdmin() {
            if (isAdmin) { isAdmin = false; sessionStorage.removeItem('isAdminLoggedIn'); document.getElementById('app-body').classList.remove('admin-mode-active'); document.getElementById('btn-admin-lock').innerText = "ğŸ”’"; if(!['ranking', 'history'].includes(getCurrentTab())) switchTab('ranking'); } 
            else { const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n(ê¸°ë³¸: 0000)"); if (pw === appConfig.password) { isAdmin = true; sessionStorage.setItem('isAdminLoggedIn', 'true'); document.getElementById('app-body').classList.add('admin-mode-active'); document.getElementById('btn-admin-lock').innerText = "ğŸ”“"; loadSettingsUI(); } else if (pw !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
            renderAll(); 
        }
        function getCurrentTab() { return ['ranking', 'input', 'history', 'member', 'setting', 'operation'].find(t => document.getElementById(`btn-${t}`).classList.contains('tab-active')); }
        function switchTab(tabName) {
            ['ranking', 'input', 'history', 'member', 'setting', 'operation'].forEach(name => {
                document.getElementById(`view-${name}`).classList.add('hidden'); document.getElementById(`btn-${name}`).classList.remove('tab-active');
                if(name === tabName) { document.getElementById(`view-${name}`).classList.remove('hidden'); document.getElementById(`btn-${name}`).classList.add('tab-active'); }
            });
            if(tabName === 'input' && !editingMatchId) cancelInputStep2(); if(tabName === 'member' && editingMemberId) cancelEdit(); window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==============================================================================
        // ğŸ® ê²½ê¸° ìš´ì˜ - ë¦¬ê·¸ì „í‘œ ìƒì„± ë° ê³„ì‚° 
        // ==============================================================================
        function generateGroupSizeInputs() {
            const count = parseInt(document.getElementById('op-group-count').value) || 2;
            const container = document.getElementById('dynamic-group-sizes');
            let html = '';
            
            let attendeesCount = (formState.opAttend && formState.opAttend.length) ? formState.opAttend.length : 0;
            let baseSize = attendeesCount > 0 ? Math.floor(attendeesCount / count) : 4; 
            let remainder = attendeesCount > 0 ? attendeesCount % count : 0;

            for(let i=1; i<=count; i++) {
                let calculatedSize = baseSize + (i <= remainder ? 1 : 0);
                let val = attendeesCount > 0 ? calculatedSize : 4;

                html += `<div class="flex items-center gap-1 bg-white border border-slate-200 rounded px-1.5 py-1">
                    <span class="text-[10px] font-bold text-slate-500">${i}ì¡°</span>
                    <input type="number" id="op-group-size-${i}" value="${val}" min="2" max="12" class="w-10 text-[11px] font-bold text-indigo-700 text-center outline-none bg-transparent">
                    <span class="text-[10px] text-slate-400">ëª…</span>
                </div>`;
            }
            container.innerHTML = html;
        }

        function renderGroupTable(preserveData = false) {
            const count = parseInt(document.getElementById('op-group-count').value); 
            if (!preserveData) window.leaguePlayers = {}; 
            let html = `<div class="flex flex-wrap gap-6 justify-center w-full">`; 

            for(let g=1; g<=count; g++) {
                let sizeInput = document.getElementById(`op-group-size-${g}`);
                let currentSize = sizeInput ? parseInt(sizeInput.value) : 4;
                if(isNaN(currentSize) || currentSize < 2) currentSize = 2;

                html += `<div class="border-2 border-slate-800/80 rounded-xl overflow-hidden bg-white flex-1 min-w-[320px] max-w-full shadow-sm">
                    <div class="bg-slate-100 p-2 flex justify-end items-center gap-1.5 border-b border-slate-200">
                        <span class="text-xs font-bold text-slate-500 mr-auto ml-1">${g}ì¡° ê´€ë¦¬</span>
                        <button onclick="copyGroupTableImage(${g})" id="btn-copy-g${g}" class="text-[10px] bg-emerald-500 hover:bg-emerald-400 text-white px-2 py-1 rounded font-bold transition-colors btn-press no-print shadow-sm flex items-center">ğŸ“¸ ì¹´í†¡ ë³µì‚¬</button>
                        <button onclick="openPrintModal(${g})" class="text-[10px] bg-indigo-500 hover:bg-indigo-400 text-white px-2 py-1 rounded font-bold transition-colors btn-press no-print shadow-sm">ğŸ–¨ï¸ ì¡°ë³„ ì¸ì‡„</button>
                    </div>
                    <div id="table-container-g${g}" class="bg-white relative">
                        <div class="bg-slate-800 p-2.5 text-white flex items-center justify-between">
                            <div class="flex items-center gap-1.5">
                                <span class="font-extrabold text-sm tracking-wide">${g}ì¡° ì˜ˆì„  ë¦¬ê·¸</span>
                                <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded font-bold ml-1">${currentSize}ëª… í’€ë¦¬ê·¸</span>
                                <span class="text-[10px] bg-emerald-500/80 px-2 py-0.5 rounded font-bold">ì´ ${getRoundRobinPairs(currentSize).length}ê²½ê¸°</span>
                            </div>
                        </div>
                        <table class="w-full text-center text-xs border-collapse" id="table-g${g}">
                            <thead>
                                <tr class="bg-slate-50 border-b-2 border-slate-300 text-slate-700 font-extrabold">
                                    <th class="p-2 border-r border-slate-200 bg-slate-100 w-24 whitespace-nowrap">ì„ ìˆ˜ëª…</th>`;
                
                for(let i=1; i<=currentSize; i++) {
                    let player = window.leaguePlayers[`g${g}_p${i}`];
                    let headerName = player ? escapeHTML(player.name) : `${i}ë²ˆ`;
                    html += `<th class="p-1 border-r border-slate-200 font-bold break-keep text-[11px]" id="th-g${g}-p${i}">${headerName}</th>`;
                }
                
                html += `<th class="p-2 border-r border-slate-200 w-10 whitespace-nowrap">ìŠ¹/íŒ¨</th><th class="p-2 border-r border-slate-200 w-10 whitespace-nowrap">ë“/ì‹¤</th><th class="p-2 w-10 bg-rose-50 text-rose-600 whitespace-nowrap">ìˆœìœ„</th></tr></thead><tbody>`;
                
                for(let i=1; i<=currentSize; i++) {
                    let player = window.leaguePlayers[`g${g}_p${i}`];
                    let displayVal = player ? escapeHTML(player.display) : '';
                    let placeholderVal = player ? displayVal : 'í„°ì¹˜ğŸ‘‰';
                    
                    html += `<tr class="border-b border-slate-200">
                        <td class="p-0 border-r border-slate-200 bg-slate-50" id="td-g${g}-p${i}">
                            <input type="text" value="${displayVal}" class="w-full h-full text-center outline-none cursor-pointer hover:bg-indigo-50 font-bold text-[11px] text-slate-700 p-2 break-keep bg-transparent" placeholder="í„°ì¹˜ğŸ‘‰" readonly onclick="selectLeaguePlayer(this, ${g}, ${i})">
                            <span class="capture-text font-bold text-[11px] text-slate-700 p-2 break-keep bg-slate-50">${placeholderVal}</span>
                        </td>`;
                    
                    for(let j=1; j<=currentSize; j++) { 
                        if(i === j) html += `<td class="border-r border-slate-200 diagonal-strike"></td>`; 
                        else html += `<td class="border-r border-slate-200 p-0"><input type="text" id="score-g${g}-r${i}-c${j}" class="w-full h-full p-2 text-center bg-transparent outline-none font-medium text-slate-600 focus:bg-yellow-50" placeholder="" oninput="syncText(this)"><span class="capture-text font-medium text-slate-600 p-2 bg-white"></span></td>`; 
                    }
                    html += `<td class="border-r border-slate-200 p-0"><input type="text" id="wl-g${g}-p${i}" class="w-full h-full p-2 text-center outline-none font-bold text-slate-700 bg-transparent" placeholder="/" oninput="syncText(this)"><span class="capture-text font-bold text-slate-700 p-2 bg-white">/</span></td>
                    <td class="border-r border-slate-200 p-0"><input type="text" id="diff-g${g}-p${i}" class="w-full h-full p-2 text-center outline-none font-bold text-slate-700 bg-transparent" placeholder="/" oninput="syncText(this)"><span class="capture-text font-bold text-slate-700 p-2 bg-white">/</span></td>
                    <td class="bg-rose-50/30 p-0"><input type="text" id="rank-g${g}-p${i}" class="w-full h-full p-2 text-center outline-none font-black text-rose-600 text-sm bg-transparent" placeholder="" oninput="syncText(this)"><span class="capture-text font-black text-rose-600 p-2 bg-rose-50"></span></td></tr>`;
                }
                html += `</tbody></table></div><div class="bg-slate-50 border-t border-slate-200 text-[11px] text-left no-print"><div class="p-2.5 flex justify-between items-center cursor-pointer font-extrabold text-slate-700 bg-slate-100 hover:bg-slate-200 transition-colors" onclick="toggleOrder(${g})"><span>ğŸ”„ ê²Œì„ ìˆœì„œ ì ‘ê¸°/í¼ì¹˜ê¸°</span><span id="order-icon-${g}" class="text-xs">â–¼</span></div><div id="order-content-${g}" class="hidden p-3 leading-loose break-keep bg-slate-50 shadow-inner"></div></div></div>`;
            }
            html += `</div>`; document.getElementById('op-group-container').innerHTML = html; 
            
            for(let g=1; g<=count; g++) { const tableEl = document.getElementById(`table-g${g}`); if(tableEl) { updateMatchOrderDisplay(g, tableEl.querySelectorAll('tbody tr').length); } }
        }

        function saveTempTable() {
            const count = parseInt(document.getElementById('op-group-count').value) || 2;
            let tableData = { groupCount: count, groupSizes: {}, leaguePlayers: window.leaguePlayers, scores: {} };
            for(let g = 1; g <= count; g++) {
                let sizeInput = document.getElementById(`op-group-size-${g}`);
                let size = sizeInput ? parseInt(sizeInput.value) : 4;
                tableData.groupSizes[g] = size;
                tableData.scores[g] = {};
                for(let i = 1; i <= size; i++) {
                    tableData.scores[g][i] = {};
                    for(let j = 1; j <= size; j++) {
                        if(i === j) continue;
                        let input = document.getElementById(`score-g${g}-r${i}-c${j}`);
                        if(input) tableData.scores[g][i][j] = input.value;
                    }
                    let wl = document.getElementById(`wl-g${g}-p${i}`);
                    let diff = document.getElementById(`diff-g${g}-p${i}`);
                    let rank = document.getElementById(`rank-g${g}-p${i}`);
                    tableData.scores[g][i].wl = wl ? wl.value : '';
                    tableData.scores[g][i].diff = diff ? diff.value : '';
                    tableData.scores[g][i].rank = rank ? rank.value : '';
                }
            }
            try { localStorage.setItem('pingpongTempTable', JSON.stringify(tableData)); alert('ğŸ’¾ ì‘ì„±ì¤‘ì¸ ëŒ€ì§„í‘œì™€ ì ìˆ˜ê°€ ì„ì‹œì €ì¥ ë˜ì—ˆìŠµë‹ˆë‹¤.'); } catch (e) { alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
        }

        function loadTempTable() {
            let dataStr = localStorage.getItem('pingpongTempTable');
            if(!dataStr) { alert('ì„ì‹œì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            let tableData = JSON.parse(dataStr);
            document.getElementById('op-group-count').value = tableData.groupCount;
            generateGroupSizeInputs();
            for(let g = 1; g <= tableData.groupCount; g++) {
                let sizeInput = document.getElementById(`op-group-size-${g}`);
                if(sizeInput && tableData.groupSizes[g]) sizeInput.value = tableData.groupSizes[g];
            }
            window.leaguePlayers = tableData.leaguePlayers || {};
            renderGroupTable(true);
            for(let g = 1; g <= tableData.groupCount; g++) {
                let size = tableData.groupSizes[g] || 4;
                for(let i = 1; i <= size; i++) {
                    for(let j = 1; j <= size; j++) {
                        if(i === j) continue;
                        let input = document.getElementById(`score-g${g}-r${i}-c${j}`);
                        if(input && tableData.scores[g] && tableData.scores[g][i]) { input.value = tableData.scores[g][i][j] || ''; syncText(input); }
                    }
                    let wl = document.getElementById(`wl-g${g}-p${i}`); let diff = document.getElementById(`diff-g${g}-p${i}`); let rank = document.getElementById(`rank-g${g}-p${i}`);
                    if(wl && tableData.scores[g][i]) { wl.value = tableData.scores[g][i].wl || ''; syncText(wl); }
                    if(diff && tableData.scores[g][i]) { diff.value = tableData.scores[g][i].diff || ''; syncText(diff); }
                    if(rank && tableData.scores[g][i]) { rank.value = tableData.scores[g][i].rank || ''; syncText(rank); }
                }
            }
            alert('ğŸ“‚ ì„ì‹œì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        }

        function calculateGroupRankings() {
            const count = parseInt(document.getElementById('op-group-count').value) || 2;
            for(let g = 1; g <= count; g++) {
                let sizeInput = document.getElementById(`op-group-size-${g}`);
                let size = sizeInput ? parseInt(sizeInput.value) : 4;
                let players = [];
                for(let i = 1; i <= size; i++) players.push({ id: i, matchWins: 0, matchLosses: 0, setsWon: 0, setsLost: 0, matches: {} });

                for(let i = 1; i <= size; i++) {
                    for(let j = i + 1; j <= size; j++) {
                        let inputIJ = document.getElementById(`score-g${g}-r${i}-c${j}`); 
                        let inputJI = document.getElementById(`score-g${g}-r${j}-c${i}`); 
                        let valIJ = inputIJ ? inputIJ.value.trim() : "";
                        let valJI = inputJI ? inputJI.value.trim() : "";

                        if(valIJ !== "" || valJI !== "") {
                            let w = parseInt(valIJ) || 0; let l = parseInt(valJI) || 0; 
                            players[i-1].setsWon += w; players[i-1].setsLost += l; players[i-1].matches[j] = { w: w, l: l };
                            players[j-1].setsWon += l; players[j-1].setsLost += w; players[j-1].matches[i] = { w: l, l: w };
                            if(w > l) { players[i-1].matchWins++; players[j-1].matchLosses++; } 
                            else if(l > w) { players[j-1].matchWins++; players[i-1].matchLosses++; }
                        }
                    }
                }

                players.forEach(p => {
                    let wlInput = document.getElementById(`wl-g${g}-p${p.id}`); let diffInput = document.getElementById(`diff-g${g}-p${p.id}`);
                    if(wlInput) { wlInput.value = `${p.matchWins}/${p.matchLosses}`; syncText(wlInput); }
                    if(diffInput) { diffInput.value = `${p.setsWon}/${p.setsLost}`; syncText(diffInput); }
                });

                let sortedPlayers = [...players].sort((a, b) => b.matchWins - a.matchWins);
                let rank = 1; let idx = 0;
                while(idx < sortedPlayers.length) {
                    let tied = [sortedPlayers[idx]]; let next = idx + 1;
                    while(next < sortedPlayers.length && sortedPlayers[next].matchWins === sortedPlayers[idx].matchWins) { tied.push(sortedPlayers[next]); next++; }
                    if(tied.length === 1) { tied[0].finalRank = rank; } 
                    else if (tied.length === 2) {
                        let p1 = tied[0], p2 = tied[1]; let match = p1.matches[p2.id];
                        if(match && match.w > match.l) { p1.finalRank = rank; p2.finalRank = rank + 1; } 
                        else if(match && match.l > match.w) { p2.finalRank = rank; p1.finalRank = rank + 1; } 
                        else {
                            let p1Diff = p1.setsWon - p1.setsLost; let p2Diff = p2.setsWon - p2.setsLost;
                            if(p1Diff > p2Diff) { p1.finalRank = rank; p2.finalRank = rank + 1; }
                            else if(p2Diff > p1Diff) { p2.finalRank = rank; p1.finalRank = rank + 1; }
                            else { p1.finalRank = rank; p2.finalRank = rank; }
                        }
                    } else {
                        tied.forEach(p => {
                            p.tieSetsWon = 0; p.tieSetsLost = 0;
                            tied.forEach(op => { if(p.id !== op.id && p.matches[op.id]) { p.tieSetsWon += p.matches[op.id].w; p.tieSetsLost += p.matches[op.id].l; } });
                            p.tieDiff = p.tieSetsWon - p.tieSetsLost;
                        });
                        tied.sort((a, b) => {
                            if(b.tieDiff !== a.tieDiff) return b.tieDiff - a.tieDiff; 
                            return (b.setsWon - b.setsLost) - (a.setsWon - a.setsLost);
                        });
                        tied.forEach((p, tIdx) => { 
                            if(tIdx > 0) {
                                let prev = tied[tIdx - 1];
                                if(prev.tieDiff === p.tieDiff && (prev.setsWon - prev.setsLost) === (p.setsWon - p.setsLost)) p.finalRank = prev.finalRank; 
                                else p.finalRank = rank + tIdx;
                            } else { p.finalRank = rank; }
                        });
                    }
                    rank += tied.length; idx += tied.length;
                }
                players.forEach(p => { let rankInput = document.getElementById(`rank-g${g}-p${p.id}`); if(rankInput) { rankInput.value = p.finalRank; syncText(rankInput); } });
            }
            alert("ğŸ§® 1ì¹¸ 1ìˆ«ì ë°©ì‹ì´ ë°˜ì˜ëœ íƒêµ¬ ê³µì‹ ë£° ìë™ ê³„ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function sortGroupPlayers() {
            const count = parseInt(document.getElementById('op-group-count').value); 
            for(let g=1; g<=count; g++) {
                let sizeInput = document.getElementById(`op-group-size-${g}`); let currentSize = sizeInput ? parseInt(sizeInput.value) : 4;
                if(isNaN(currentSize) || currentSize < 2) currentSize = 2;
                let groupPlayers = [];
                for(let p=1; p<=currentSize; p++) { let player = window.leaguePlayers[`g${g}_p${p}`]; if (player) groupPlayers.push(player); }
                groupPlayers.sort((a, b) => { if (a.handicap !== b.handicap) return a.handicap - b.handicap; return a.name.localeCompare(b.name); });
                for(let p=1; p<=currentSize; p++) { window.leaguePlayers[`g${g}_p${p}`] = groupPlayers[p-1] || null; }
            }
            renderGroupTable(true);
        }

        function syncText(inputElem) { inputElem.nextElementSibling.innerText = inputElem.value || inputElem.placeholder; }

        async function copyGroupTableImage(g) {
            const target = document.getElementById(`table-container-g${g}`); const btn = document.getElementById(`btn-copy-g${g}`); btn.innerText = "â³ ë³µì‚¬ì¤‘...";
            target.querySelectorAll('input').forEach(input => { syncText(input); }); target.classList.add('capture-mode');
            try {
                const canvas = await html2canvas(target, { scale: 3, backgroundColor: '#ffffff', logging: false, useCORS: true });
                canvas.toBlob(async (blob) => { 
                    try { const item = new ClipboardItem({ 'image/png': blob }); await navigator.clipboard.write([item]); alert(`âœ… ë³µì‚¬ ì™„ë£Œ!`); } catch(err) { alert("âŒ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤."); } 
                    btn.innerText = "ğŸ“¸ ì¹´í†¡ ë³µì‚¬"; target.classList.remove('capture-mode');
                }, 'image/png');
            } catch(e) { btn.innerText = "ğŸ“¸ ì¹´í†¡ ë³µì‚¬"; target.classList.remove('capture-mode'); }
        }

        function selectLeaguePlayer(inputElem, g, p) {
            isSinglePickMode = true; document.getElementById('selector-title').innerText = `${g}ì¡° ${p}ë²ˆ ì„ ìˆ˜ ì„ íƒ`; document.getElementById('selector-count').classList.add('hidden'); document.getElementById('btn-selector-confirm').classList.add('hidden'); document.getElementById('selector-search').value = ""; 
            let excludedNames = []; 
            for (let key in window.leaguePlayers) { if (key !== `g${g}_p${p}` && window.leaguePlayers[key]) excludedNames.push(window.leaguePlayers[key].name); }
            if(renderSelectorList(true, 'league', excludedNames) === false) return; 
            document.getElementById('member-selector-modal').classList.remove('hidden');
            window.singlePickCallback = function(memberId) {
                const m = members.find(x => x.id == memberId);
                if(m) { 
                    const displayName = `${m.name}(${m.handicap})`; window.leaguePlayers[`g${g}_p${p}`] = { id: m.id, name: m.name, display: displayName, handicap: m.handicap }; 
                    inputElem.value = displayName; inputElem.nextElementSibling.innerText = displayName; document.getElementById(`th-g${g}-p${p}`).innerText = m.name; 
                    updateMatchOrderDisplay(g, document.getElementById(`table-g${g}`).querySelectorAll('tbody tr').length); 
                }
            };
        }

        function toggleOrder(g) { const content = document.getElementById(`order-content-${g}`); const icon = document.getElementById(`order-icon-${g}`); if(content.classList.contains('hidden')) { content.classList.remove('hidden'); icon.innerText = 'â–²'; } else { content.classList.add('hidden'); icon.innerText = 'â–¼'; } }
        function updateMatchOrderDisplay(g, size) {
            let pairs = getRoundRobinPairs(size); 
            let blocks = pairs.map((pair, idx) => { let p1Obj = window.leaguePlayers[`g${g}_p${pair[0]}`]; let p2Obj = window.leaguePlayers[`g${g}_p${pair[1]}`]; let n1 = p1Obj ? escapeHTML(p1Obj.name) : `${pair[0]}ë²ˆ`; let n2 = p2Obj ? escapeHTML(p2Obj.name) : `${pair[1]}ë²ˆ`; return `<span class="inline-flex items-center bg-white border border-slate-200 px-2 py-1 rounded shadow-sm mr-1.5 mb-1.5 font-bold text-slate-700 text-[11px]"><span class="text-indigo-600 bg-indigo-50 px-1 rounded mr-1.5">${idx+1}ê²½ê¸°</span> ${n1} <span class="text-slate-300 font-normal mx-1 text-[9px]">vs</span> ${n2}</span>`; });
            document.getElementById(`order-content-${g}`).innerHTML = blocks.join('');
        }

        let currentPrintGroup = null;
        function openPrintModal(g) { currentPrintGroup = g; document.getElementById('print-modal-title').innerText = `ğŸ–¨ï¸ ${g}ì¡° ì¸ì‡„ ì˜µì…˜`; document.getElementById('print-option-modal').classList.remove('hidden'); }
        function closePrintModal() { document.getElementById('print-option-modal').classList.add('hidden'); }
        function executePrint(mode) {
            closePrintModal(); const g = currentPrintGroup; let printHtml = ''; 
            const target = document.getElementById(`table-container-g${g}`); target.querySelectorAll('input').forEach(input => { syncText(input); }); target.classList.add('capture-mode'); const tableHtml = target.outerHTML; target.classList.remove('capture-mode');
            const size = document.getElementById(`table-g${g}`).querySelectorAll('tbody tr').length; let pairs = getRoundRobinPairs(size); 
            let orderHtml = `<div style="margin-top: 20px; page-break-inside: avoid;"><h3 style="font-size:18px; margin-bottom:12px; font-weight:bold; color:#1e293b;">ğŸ”„ ${g}ì¡° ê²Œì„ ìˆœì„œ</h3><div style="line-height: 2.5;">`;
            let blocks = pairs.map((pair, idx) => { let p1Obj = window.leaguePlayers[`g${g}_p${pair[0]}`]; let p2Obj = window.leaguePlayers[`g${g}_p${pair[1]}`]; let n1 = p1Obj ? escapeHTML(p1Obj.name) : `${pair[0]}ë²ˆ`; let n2 = p2Obj ? escapeHTML(p2Obj.name) : `${pair[1]}ë²ˆ`; return `<span style="display:inline-block; border:1px solid #94a3b8; padding:6px 10px; border-radius:6px; margin-right:10px; margin-bottom:10px; font-weight:bold; font-size:14px; background:#f8fafc;"><span style="color:#4f46e5; font-size:12px; margin-right:6px;">${idx+1}ê²½ê¸°</span> ${n1} <span style="font-weight:normal; color:#94a3b8; margin:0 6px;">vs</span> ${n2}</span>`; }); orderHtml += blocks.join('') + `</div></div>`;
            if(mode === 'table') printHtml = tableHtml; else if(mode === 'order') printHtml = orderHtml; else if(mode === 'both') printHtml = tableHtml + orderHtml;
            const printWindow = window.open('', '', 'width=900,height=700'); printWindow.document.write(`<html><head><title>${g}ì¡° ì¸ì‡„</title><style>body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; color: #333; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;} h1 { text-align: center; font-size: 26px; margin-bottom: 20px; color: #1e293b;} table { width: 100%; border-collapse: collapse; margin-bottom: 5px; font-size: 14px; text-align: center; } th, td { border: 1px solid #94a3b8; padding: 12px; } th { background-color: #f1f5f9; font-weight: bold; } .capture-mode input { display: none !important; } .capture-text { display: block !important; width: 100%; text-align: center; font-size: 14px; font-weight: bold; color: black;} .diagonal-strike { background: linear-gradient(to top right, transparent calc(50% - 1px), #cbd5e1, transparent calc(50% + 1px)); background-color: #e2e8f0 !important; } @media print { @page { size: landscape; margin: 10mm; } }</style></head><body><h1>ğŸ“ ${g}ì¡° ì˜ˆì„  ë¦¬ê·¸</h1>${printHtml}</body></html>`); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        // ==============================================================================
        // ğŸ† [ìŠ¤ë§ˆíŠ¸ ëŒ€ì§„í‘œ] ìƒíƒœ ê´€ë¦¬ ë° ë Œë”ë§ ë¡œì§
        // ==============================================================================
        let tournamentState = {
            size: 0,
            rounds: 0,
            tree: [], 
            visibleRound: 0 
        };

        function initTournamentState() {
            const groups = parseInt(document.getElementById('op-tourn-groups').value); 
            const adv = parseInt(document.getElementById('op-tourn-adv').value); 
            const totalPlayers = groups * adv;
            
            let size = 2; 
            while(size < totalPlayers) size *= 2;
            
            tournamentState.size = size;
            tournamentState.rounds = Math.log2(size);
            tournamentState.visibleRound = 0;
            
            const infoBox = document.getElementById('op-tourn-info'); 
            infoBox.classList.remove('hidden'); 
            infoBox.innerHTML = `âœ… ${groups}ì¡° Ã— ${adv}ëª… = <b>${totalPlayers}ëª… ì§„ì¶œ</b> ğŸ‘‰ <b>${size}ê°• ëŒ€ì§„í‘œ</b>`;
            
            let players = []; 
            for (let rank = 1; rank <= adv; rank++) { 
                let grpArr = Array.from({length: groups}, (_, i) => i + 1); 
                if (rank % 2 === 0) { 
                    grpArr.reverse(); 
                    let shift = Math.floor(groups / 2); 
                    grpArr = grpArr.slice(shift).concat(grpArr.slice(0, shift)); 
                } 
                for (let g of grpArr) players.push(`${g}ì¡°${rank}ìœ„`); 
            }
            
            let seeds = [1, 2]; 
            for (let i = 2; i < size; i *= 2) { 
                let temp = []; 
                for (let j = 0; j < seeds.length; j++) temp.push(seeds[j], 2 * i + 1 - seeds[j]); 
                seeds = temp; 
            }
            
            let bracketPlayers = new Array(size).fill(null); 
            for(let i = 0; i < size; i++) { 
                let seedVal = seeds[i]; 
                bracketPlayers[i] = seedVal <= totalPlayers ? players[seedVal - 1] : "ë¶€ì „ìŠ¹(BYE)"; 
            }
            
            tournamentState.tree = [];
            tournamentState.tree[0] = [...bracketPlayers]; 
            for (let r = 1; r <= tournamentState.rounds; r++) {
                tournamentState.tree[r] = new Array(size / Math.pow(2, r)).fill(null);
            }
            
            propagateByes();
            renderTournamentUI();
        }

        function propagateByes() {
            for (let r = 1; r <= tournamentState.rounds; r++) {
                let numNodes = tournamentState.size / Math.pow(2, r);
                for (let n = 0; n < numNodes; n++) {
                    let p1 = tournamentState.tree[r-1][n * 2];
                    let p2 = tournamentState.tree[r-1][n * 2 + 1];
                    
                    if (tournamentState.tree[r][n] === null) {
                        if (p1 === "ë¶€ì „ìŠ¹(BYE)" && p2 && p2 !== "ë¶€ì „ìŠ¹(BYE)") tournamentState.tree[r][n] = p2;
                        else if (p2 === "ë¶€ì „ìŠ¹(BYE)" && p1 && p1 !== "ë¶€ì „ìŠ¹(BYE)") tournamentState.tree[r][n] = p1;
                        else if (p1 === "ë¶€ì „ìŠ¹(BYE)" && p2 === "ë¶€ì „ìŠ¹(BYE)") tournamentState.tree[r][n] = "ë¶€ì „ìŠ¹(BYE)";
                    }
                }
            }
        }

        function loadQualifierResults() {
            if (!tournamentState || tournamentState.size === 0) {
                alert("ë¨¼ì € [ëŒ€ì§„í‘œ ìƒì„±] ë²„íŠ¼ì„ ëˆŒëŸ¬ íŠ¸ë¦¬ë¥¼ ì´ˆê¸°í™”í•´ ì£¼ì„¸ìš”."); return;
            }
            
            const groups = parseInt(document.getElementById('op-group-count').value) || 0;
            let rankMap = {};
            
            for(let g = 1; g <= groups; g++) {
                let sizeInput = document.getElementById(`op-group-size-${g}`);
                let currentSize = sizeInput ? parseInt(sizeInput.value) : 4;
                for(let p = 1; p <= currentSize; p++) {
                    let playerObj = window.leaguePlayers[`g${g}_p${p}`];
                    let rankInput = document.getElementById(`rank-g${g}-p${p}`);
                    if (playerObj && rankInput && rankInput.value.trim() !== "") {
                        let rankVal = rankInput.value.trim();
                        rankMap[`${g}ì¡°${rankVal}ìœ„`] = playerObj.display;
                    }
                }
            }

            let mappedCount = 0;
            for(let i = 0; i < tournamentState.tree[0].length; i++) {
                let cellVal = tournamentState.tree[0][i];
                if (cellVal && cellVal.includes('ì¡°') && cellVal.includes('ìœ„')) {
                    if (rankMap[cellVal]) {
                        tournamentState.tree[0][i] = rankMap[cellVal];
                        mappedCount++;
                    }
                }
            }
            
            if(mappedCount === 0) alert("ì˜ˆì„  ê¸°ë¡ì—ì„œ ì‚°ì¶œëœ ìˆœìœ„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìë™ ìˆœìœ„ë¥¼ ë¨¼ì € ê³„ì‚°í•´ ì£¼ì„¸ìš”.");
            else alert(`âœ… ì˜ˆì„  ê²°ê³¼ ${mappedCount}ëª…ì´ ëŒ€ì§„í‘œì— ìë™ ì…‹ì—…ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            for(let r=1; r<=tournamentState.rounds; r++) tournamentState.tree[r].fill(null);
            propagateByes();
            renderTournamentUI();
        }

        function renderTournamentUI() {
            if (!tournamentState || tournamentState.size === 0) return;
            
            const size = tournamentState.size;
            const rounds = tournamentState.rounds;
            const vRound = tournamentState.visibleRound; 
            
            const filterContainer = document.getElementById('tourn-filter-container');
            filterContainer.classList.remove('hidden');
            document.getElementById('tourn-quick-nav').classList.remove('hidden');
            
            let filterHtml = `<button onclick="setTournamentFilter(0)" class="px-3 py-1.5 rounded-lg text-[11px] font-extrabold transition-colors shadow-sm ${vRound === 0 ? 'bg-slate-800 text-white' : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-100'} btn-press">ì „ì²´ë³´ê¸°</button>`;
            for(let r = 0; r < rounds - 1; r++) {
                let roundSize = size / Math.pow(2, r);
                if(roundSize <= 64 && roundSize >= 4) {
                    let btnText = roundSize === 4 ? "ì¤€ê²°ìŠ¹(4ê°•)" : roundSize + "ê°•";
                    filterHtml += `<button onclick="setTournamentFilter(${r})" class="px-3 py-1.5 rounded-lg text-[11px] font-extrabold transition-colors shadow-sm ${vRound === r ? 'bg-slate-800 text-white' : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-100'} btn-press">${btnText}</button>`;
                }
            }
            filterContainer.innerHTML = filterHtml;

            let minHeight = Math.max((size / Math.pow(2, vRound) / 2) * 50, 350);
            let html = `<div id="op-tourn-scroll-area" class="flex w-max min-w-full font-bold text-sm bg-slate-50/50 p-6 rounded-xl border border-slate-200 relative transition-all" style="min-height: ${minHeight}px; justify-content: center;">`;

            const createNodeHtml = (r, n, isLeftBracket) => {
                let player = tournamentState.tree[r][n];
                let isBye = player === "ë¶€ì „ìŠ¹(BYE)";
                let isTop = n % 2 === 0;
                
                let isWinner = false;
                let isLoser = false;
                if (r < rounds && player && !isBye) {
                    let advancedPlayer = tournamentState.tree[r+1][Math.floor(n/2)];
                    if (advancedPlayer === player) isWinner = true;
                    else if (advancedPlayer && advancedPlayer !== "ë¶€ì „ìŠ¹(BYE)") isLoser = true; 
                }

                let borderClass = "";
                if (isLeftBracket) borderClass = isTop ? "border-r-line border-b-line rounded-br-xl" : "border-r-line border-t-line rounded-tr-xl";
                else borderClass = isTop ? "border-l-line border-b-line rounded-bl-xl" : "border-l-line border-t-line rounded-tl-xl";

                let content = '';
                if (isBye) { 
                    content = `
                    <div class="flex items-center justify-center relative w-full h-12 my-2.5 z-10 px-3">
                        <div class="border-2 border-dashed border-slate-300 bg-slate-100/50 text-slate-400 rounded-lg w-full max-w-[130px] flex flex-col justify-center h-10 shadow-inner opacity-60">
                            <div class="text-[11px] text-center w-full font-extrabold tracking-widest">BYE</div>
                        </div>
                    </div>`; 
                } else {
                    let displayVal = player || '';
                    let isAutoPlaceholder = displayVal.includes('ì¡°') && displayVal.includes('ìœ„');
                    let placeholder = r === 0 ? 'í„°ì¹˜ì„ íƒ' : 'ìŠ¹ì ì„ íƒ';
                    let inputValue = isAutoPlaceholder ? '' : displayVal; 
                    
                    let bgClass = 'bg-white';
                    let textClass = 'text-slate-700';
                    let borderCol = 'border-slate-300';
                    
                    if(isWinner) { bgClass = 't-winner'; }
                    else if(isLoser) { bgClass = 't-loser'; }
                    else if(r > 0 && !inputValue) { bgClass = 'bg-indigo-50'; textClass = 'text-indigo-800'; borderCol = 'border-indigo-300'; }

                    let badgeHtml = isAutoPlaceholder ? `<div class="absolute -top-2.5 left-1/2 -translate-x-1/2 bg-slate-100 border border-slate-300 text-slate-600 px-2 py-0.5 rounded-full text-[9px] font-black shadow-sm whitespace-nowrap z-20">${displayVal}</div>` : '';
                    
                    let matchNumHtml = '';
                    if (r === vRound) {
                        let totalNodesInRound = size / Math.pow(2, vRound);
                        let mNum = isLeftBracket ? (n + 1) : (totalNodesInRound - n);
                        let posClass = isLeftBracket ? 'left-0 -ml-1.5' : 'right-0 -mr-1.5';
                        matchNumHtml = `<div class="absolute ${posClass} top-1/2 -translate-y-1/2 bg-slate-700 text-white text-[8px] font-black w-4 h-4 flex items-center justify-center rounded shadow-sm z-30">${mNum}</div>`;
                    }

                    let clickHandler = r === 0 ? `openLeafSelector(${n})` : `openWinnerModal(${r}, ${n})`;

                    content = `
                    <div class="flex items-center justify-center relative w-full h-12 my-2.5 z-10 px-3">
                        ${matchNumHtml}
                        <div onclick="${clickHandler}" class="border ${borderCol} ${bgClass} rounded-lg w-full max-w-[130px] shadow-sm flex items-center justify-center h-10 hover:ring-2 hover:ring-indigo-400 transition-all relative cursor-pointer">
                            ${badgeHtml}
                            <input class="w-full h-full text-center outline-none text-[12px] font-extrabold cursor-pointer bg-transparent ${textClass}" placeholder="${placeholder}" value="${inputValue}" readonly>
                            <span class="capture-text font-extrabold text-[12px] ${textClass}">${inputValue || placeholder}</span>
                        </div>
                    </div>`; 
                }

                let linesHtml = "";
                if (isLeftBracket) {
                    linesHtml += r > vRound ? `<div class="absolute left-0 w-1/2 h-[2px] bg-slate-400 top-1/2 z-0"></div>` : '';
                    linesHtml += `<div class="absolute right-0 w-1/2 h-[2px] bg-slate-400 top-1/2 z-0"></div>`;
                    linesHtml += `<div class="absolute right-0 w-1/2 ${borderClass} z-0" style="height: 50%; ${isTop ? 'bottom: 0;' : 'top: 0;'}"></div>`;
                } else {
                    linesHtml += r > vRound ? `<div class="absolute right-0 w-1/2 h-[2px] bg-slate-400 top-1/2 z-0"></div>` : '';
                    linesHtml += `<div class="absolute left-0 w-1/2 h-[2px] bg-slate-400 top-1/2 z-0"></div>`;
                    linesHtml += `<div class="absolute left-0 w-1/2 ${borderClass} z-0" style="height: 50%; ${isTop ? 'bottom: 0;' : 'top: 0;'}"></div>`;
                }

                return `<div class="flex-1 flex flex-col justify-center relative tourn-node">${linesHtml}${content}</div>`;
            };

            for (let r = vRound; r < rounds; r++) {
                let numNodes = size / Math.pow(2, r);
                let colWidth = r === vRound ? '145px' : '155px';
                html += `<div class="flex flex-col justify-around relative" style="width: ${colWidth}; z-index: ${rounds - r};">`;
                for (let n = 0; n < numNodes / 2; n++) html += createNodeHtml(r, n, true);
                html += `</div>`;
            }

            let champion = tournamentState.tree[rounds][0];
            html += `
            <div class="flex flex-col justify-center relative px-2 z-50" style="width: 190px;">
                <div class="absolute left-0 w-1/2 h-[2px] bg-slate-400 top-1/2 z-0"></div>
                <div class="absolute right-0 w-1/2 h-[2px] bg-slate-400 top-1/2 z-0"></div>
                <div onclick="openWinnerModal(${rounds}, 0)" class="bg-gradient-to-br from-yellow-100 to-amber-50 border-2 border-yellow-400 p-3 rounded-2xl text-center shadow-2xl z-10 w-full relative transform scale-110 cursor-pointer hover:scale-115 transition-transform">
                    <div class="text-[11px] text-rose-600 mb-1 font-black tracking-widest drop-shadow-sm">ğŸ‘‘ ìµœì¢… ìš°ìŠ¹</div>
                    <input class="w-full text-center bg-transparent outline-none font-black text-[15px] text-amber-800 cursor-pointer" placeholder="í„°ì¹˜í•˜ì—¬ í™•ì •" value="${champion || ''}" readonly>
                    <span class="capture-text font-black text-lg text-amber-800">${champion || 'ìš°ìŠ¹ì'}</span>
                </div>
            </div>
            `;

            for (let r = rounds - 1; r >= vRound; r--) {
                let numNodes = size / Math.pow(2, r);
                let colWidth = r === vRound ? '145px' : '155px';
                html += `<div class="flex flex-col justify-around relative" style="width: ${colWidth}; z-index: ${rounds - r};">`;
                for (let n = numNodes / 2; n < numNodes; n++) html += createNodeHtml(r, n, false);
                html += `</div>`;
            }

            html += `</div>`; 

            const container = document.getElementById('op-tourn-container');
            container.innerHTML = html;
        }

        function setTournamentFilter(roundIdx) {
            if (tournamentState) tournamentState.visibleRound = roundIdx;
            renderTournamentUI();
        }

        function scrollTourn(position) {
            const container = document.getElementById('op-tourn-container');
            const area = document.getElementById('op-tourn-scroll-area');
            if (!container || !area) return;
            let targetScroll = 0;
            if (position === 'left') targetScroll = 0;
            else if (position === 'center') targetScroll = (area.scrollWidth - container.clientWidth) / 2;
            else if (position === 'right') targetScroll = area.scrollWidth;
            container.scrollTo({ left: targetScroll, behavior: 'smooth' });
        }

        let currentEditingLeaf = null;
        function openLeafSelector(n) {
            currentEditingLeaf = n;
            isSinglePickMode = true; 
            document.getElementById('selector-title').innerText = "1ë¼ìš´ë“œ ì§„ì¶œì ìˆ˜ë™ ì„ íƒ"; 
            document.getElementById('selector-count').classList.add('hidden'); 
            document.getElementById('btn-selector-confirm').classList.add('hidden'); 
            document.getElementById('selector-search').value = ""; 
            
            let excludedNames = [];
            tournamentState.tree[0].forEach(cell => {
                if (cell && cell !== "ë¶€ì „ìŠ¹(BYE)" && !cell.includes('ì¡°') && !cell.includes('ìœ„')) {
                    let nameMatch = cell.match(/^([^\(]+)/);
                    if (nameMatch) excludedNames.push(nameMatch[1].trim());
                }
            });

            if(renderSelectorList(true, 'tourn', excludedNames) === false) return; 
            document.getElementById('member-selector-modal').classList.remove('hidden'); 
            
            window.singlePickCallback = function(memberId) { 
                const m = members.find(x => x.id == memberId); 
                if(m) { 
                    tournamentState.tree[0][n] = `${m.name}(${m.handicap})`; 
                    cascadeClearTournament(0, n);
                    propagateByes();
                    renderTournamentUI();
                } 
            }; 
        }

        let currentWinnerTarget = null;
        function openWinnerModal(r, n) {
            if (r === 0) return; 
            
            let p1 = tournamentState.tree[r-1][n*2];
            let p2 = tournamentState.tree[r-1][n*2+1];
            
            if (!p1 || p1.includes('ì¡°') || !p2 || p2.includes('ì¡°')) {
                alert("ì´ì „ ë¼ìš´ë“œ ìŠ¹ìê°€ ì•„ì§ ê²°ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return;
            }
            if (p1 === "ë¶€ì „ìŠ¹(BYE)" || p2 === "ë¶€ì „ìŠ¹(BYE)") {
                alert("ë¶€ì „ìŠ¹ì€ ìë™ìœ¼ë¡œ ì§„ì¶œë©ë‹ˆë‹¤."); return;
            }

            currentWinnerTarget = { r: r, n: n };
            const btn1 = document.getElementById('btn-winner-p1');
            const btn2 = document.getElementById('btn-winner-p2');
            
            btn1.innerText = p1;
            btn1.onclick = () => selectWinner(p1);
            
            btn2.innerText = p2;
            btn2.onclick = () => selectWinner(p2);
            
            document.getElementById('winner-selector-modal').classList.remove('hidden');
        }

        function closeWinnerSelector() { document.getElementById('winner-selector-modal').classList.add('hidden'); }
        
        function selectWinner(winnerName) {
            if (currentWinnerTarget) {
                tournamentState.tree[currentWinnerTarget.r][currentWinnerTarget.n] = winnerName;
                cascadeClearTournament(currentWinnerTarget.r, currentWinnerTarget.n);
                renderTournamentUI();
            }
            closeWinnerSelector();
        }

        function cascadeClearTournament(startR, startN) {
            let r = startR + 1;
            let n = Math.floor(startN / 2);
            while (r <= tournamentState.rounds) {
                tournamentState.tree[r][n] = null;
                r++;
                n = Math.floor(n / 2);
            }
        }

        async function copyTournamentImage() {
            const wrapper = document.getElementById('op-tourn-scroll-area');
            const btn = document.getElementById('btn-capture-tourn');
            btn.innerHTML = "â³ ìº¡ì²˜ì¤‘...";
            
            const prevRound = tournamentState.visibleRound;
            tournamentState.visibleRound = 0;
            renderTournamentUI();
            
            await new Promise(r => setTimeout(r, 100));

            const newWrapper = document.getElementById('op-tourn-scroll-area');
            newWrapper.querySelectorAll('input').forEach(input => syncText(input));
            newWrapper.classList.add('capture-mode');
            
            const oldWidth = newWrapper.style.width;
            const oldMinWidth = newWrapper.style.minWidth;
            const oldOverflow = newWrapper.style.overflow;
            newWrapper.style.width = newWrapper.scrollWidth + 'px';
            newWrapper.style.minWidth = newWrapper.scrollWidth + 'px';
            newWrapper.style.overflow = 'visible';
            
            try {
                const canvas = await html2canvas(newWrapper, { 
                    scale: 2, 
                    backgroundColor: '#ffffff', 
                    logging: false, 
                    useCORS: true,
                    width: newWrapper.scrollWidth,
                    height: newWrapper.scrollHeight
                });
                canvas.toBlob(async (blob) => { 
                    try { 
                        const item = new ClipboardItem({ 'image/png': blob }); 
                        await navigator.clipboard.write([item]); 
                        alert(`âœ… ëŒ€ì§„í‘œ ì „ì²´ê°€ ì˜ë¦¼ ì—†ì´ ê³ í™”ì§ˆë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.`); 
                    } catch(err) { 
                        alert("âŒ í´ë¦½ë³´ë“œ ê¶Œí•œì´ ì—†ê±°ë‚˜ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤."); 
                    } 
                    cleanupCapture();
                }, 'image/png');
            } catch(e) {
                alert("ìº¡ì²˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                cleanupCapture();
            }

            function cleanupCapture() {
                tournamentState.visibleRound = prevRound;
                renderTournamentUI();
                const restoredBtn = document.getElementById('btn-capture-tourn');
                if(restoredBtn) restoredBtn.innerHTML = "ğŸ“¸ ì¹´í†¡ ë³µì‚¬"; 
            }
        }

        function printTournament() {
            const target = document.getElementById('op-tourn-scroll-area'); 
            target.querySelectorAll('input').forEach(input => syncText(input)); 
            
            const originalMinWidth = target.style.minWidth;
            const originalOverflow = target.style.overflow;
            target.style.minWidth = 'max-content';
            target.style.overflow = 'visible';
            target.classList.add('capture-mode'); 
            
            const printContent = target.outerHTML; 
            
            target.classList.remove('capture-mode');
            target.style.minWidth = originalMinWidth;
            target.style.overflow = originalOverflow;
            
            const printWindow = window.open('', '', 'width=1100,height=800');
            printWindow.document.write(`
                <html>
                <head>
                    <title>ë³¸ì„  ëŒ€ì§„í‘œ ì¸ì‡„</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;700;800;900&display=swap');
                        body { font-family: 'Pretendard', sans-serif; padding: 20px; background: white; text-align: center; }
                        h1 { margin-bottom: 30px; font-size: 28px; font-weight: 900; color: #1e293b; }
                        
                        .border-r-line { border-right: 2px solid #64748b !important; }
                        .border-l-line { border-left: 2px solid #64748b !important; }
                        .border-t-line { border-top: 2px solid #64748b !important; }
                        .border-b-line { border-bottom: 2px solid #64748b !important; }
                        .rounded-bl-xl { border-bottom-left-radius: 0.75rem !important; }
                        .rounded-tl-xl { border-top-left-radius: 0.75rem !important; }
                        .t-winner { background-color: #eff6ff !important; border: 2px solid #3b82f6 !important; color: #1d4ed8 !important; }
                        .t-loser { background-color: #f8fafc !important; border: 1px solid #e2e8f0 !important; color: #94a3b8 !important; filter: grayscale(100%); opacity: 0.6; }
                        
                        .capture-mode { margin: 0 auto !important; width: max-content !important; transform-origin: top center; overflow: visible !important; }
                        .capture-mode input { display: none !important; } 
                        .capture-mode .capture-text { display: block !important; width: 100%; text-align: center; font-weight: 900 !important; }
                        
                        @media print { 
                            @page { size: A4 landscape; margin: 10mm; } 
                            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; zoom: 0.6; } 
                        }
                    </style>
                </head>
                <body>
                    <h1>ğŸ“ ë³¸ì„  í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ</h1>
                    ${printContent}
                    <script>
                        setTimeout(() => { window.print(); window.close(); }, 800);
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close(); 
            printWindow.focus(); 
        }

        // ==============================================================================
        // ê³µí†µ UI ìŠ¤í¬ë¦½íŠ¸ ë° ê¸°íƒ€ í•¨ìˆ˜
        // ==============================================================================
        function filterSelector(keyword) { const btns = document.querySelectorAll('#selector-list button'); btns.forEach(b => { if(b.innerText.toLowerCase().includes(keyword.toLowerCase())) b.classList.remove('hidden'); else b.classList.add('hidden'); }); }
        
        function renderSelectorList(onlyAttendees, target, extraExcludedNames = []) {
            let candidates = []; 
            if (target === 'opAttend') { 
                candidates = members.filter(m => m.status === 'active'); 
            } else if (target === 'league') {
                if (!formState.opAttend || formState.opAttend.length === 0) {
                    alert('ë¨¼ì € [ì˜¤ëŠ˜ ê²½ê¸° ì°¸ì„ì ëª…ë‹¨]ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                    return false;
                }
                candidates = members.filter(m => formState.opAttend.includes(m.name));
            } else if(onlyAttendees) { 
                if(formState.opAttend && formState.opAttend.length > 0) candidates = members.filter(m => formState.opAttend.includes(m.name)); 
                else if(formState.attend && formState.attend.length > 0) candidates = members.filter(m => formState.attend.includes(m.name)); 
                else { alert('ë¨¼ì € [ìš´ì˜] ë˜ëŠ” [ì…ë ¥] íƒ­ì—ì„œ ì˜¤ëŠ˜ ì°¸ì„ìë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return false; } 
            } else {
                candidates = members.filter(m => m.status === 'active');
            }

let excludedNames = []; 
            const prefix = target.replace(/[0-9]/g, ''); // 'tn', 'utn', 'ltn' ë“± ë™ì  ì¶”ì¶œ
            if (['lg', 'tm', 'tn', 'utn', 'ltn', 'db'].includes(prefix)) { 
                ['1', '2', '3'].forEach(num => { 
                    if (prefix + num !== target && formState[prefix + num]) {
                        excludedNames.push(...formState[prefix + num]); 
                    }
                }); 
            }
            candidates = candidates.filter(m => !excludedNames.includes(m.name) && !extraExcludedNames.includes(m.name));
            
            const listEl = document.getElementById('selector-list'); const emptyMsg = document.getElementById('selector-empty-msg'); listEl.innerHTML = '';
            if(candidates.length === 0) { listEl.classList.add('hidden'); emptyMsg.classList.remove('hidden'); } else { listEl.classList.remove('hidden'); emptyMsg.classList.add('hidden'); 
                candidates.sort((a,b) => { if (a.handicap !== b.handicap) return a.handicap - b.handicap; return a.name.localeCompare(b.name); }).forEach(m => { 
                    const isSelected = !isSinglePickMode && tempSelectorList.includes(m.name); 
                    const bgClass = isSelected ? 'bg-indigo-600 text-white border-indigo-700 shadow-inner' : 'bg-white text-slate-600 border-slate-200 shadow-sm hover:bg-slate-50'; 
                    listEl.innerHTML += `<button onclick="${isSinglePickMode ? `window.singlePickCallback('${m.id}'); closeSelector();` : `toggleSelect('${escapeHTML(m.name)}')`}" id="sel-btn-${escapeHTML(m.name)}" class="py-3 px-1 border rounded-xl text-[12px] font-extrabold transition-all btn-press ${bgClass}">${escapeHTML(m.name)} <span class="text-[9px] ${isSelected?'text-indigo-200':'text-slate-400'} block mt-0.5 font-medium">${m.handicap}ë¶€</span></button>`; 
                }); 
            } return true;
        }
        function openSelector(target, title, onlyAttendees) { isSinglePickMode = false; document.getElementById('selector-count').classList.remove('hidden'); document.getElementById('btn-selector-confirm').classList.remove('hidden'); document.getElementById('selector-search').value = ""; currentSelectorTarget = target; document.getElementById('selector-title').innerText = title; tempSelectorList = [...(formState[target] || [])]; if(renderSelectorList(onlyAttendees, target) !== false) { updateSelectorCount(); document.getElementById('member-selector-modal').classList.remove('hidden'); } }
        function toggleSelect(name) { const idx = tempSelectorList.indexOf(name); const btn = document.getElementById(`sel-btn-${name}`); if(idx > -1) { tempSelectorList.splice(idx, 1); btn.className = "py-3 px-1 border rounded-xl text-[12px] font-extrabold transition-all bg-white text-slate-600 border-slate-200 shadow-sm hover:bg-slate-50 btn-press"; btn.querySelector('span').className = "text-[9px] text-slate-400 block mt-0.5 font-medium"; } else { tempSelectorList.push(name); btn.className = "py-3 px-1 border rounded-xl text-[12px] font-extrabold transition-all bg-indigo-600 text-white border-indigo-700 shadow-inner btn-press"; btn.querySelector('span').className = "text-[9px] text-indigo-200 block mt-0.5 font-medium"; } updateSelectorCount(); }
        function updateSelectorCount() { document.getElementById('selector-count').innerText = `${tempSelectorList.length}ëª… ì„ íƒë¨`; }
        function closeSelector() { document.getElementById('member-selector-modal').classList.add('hidden'); }
        function confirmSelector() { 
            formState[currentSelectorTarget] = [...tempSelectorList]; 
            if(currentSelectorTarget === 'attend' || currentSelectorTarget === 'opAttend') { 
                for(let key in formState) { 
                    if(key !== 'attend' && key !== 'opAttend') formState[key] = (formState[key]||[]).filter(name => formState[currentSelectorTarget].includes(name)); 
                } 
            } 
            updateFormUI(); 
            if(currentSelectorTarget === 'opAttend') generateGroupSizeInputs(); // ì¡° í¬ê¸° ìë™ ì„¸íŒ… ì—°ë™
            closeSelector(); 
        }
        function initFormState() { for(let key in formState) if(key !== 'opAttend') formState[key] = []; updateFormUI(); }
        function updateFormUI() { for(let key in formState) { const el = document.getElementById(`ui-box-${key}`); if(!el) continue; if((formState[key]||[]).length === 0) { let emptyMsg = (key === 'attend' || key === 'opAttend') ? 'ğŸ‘‡ ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª…ë‹¨ì„ ì„ íƒí•˜ì„¸ìš”' : (key === 'lazy' ? 'í•´ë‹¹ì ì—†ìŒ' : 'ì„ íƒ'); el.innerHTML = `<span class="name-chip-empty ${key === 'lazy' ? 'text-red-300' : ''}">${emptyMsg}</span>`; } else el.innerHTML = formState[key].map(name => `<span class="name-chip shadow-sm">${escapeHTML(name)}</span>`).join(''); } }
        
        function downloadExcelTemplate() { try { const ws_data = [['êµ¬ë¶„', 'ë¶€ì„œ', 'ë“±ê¸‰', 'ì§ì±…', 'ì§ê¸‰', 'ì´ë¦„(*í•„ìˆ˜)', 'ë¶€ìˆ˜(*í•„ìˆ˜,ìˆ«ì)', 'ì„±ë³„', 'ìƒíƒœ(í™œë™/íœ´ë©´)', 'ì—°ë½ì²˜'],['ì‹œ', 'ì²´ìœ¡ì§„í¥ê³¼', 'ì—°íšŒì›', 'ì´ë¬´', 'ì£¼ë¬´ê´€', 'í™ê¸¸ë™', '5', 'ë‚¨', 'í™œë™', '010-0000-0000']]; const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ws_data), "íšŒì›ë“±ë¡ì–‘ì‹"); XLSX.writeFile(wb, "íƒêµ¬ë¦¬ê·¸_íšŒì›ì¼ê´„ë“±ë¡_ì–‘ì‹.xlsx"); } catch(e) { alert("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"); } }
        
        function handleExcelUpload(event) { 
            const file = event.target.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                try { 
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'}); 
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, defval: ""}); 
                    
                    if(jsonData.length < 2) throw new Error("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    
                    const headers = jsonData[0].map(h => String(h).trim());
                    const idxName = headers.findIndex(h => h.includes('ì´ë¦„')) > -1 ? headers.findIndex(h => h.includes('ì´ë¦„')) : 5;
                    const idxHandi = headers.findIndex(h => h.includes('ë¶€ìˆ˜')) > -1 ? headers.findIndex(h => h.includes('ë¶€ìˆ˜')) : 6;
                    const idxAffil = headers.findIndex(h => h.includes('êµ¬ë¶„')) > -1 ? headers.findIndex(h => h.includes('êµ¬ë¶„')) : 0;
                    const idxDept = headers.findIndex(h => h.includes('ë¶€ì„œ')) > -1 ? headers.findIndex(h => h.includes('ë¶€ì„œ')) : 1;
                    const idxType = headers.findIndex(h => h.includes('ë“±ê¸‰')) > -1 ? headers.findIndex(h => h.includes('ë“±ê¸‰')) : 2;
                    const idxDuty = headers.findIndex(h => h.includes('ì§ì±…')) > -1 ? headers.findIndex(h => h.includes('ì§ì±…')) : 3;
                    const idxRank = headers.findIndex(h => h.includes('ì§ê¸‰')) > -1 ? headers.findIndex(h => h.includes('ì§ê¸‰')) : 4;
                    const idxGender = headers.findIndex(h => h.includes('ì„±ë³„')) > -1 ? headers.findIndex(h => h.includes('ì„±ë³„')) : 7;
                    const idxStatus = headers.findIndex(h => h.includes('ìƒíƒœ')) > -1 ? headers.findIndex(h => h.includes('ìƒíƒœ')) : 8;
                    const idxPhone = headers.findIndex(h => h.includes('ì—°ë½ì²˜')) > -1 ? headers.findIndex(h => h.includes('ì—°ë½ì²˜')) : 9;

                    let addedCount = 0; 
                    for (let i = 1; i < jsonData.length; i++) { 
                        const row = jsonData[i]; 
                        if (!row || row.length === 0) continue; 
                        const name = String(row[idxName] || '').trim(); 
                        const handicapStr = String(row[idxHandi] || '').trim(); 
                        if (name !== '' && handicapStr !== '') { 
                            let rawStatus = String(row[idxStatus] || '').trim(); 
                            let statusVal = (rawStatus === 'íœ´ë©´' || rawStatus === 'inactive') ? 'inactive' : 'active'; 
                            members.push({ 
                                id: nextMemberId++, 
                                affiliation: String(row[idxAffil] || 'ì‹œ').trim(), 
                                dept: String(row[idxDept] || '').trim(), 
                                type: String(row[idxType] || 'ì—°íšŒì›').trim(), 
                                duty: String(row[idxDuty] || '').trim(), 
                                rank: String(row[idxRank] || '').trim(), 
                                name: name, 
                                handicap: parseInt(handicapStr) || 5, 
                                gender: String(row[idxGender] || 'ë‚¨').trim(), 
                                status: statusVal, 
                                phone: String(row[idxPhone] || '').trim(), 
                                photo: '', 
                                score: 0.0, 
                                prevRank: members.length + 1 
                            }); 
                            addedCount++; 
                        } 
                    } 
                    if(addedCount > 0) { alert(`${addedCount}ëª… ì—…ë¡œë“œ ë¨`); saveDataToStorage(); renderAll(); } else { alert("ìœ íš¨í•œ ë°ì´í„° ì—†ìŒ"); } 
                } catch(err) { alert("ì˜¤ë¥˜ ë°œìƒ: ì˜¬ë°”ë¥¸ ì–‘ì‹ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."); } 
                document.getElementById('excel-upload').value = ""; 
            }; 
            reader.readAsArrayBuffer(file); 
        }

        function toggleMemberInfo(id) { 
            const selector = document.getElementById('season-selector');
            if (selector && selector.value !== "current") return;
            const infoRow = document.getElementById(`member-info-${id}`); 
            document.querySelectorAll('[id^="member-info-"]').forEach(row => { if (row.id !== `member-info-${id}`) row.classList.add('hidden'); }); 
            if (infoRow.classList.contains('hidden')) { infoRow.classList.remove('hidden'); } else { infoRow.classList.add('hidden'); } 
        }

        // ì¶”ê°€ë¨: ëˆ„ë½ë˜ì–´ ìˆë˜ ê°œì¸ ê¸°ë¡ ì—´ëŒ ë¡œì§(ìˆœìœ„ íƒ­ì—ì„œ í„°ì¹˜ ì‹œ)
        function toggleMemberDetail(id) {
            const detailRow = document.getElementById(`detail-row-${id}`);
            const contentTd = document.getElementById(`detail-content-${id}`);
            if(!detailRow.classList.contains('hidden')) {
                detailRow.classList.add('hidden');
                return;
            }
            document.querySelectorAll('.detail-row').forEach(row => row.classList.add('hidden'));
            
            const memberObj = members.find(x => x.id === id);
            if (!memberObj) return;
            const memberName = memberObj.name;
            const memberMatches = matchHistory.filter(m => (m.attend||[]).includes(memberName));
            let html = '<div class="p-4 bg-slate-50 border-t border-slate-100 shadow-inner"><div class="text-xs font-bold text-slate-600 mb-3">ìƒì„¸ ê²½ê¸° ì°¸ì„ ë° íšë“ ì ìˆ˜ ë‚´ì—­</div><ul class="space-y-1.5 text-[11px]">';
            
            memberMatches.forEach(match => {
                let pts = scoreRules.attend;
                let isLazy = (match.lazy||[]).includes(memberName);
                if(!isLazy) pts += scoreRules.sincerity;
                
                let wins = [];
                const checkWin = (arr, label, score) => {
                    if((arr||[]).includes(memberName)) { wins.push(`<span class="text-indigo-600">${label}(+${score})</span>`); pts += score; }
                };
                checkWin(match.lg1, 'ë¦¬ê·¸ 1ë“±', scoreRules.lg1);
                checkWin(match.lg2, 'ë¦¬ê·¸ 2ë“±', scoreRules.lg2);
                checkWin(match.lg3, 'ë¦¬ê·¸ 3ë“±', scoreRules.lg3);
                checkWin(match.tm1, 'ë‹¨ì²´ 1ë“±', scoreRules.tm1);
                checkWin(match.tm2, 'ë‹¨ì²´ 2ë“±', scoreRules.tm2);
                checkWin(match.tm3, 'ë‹¨ì²´ 3ë“±', scoreRules.tm3);
                checkWin(match.tn1, 'í† ë„ˆ 1ë“±', scoreRules.tn1);
                checkWin(match.tn2, 'í† ë„ˆ 2ë“±', scoreRules.tn2);
                checkWin(match.tn3, 'í† ë„ˆ 3ë“±', scoreRules.tn3);
                checkWin(match.utn1, 'ìƒìœ„í† ë„ˆ 1ë“±', scoreRules.utn1 ?? 2.5);
                checkWin(match.utn2, 'ìƒìœ„í† ë„ˆ 2ë“±', scoreRules.utn2 ?? 2.0);
                checkWin(match.utn3, 'ìƒìœ„í† ë„ˆ 3ë“±', scoreRules.utn3 ?? 1.5);
                checkWin(match.ltn1, 'í•˜ìœ„í† ë„ˆ 1ë“±', scoreRules.ltn1 ?? 2.5);
                checkWin(match.ltn2, 'í•˜ìœ„í† ë„ˆ 2ë“±', scoreRules.ltn2 ?? 2.0);
                checkWin(match.ltn3, 'í•˜ìœ„í† ë„ˆ 3ë“±', scoreRules.ltn3 ?? 1.5);
                checkWin(match.db1, 'ë³µì‹ 1ë“±', scoreRules.db1);
                checkWin(match.db2, 'ë³µì‹ 2ë“±', scoreRules.db2);
                checkWin(match.db3, 'ë³µì‹ 3ë“±', scoreRules.db3); // ë³µì‹ 3ìœ„ ë¡œì§
                checkWin(match.ev1, 'ì´ë²¤íŠ¸ ìš°ìŠ¹', scoreRules.ev1);
                
                let attendStr = isLazy ? `ê¸°ë³¸ì°¸ì„(+${scoreRules.attend})` : `ê¸°ë³¸+ì„±ì‹¤(+${scoreRules.attend + scoreRules.sincerity})`;
                let winStr = wins.length > 0 ? ` | ${wins.join(', ')}` : '';
                html += `<li class="bg-white p-2 rounded border border-slate-200"><span class="font-extrabold text-slate-800 mr-2">${match.date}</span> ${attendStr}${winStr} <span class="float-right font-black text-indigo-700">= ${pts}ì </span></li>`;
            });
            if(memberMatches.length === 0) html += '<li class="text-slate-400">ì°¸ì„ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            html += '</ul></div>';
            
            contentTd.innerHTML = html;
            detailRow.classList.remove('hidden');
        }

        function renderMembersList() { 
            const list = document.getElementById('member-list-display'); 
            const activeCount = members.filter(m=>m.status !== 'inactive').length; 
            document.getElementById('total-members-count').innerText = `ì´ ${members.length}ëª… (í™œë™ ${activeCount}ëª…)`; 
            list.innerHTML = ''; 
            
            // ë“±ê¸‰ ì •ë ¬ì„ ìœ„í•œ ìš°ì„ ìˆœìœ„ ë§¤í•‘
            const typeOrder = { "ì—°íšŒì›": 1, "ì¤€íšŒì›": 2, "ë¹„íšŒì›": 3 };
            
            [...members].sort((a, b) => {
                // 1ìˆœìœ„: ë“±ê¸‰ (ì—°íšŒì› -> ì¤€íšŒì› -> ë¹„íšŒì› ìˆœ)
                let orderA = typeOrder[a.type] || 4;
                let orderB = typeOrder[b.type] || 4;
                if (orderA !== orderB) return orderA - orderB;
                
                // 2ìˆœìœ„: ë¶€ìˆ˜ ì˜¤ë¦„ì°¨ìˆœ
                if (a.handicap !== b.handicap) return a.handicap - b.handicap;
                
                // 3ìˆœìœ„: ì´ë¦„ ê°€ë‚˜ë‹¤ìˆœ
                return a.name.localeCompare(b.name);
            }).forEach(m => { 
                const adminButtons = isAdmin ? `<div class="flex gap-1 shrink-0 mt-2 sm:mt-0"><button onclick="event.stopPropagation(); editMember(${m.id})" class="px-3 py-1.5 bg-slate-100 text-slate-700 text-xs rounded-lg font-bold hover:bg-slate-200 btn-press">ìˆ˜ì •</button><button onclick="event.stopPropagation(); deleteMember(${m.id})" class="px-3 py-1.5 bg-red-50 text-red-600 text-xs rounded-lg font-bold hover:bg-red-100 btn-press">ì‚­ì œ</button></div>` : ''; 
                const photoHtml = m.photo ? `<img src="${escapeHTML(m.photo)}" class="w-11 h-11 rounded-full object-cover border border-slate-200 shadow-sm">` : `<div class="w-11 h-11 rounded-full default-avatar border border-slate-200 shadow-inner">ğŸ‘¤</div>`; 
                const infoStr = [m.affiliation, m.dept, m.rank].filter(Boolean).map(escapeHTML).join(' '); 
                const inactiveClass = m.status === 'inactive' ? 'member-inactive' : ''; 
                const badge = m.status === 'inactive' ? `<span class="text-[9px] bg-red-50 text-red-500 px-1.5 py-0.5 rounded font-extrabold ml-1 border border-red-100">íœ´ë©´</span>` : ''; 
                let phoneStr = m.phone ? escapeHTML(m.phone) : 'ë¯¸ì…ë ¥'; 
                let deptStr = m.dept ? escapeHTML(m.dept) : '-'; 
                let dutyStr = m.duty ? escapeHTML(m.duty) : '-'; 
                let rankStr = m.rank ? escapeHTML(m.rank) : '-'; 
                let typeStr = m.type ? escapeHTML(m.type) : '-'; 
                let genderStr = m.gender ? escapeHTML(m.gender) : '-'; 
                let detailsHtml = `<div id="member-info-${m.id}" class="hidden animate-fade-in mt-3 pt-3 border-t border-slate-100 w-full"><div class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100/50"><div class="grid grid-cols-2 gap-3 text-[11px]"><div><span class="block text-slate-400 font-bold mb-0.5">ğŸ“ ì—°ë½ì²˜</span><span class="font-extrabold text-slate-700">${phoneStr}</span></div><div><span class="block text-slate-400 font-bold mb-0.5">ğŸ¢ êµ¬ë¶„/ë¶€ì„œ</span><span class="font-extrabold text-slate-700">${escapeHTML(m.affiliation)} ${m.dept ? '> '+escapeHTML(m.dept) : ''}</span></div><div><span class="block text-slate-400 font-bold mb-0.5">ğŸ’¼ ì§ê¸‰/ì§ì±…</span><span class="font-extrabold text-slate-700">${rankStr}${m.duty ? ' ('+escapeHTML(m.duty)+')' : ''}</span></div><div><span class="block text-slate-400 font-bold mb-0.5">ğŸ·ï¸ ë“±ê¸‰/ì„±ë³„</span><span class="font-extrabold text-slate-700">${typeStr} / ${genderStr}</span></div></div></div></div>`; 
                list.innerHTML += `<li class="flex flex-col p-3.5 ${inactiveClass} hover:bg-slate-50 transition-colors border-b border-slate-50 cursor-pointer" onclick="toggleMemberInfo(${m.id})"><div class="flex justify-between items-center gap-3 flex-wrap sm:flex-nowrap w-full"><div class="flex items-center gap-3 flex-1">${photoHtml}<div><div class="flex items-center gap-1.5"><span class="font-extrabold text-slate-800 text-[13px]">${escapeHTML(m.name)}</span> <span class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-bold">${m.handicap}ë¶€</span>${badge}</div><div class="text-[11px] text-slate-400 mt-1 font-medium">${infoStr}</div></div></div>${adminButtons}</div>${detailsHtml}</li>`; 
            }); 
        }
        function editMember(id) { const member = members.find(m => m.id === id); if(!member) return; editingMemberId = id; document.getElementById('form-title').innerText = "âœï¸ íšŒì› ì •ë³´ ìˆ˜ì •"; document.getElementById('btn-save-member').innerText = "ìˆ˜ì • ì™„ë£Œ"; document.getElementById('btn-save-member').classList.replace('bg-slate-800', 'bg-indigo-600'); document.getElementById('btn-cancel-edit').classList.remove('hidden'); document.getElementById('mem-affiliation').value = member.affiliation || 'ì‹œ'; document.getElementById('mem-dept').value = member.dept || ''; document.getElementById('mem-type').value = member.type || 'ì—°íšŒì›'; document.getElementById('mem-duty').value = member.duty || ''; document.getElementById('mem-rank').value = member.rank || ''; document.getElementById('mem-name').value = member.name || ''; document.getElementById('mem-handicap').value = member.handicap || '5'; document.getElementById('mem-gender').value = member.gender || 'ë‚¨'; document.getElementById('mem-status').value = member.status || 'active'; document.getElementById('mem-phone').value = member.phone || ''; currentPhotoBase64 = member.photo || ''; if (currentPhotoBase64) { document.getElementById('photo-preview').src = currentPhotoBase64; document.getElementById('photo-preview').classList.remove('hidden'); document.getElementById('photo-placeholder').classList.add('hidden'); } else { document.getElementById('photo-preview').classList.add('hidden'); document.getElementById('photo-placeholder').classList.remove('hidden'); } document.getElementById('member-form-container').scrollIntoView({ behavior: 'smooth' }); }
        function saveMember() { const name = document.getElementById('mem-name').value; if(!name) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } const handicapVal = document.getElementById('mem-handicap').value; const memberData = { name: name, affiliation: document.getElementById('mem-affiliation').value, dept: document.getElementById('mem-dept').value, type: document.getElementById('mem-type').value, duty: document.getElementById('mem-duty').value, rank: document.getElementById('mem-rank').value, handicap: parseInt(handicapVal) || 5, gender: document.getElementById('mem-gender').value, phone: document.getElementById('mem-phone').value, photo: currentPhotoBase64, status: document.getElementById('mem-status').value }; if (editingMemberId !== null) { const index = members.findIndex(m => m.id === editingMemberId); if(index !== -1) members[index] = { ...members[index], ...memberData }; alert('íšŒì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'); } else { memberData.id = nextMemberId++; memberData.score = 0.0; memberData.prevRank = members.length + 1; members.push(memberData); alert('ì‹ ê·œ íšŒì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.'); } cancelEdit(); renderAll(); saveDataToStorage(); }
        function cancelEdit() { editingMemberId = null; document.getElementById('form-title').innerText = "íšŒì› ê°œë³„ ë“±ë¡"; document.getElementById('btn-save-member').innerText = "íšŒì› ì €ì¥í•˜ê¸°"; document.getElementById('btn-save-member').classList.replace('bg-indigo-600', 'bg-slate-800'); document.getElementById('btn-cancel-edit').classList.add('hidden'); ['mem-name','mem-dept','mem-duty','mem-rank','mem-phone'].forEach(id => document.getElementById(id).value = ''); document.getElementById('mem-affiliation').value = 'ì‹œ'; document.getElementById('mem-type').value = 'ì—°íšŒì›'; document.getElementById('mem-handicap').value = '5'; document.getElementById('mem-gender').value = 'ë‚¨'; document.getElementById('mem-status').value = 'active'; currentPhotoBase64 = ''; document.getElementById('photo-preview').classList.add('hidden'); document.getElementById('photo-placeholder').classList.remove('hidden'); document.getElementById('mem-photo').value = ''; }
        
        function handlePhotoUpload(event) { 
            const file = event.target.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                const img = new Image(); 
                img.onload = function() { 
                    const canvas = document.createElement('canvas'); 
                    const MAX_WIDTH = 80;  
                    const MAX_HEIGHT = 80; 
                    let width = img.width; 
                    let height = img.height; 
                    if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } } 
                    canvas.width = width; 
                    canvas.height = height; 
                    const ctx = canvas.getContext('2d'); 
                    ctx.drawImage(img, 0, 0, width, height); 
                    currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.5); 
                    document.getElementById('photo-preview').src = currentPhotoBase64; 
                    document.getElementById('photo-preview').classList.remove('hidden'); 
                    document.getElementById('photo-placeholder').classList.add('hidden'); 
                }; 
                img.src = e.target.result; 
            }; 
            reader.readAsDataURL(file); 
        }

        function deleteMember(id) { const mem = members.find(m=>m.id===id); if(confirm(`âš ï¸ [${mem.name}] íšŒì›ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { members = members.filter(m => m.id !== id); renderAll(); saveDataToStorage(); } }
        
        function saveMatch() { if(!formState.attend || formState.attend.length === 0) { alert("ìµœì†Œ 1ëª… ì´ìƒì˜ ì°¸ì„ìê°€ ì„ íƒë˜ì–´ì•¼ í•©ë‹ˆë‹¤."); return; } let clonedState = {}; for(let k in formState) { clonedState[k] = [...(formState[k] || [])]; } const matchData = { id: editingMatchId ? editingMatchId : nextMatchId++, date: document.getElementById('match-date').value || new Date().toISOString().substring(0, 10), type: document.getElementById('match-type').value || 'ì •ê¸°ëª¨ì„', ...clonedState }; if(editingMatchId) { const index = matchHistory.findIndex(m => m.id === editingMatchId); if(index !== -1) matchHistory[index] = matchData; alert('ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!'); } else { matchHistory.push(matchData); alert('ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!'); } editingMatchId = null; document.getElementById('input-form-title').innerText = "1. ëª¨ì„ ê¸°ë³¸ ì •ë³´ ì…ë ¥"; document.getElementById('input-step-1').classList.remove('hidden'); document.getElementById('input-step-2').classList.add('hidden'); initFormState(); renderAll(); saveDataToStorage(); switchTab('history'); }
        function openInputStep2() { const dateStr = document.getElementById('match-date').value; const typeStr = document.getElementById('match-type').value; document.getElementById('display-match-info').innerText = `${dateStr} | ${typeStr}`; document.getElementById('input-step-1').classList.add('hidden'); document.getElementById('input-step-2').classList.remove('hidden'); if(!editingMatchId) initFormState(); }
        function cancelInputStep2() { document.getElementById('input-step-1').classList.remove('hidden'); document.getElementById('input-step-2').classList.add('hidden'); if(editingMatchId) { editingMatchId = null; document.getElementById('input-form-title').innerText = "1. ëª¨ì„ ê¸°ë³¸ ì •ë³´ ì…ë ¥"; initFormState(); switchTab('history'); } }
        function editMatch(id) { const match = matchHistory.find(m => m.id === id); if(!match) return; editingMatchId = id; switchTab('input'); document.getElementById('input-form-title').innerText = "âœï¸ ëª¨ì„ ì •ë³´ ìˆ˜ì •"; document.getElementById('match-date').value = match.date; document.getElementById('match-type').value = match.type; for(let key in formState) { formState[key] = match[key] ? [...match[key]] : []; } updateFormUI(); document.getElementById('input-step-1').classList.remove('hidden'); document.getElementById('input-step-2').classList.add('hidden'); }
        function deleteMatch(id) { if(confirm("ì´ ê²½ê¸° ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ê²½ê¸°ë¡œ ì–»ì€ ì ìˆ˜ë“¤ì´ íšŒì›ë“¤ì˜ ì´ì ì—ì„œ ëª¨ë‘ ì°¨ê°ë©ë‹ˆë‹¤.")) { matchHistory = matchHistory.filter(m => m.id !== id); renderAll(); saveDataToStorage(); alert('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); } }
        
        // ìˆ˜ì •ë¨: ì¹´í†¡ ê³µì§€ ë‚´ìš©ì— ë³µì‹ 3ìœ„ ì¶”ê°€
        function openAnnouncement(id) { 
            const match = matchHistory.find(m => m.id === id); 
            if(!match) return; 
            let text = appConfig.announcePrefix.replace('{date}', match.date).replace('{type}', match.type); 
            text += `\n[ ğŸ‘¥ ì°¸ì„ì ëª…ë‹¨ - ì´ ${(match.attend||[]).length}ëª… ]\n`; 
            text += `${(match.attend||[]).join(', ')}\n`; 
            if(match.lazy && match.lazy.length > 0) { text += `\n[ ğŸš¨ ì§€ê°/ë¶ˆì„±ì‹¤ ]\n${(match.lazy||[]).join(', ')}\n`; } 
            let hasResults = false; 
            let resultText = `\n[ ğŸ† ê²½ê¸° ê²°ê³¼ ]\n`; 
            const addResult = (title, arr) => { if(arr && arr.length > 0) { resultText += `â–ªï¸ ${title} : ${arr.join(', ')}\n`; hasResults = true; } }; 
            addResult("ê°œì¸ì „ 1ìœ„", match.lg1); addResult("ê°œì¸ì „ 2ìœ„", match.lg2); addResult("ê°œì¸ì „ 3ìœ„", match.lg3); 
           addResult("ë‹¨ì²´ì „ 1ìœ„", match.tm1); addResult("ë‹¨ì²´ì „ 2ìœ„", match.tm2); addResult("ë‹¨ì²´ì „ 3ìœ„", match.tm3); 
            addResult("ê¸°ë³¸ í† ë„ˆ 1ìœ„", match.tn1); addResult("ê¸°ë³¸ í† ë„ˆ 2ìœ„", match.tn2); addResult("ê¸°ë³¸ í† ë„ˆ 3ìœ„", match.tn3); 
            addResult("ìƒìœ„ í† ë„ˆ 1ìœ„", match.utn1); addResult("ìƒìœ„ í† ë„ˆ 2ìœ„", match.utn2); addResult("ìƒìœ„ í† ë„ˆ 3ìœ„", match.utn3); 
            addResult("í•˜ìœ„ í† ë„ˆ 1ìœ„", match.ltn1); addResult("í•˜ìœ„ í† ë„ˆ 2ìœ„", match.ltn2); addResult("í•˜ìœ„ í† ë„ˆ 3ìœ„", match.ltn3);
            addResult("ë³µì‹ 1ìœ„", match.db1); addResult("ë³µì‹ 2ìœ„", match.db2); addResult("ë³µì‹ 3ìœ„", match.db3); // ì¶”ê°€ë¨
            addResult("ì´ë²¤íŠ¸ ìš°ìŠ¹", match.ev1); 
            if(hasResults) { text += resultText; } 
            text += '\n' + appConfig.announceSuffix; 
            document.getElementById('announcement-text').value = text; 
            document.getElementById('announcement-modal').classList.remove('hidden'); 
        }
        function closeAnnouncement() { document.getElementById('announcement-modal').classList.add('hidden'); }
        function copyAnnouncement() { const textToCopy = document.getElementById('announcement-text').value; if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(textToCopy).then(() => { alert('ì¹´ì¹´ì˜¤í†¡ìš© ê³µì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´í†¡ ëŒ€í™”ì°½ì— ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.'); }); } else { const textArea = document.getElementById('announcement-text'); textArea.select(); document.execCommand('copy'); alert('ì¹´ì¹´ì˜¤í†¡ìš© ê³µì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´í†¡ ëŒ€í™”ì°½ì— ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.'); } }
        function generateTeams() { if((formState.attend||[]).length < 2) { alert("ì¡°ë¥¼ í¸ì„±í•˜ë ¤ë©´ ë¨¼ì € [ì…ë ¥]íƒ­ì˜ [ì˜¤ëŠ˜ ì°¸ì„ì] ëª…ë‹¨ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; } let players = formState.attend.map(name => { const member = members.find(m => m.name === name); return { name: name, handicap: member ? member.handicap : 5 }; }); players.sort((a, b) => a.handicap - b.handicap); let teams = []; let left = 0; let right = players.length - 1; while(left < right) { teams.push([players[left], players[right]]); left++; right--; } if (left === right) { teams.push([players[left]]); } let resultHtml = `<div class="font-extrabold mb-4 text-indigo-900 border-b border-indigo-200/50 pb-3 text-center bg-white rounded-xl p-3 shadow-sm text-sm">ğŸ”¥ ì´ ${formState.attend.length}ëª… ì°¸ì—¬ / ${teams.length}ê°œ ì¡° í¸ì„± ì™„ë£Œ</div>`; teams.forEach((team, idx) => { const sumHandicap = team.reduce((sum, p) => sum + p.handicap, 0); const namesStr = team.map(p => `<span class="font-bold">${escapeHTML(p.name)}</span><span class="text-slate-400 font-normal">(${p.handicap})</span>`).join(' <span class="text-slate-300">+</span> '); resultHtml += `<div class="mb-2 bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm"><span class="font-black text-white bg-indigo-500 px-2 py-1 rounded-lg text-[11px] mr-2 shadow-sm">${idx+1}ì¡°</span> <span class="flex-1 text-right text-[13px] tracking-tight">${namesStr}</span> <span class="text-[10px] text-indigo-700 font-extrabold ml-3 bg-indigo-50 px-2 py-1 rounded-lg border border-indigo-100 whitespace-nowrap">í•© ${sumHandicap}ë¶€</span></div>`; }); document.getElementById('team-result-box').innerHTML = resultHtml; document.getElementById('team-maker-modal').classList.remove('hidden'); }
        function closeTeamMaker() { document.getElementById('team-maker-modal').classList.add('hidden'); }
        function copyTeams() { const tempDiv = document.createElement("div"); tempDiv.innerHTML = document.getElementById('team-result-box').innerHTML.replace(/<\/div>/g, '\n').replace(/<[^>]*>?/gm, ''); const textArea = document.createElement("textarea"); textArea.value = tempDiv.textContent || tempDiv.innerText || ""; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); alert('ì¡° í¸ì„± ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'); }
        function loadSettingsUI() { for (let key in scoreRules) { if(document.getElementById(`cfg-score-${key}`)) { document.getElementById(`cfg-score-${key}`).value = scoreRules[key]; } } document.getElementById('cfg-announce-prefix').value = appConfig.announcePrefix; document.getElementById('cfg-announce-suffix').value = appConfig.announceSuffix; document.getElementById('cfg-default-tab').value = appConfig.defaultTab; }
        function saveScoreRules() { for (let key in scoreRules) { let val = parseFloat(document.getElementById(`cfg-score-${key}`).value); if(!isNaN(val)) scoreRules[key] = val; } recalculateAllScores(); renderAll(); saveDataToStorage(); alert("ì ìˆ˜ ì²´ê³„ê°€ ì €ì¥ë˜ì—ˆìœ¼ë©°, ê³¼ê±° ê¸°ë¡ì´ ìƒˆ ê·œì¹™ì— ë§ê²Œ ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤."); }
        function saveUIConfig() { appConfig.announcePrefix = document.getElementById('cfg-announce-prefix').value; appConfig.announceSuffix = document.getElementById('cfg-announce-suffix').value; appConfig.defaultTab = document.getElementById('cfg-default-tab').value; saveDataToStorage(); alert("í™˜ê²½ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); }
        function changePassword() { const newPw = document.getElementById('cfg-password').value; if(newPw.trim() === '') { alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; } appConfig.password = newPw; document.getElementById('cfg-password').value = ''; saveDataToStorage(); alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); }
        
        // ==============================================================================
        // ğŸ—„ï¸ [ì‹œì¦Œ ì•„ì¹´ì´ë¸Œ] ìƒˆ ì‹œì¦Œ ì‹œì‘ ë° ê³¼ê±° ë°ì´í„° ì—´ëŒ ë¡œì§
        // ==============================================================================
        function startNewSeason() { 
            const seasonName = document.getElementById('cfg-season-name').value.trim();
            if (!seasonName) { alert("ë³´ê´€í•  ì‹œì¦Œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            
            if(confirm(`í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë°ì´í„°ë¥¼ '${seasonName}'(ìœ¼)ë¡œ ë³´ê´€í•˜ê³ \nëª¨ë“  ì ìˆ˜ì™€ ê¸°ë¡ì„ 0ì ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì—¬ ìƒˆ ì‹œì¦Œì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { 
                let finalMembers = JSON.parse(JSON.stringify(members.filter(m => m.status !== 'inactive' && m.type === 'ì—°íšŒì›' && m.score > 0)));
                
                appConfig.pastSeasons.push({
                    seasonName: seasonName,
                    date: new Date().toISOString().substring(0, 10),
                    members: finalMembers,
                    matchHistory: JSON.parse(JSON.stringify(matchHistory)) // ê²½ê¸° ê¸°ë¡ 100% ë”¥ì¹´í”¼ ë°±ì—…
                });

                matchHistory = []; 
                members.forEach(m => { 
                    m.score = 0; m.prevRank = 1; m.currentRank = 1; 
                    m.attendCount = 0; m.sincereCount = 0;
                    m.win1Count = 0; m.win2Count = 0; m.win3Count = 0;
                }); 
                
                document.getElementById('cfg-season-name').value = '';
                
                saveDataToStorage(); 
                renderAll(); 
                alert(`ìƒˆ ì‹œì¦Œì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!\nê³¼ê±° ê¸°ë¡ì€ [ìˆœìœ„] ë° [ê¸°ë¡] íƒ­ì—ì„œ '${seasonName}'(ìœ¼)ë¡œ ì—´ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`); 
                switchTab('ranking'); 
            } 
        }

        function renderSeasonDropdown() {
            const rSelector = document.getElementById('season-selector');
            const hSelector = document.getElementById('history-season-selector');
            
            let html = `<option value="current">ğŸ“ í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì‹œì¦Œ</option>`;
            if (appConfig.pastSeasons && appConfig.pastSeasons.length > 0) {
                [...appConfig.pastSeasons].reverse().forEach((season, index) => {
                    let originalIndex = appConfig.pastSeasons.length - 1 - index;
                    html += `<option value="${originalIndex}">ğŸ—„ï¸ ${escapeHTML(season.seasonName)}</option>`;
                });
            }
            if (rSelector) {
                let currentVal = rSelector.value;
                rSelector.innerHTML = html;
                rSelector.value = currentVal || "current";
            }
            if (hSelector) {
                let currentVal = hSelector.value;
                hSelector.innerHTML = html;
                hSelector.value = currentVal || "current";
            }
        }
function renderPastSeasonList() {
            const listContainer = document.getElementById('past-season-list');
            if (!listContainer) return;
            
            // ë³´ê´€ëœ ì‹œì¦Œì´ ì—†ì„ ê²½ìš° ë¹ˆ ìƒíƒœ í‘œì‹œ
            if (!appConfig.pastSeasons || appConfig.pastSeasons.length === 0) {
                listContainer.innerHTML = '<div class="text-sm text-slate-400 font-medium text-center py-5 bg-slate-50 rounded-xl border border-dashed border-slate-200">ë³´ê´€ëœ ê³¼ê±° ì‹œì¦Œì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let html = '';
            // ìµœê·¼ ë³´ê´€ëœ ì‹œì¦Œì´ ìœ„ë¡œ ì˜¤ë„ë¡ ì—­ìˆœìœ¼ë¡œ ë Œë”ë§í•˜ë˜, ë°ì´í„° ì‚­ì œë¥¼ ìœ„í•´ ì›ë³¸ ë°°ì—´ì˜ indexë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
            appConfig.pastSeasons.map((season, index) => ({ season, index })).reverse().forEach(item => {
                html += `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-200 transition-colors hover:bg-slate-100">
                    <span class="font-extrabold text-slate-700 text-sm">
                        ${escapeHTML(item.season.seasonName)} 
                        <span class="text-[11px] text-slate-400 font-normal ml-1 bg-white px-1.5 py-0.5 rounded shadow-sm border border-slate-100">${item.season.date}</span>
                    </span>
                    <button onclick="deletePastSeason(${item.index})" class="text-[11px] bg-white text-red-500 border border-red-200 hover:bg-red-50 px-3 py-1.5 rounded-lg font-bold transition-colors btn-press shadow-sm flex items-center gap-1">
                        âŒ ì‚­ì œ
                    </button>
                </div>
                `;
            });
            listContainer.innerHTML = html;
        }

        // ê³¼ê±° ì‹œì¦Œ ì‚­ì œ ë¡œì§ (ê²½ê³ ì°½, ë°ì´í„° ì‚­ì œ, ì¦‰ì‹œ ë™ê¸°í™” ë° ì˜ˆì™¸ ì²˜ë¦¬ í¬í•¨)
        function deletePastSeason(index) {
            if (confirm("ì •ë§ ì´ ì‹œì¦Œ ê¸°ë¡ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                // 1. ë°ì´í„° ì‚­ì œ ë° ì €ì¥ (Firebase ë° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™”)
                appConfig.pastSeasons.splice(index, 1);
                saveDataToStorage();
                
                // 2. UI ì¦‰ì‹œ ë™ê¸°í™”
                renderPastSeasonList(); // [ì„¤ì •] íƒ­ì˜ ì‹œì¦Œ ê´€ë¦¬ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
                renderSeasonDropdown(); // [ìˆœìœ„], [ê¸°ë¡] íƒ­ì˜ ì‹œì¦Œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìƒˆë¡œê³ ì¹¨
                
                // 3. ì˜ˆì™¸ ì²˜ë¦¬ ë°©ì–´ ë¡œì§
                // ë°°ì—´ ì¸ë±ìŠ¤ê°€ ë°€ë¦¬ê¸° ë•Œë¬¸ì—, ë§Œì•½ ì‚¬ìš©ìê°€ [ìˆœìœ„]ë‚˜ [ê¸°ë¡] íƒ­ì—ì„œ ê³¼ê±° ì‹œì¦Œì„ ì¡°íšŒ ì¤‘ì´ì—ˆë‹¤ë©´ ì—ëŸ¬ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ê°•ì œë¡œ 'í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì‹œì¦Œ'ìœ¼ë¡œ ë³µê·€ì‹œí‚µë‹ˆë‹¤.
                const rankingSelector = document.getElementById('season-selector');
                const historySelector = document.getElementById('history-season-selector');
                
                if (rankingSelector && rankingSelector.value !== "current") {
                    rankingSelector.value = "current";
                }
                if (historySelector && historySelector.value !== "current") {
                    historySelector.value = "current";
                }
                
                // 4. ê°•ì œ ë³µê·€ëœ ìƒíƒœì— ë§ì¶° í™”ë©´ ì¬ì¶œë ¥
                renderRanking();
                renderHistory();
                
                alert("ì„ íƒí•œ ê³¼ê±° ì‹œì¦Œì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }
        // ìˆ˜ì •ë¨: ê¸°ë¡ íƒ­ ë±ƒì§€ì— ë³µì‹ 3ìœ„ ì ìš©
        function renderHistory() { 
            const selector = document.getElementById('history-season-selector');
            const mode = selector ? selector.value : "current";
            const list = document.getElementById('match-history-list'); 
            const adminTh = document.getElementById('history-admin-th');
            list.innerHTML = ''; 

            let displayHistory = [];
            let isPastSeason = mode !== "current";

            if (isPastSeason) {
                const seasonIndex = parseInt(mode);
                displayHistory = appConfig.pastSeasons[seasonIndex].matchHistory || [];
                if(adminTh) adminTh.classList.add('hidden');
            } else {
                displayHistory = matchHistory;
                if(adminTh) adminTh.classList.remove('hidden');
            }

            if(displayHistory.length === 0) { 
                list.innerHTML = `<tr><td colspan="3" class="text-center py-16"><div class="text-5xl mb-4 drop-shadow-sm opacity-80">ğŸ“</div><p class="font-extrabold text-slate-700 text-base">ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p></td></tr>`; 
                return; 
            } 
            
            [...displayHistory].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)).forEach(match => { 
                let winHtml = ''; 
                const addBadge = (arr, label, bgClass) => { 
                    if(arr && arr.length > 0) { winHtml += `<div class="flex items-start gap-1.5 mb-1.5"><span class="shrink-0 text-[10px] font-extrabold text-white ${bgClass} px-1.5 py-0.5 rounded shadow-sm text-center">${label}</span> <span class="text-slate-700 font-bold text-[12px] break-keep leading-tight pt-0.5">${arr.map(escapeHTML).join(', ')}</span></div>`; } 
                }; 
               addBadge(match.lg1, 'ğŸ… ë¦¬ê·¸ì „ 1ìœ„', 'bg-indigo-600'); 
                addBadge(match.lg2, 'ğŸ¥ˆ ë¦¬ê·¸ì „ 2ìœ„', 'bg-indigo-500'); 
                addBadge(match.lg3, 'ğŸ¥‰ ë¦¬ê·¸ì „ 3ìœ„', 'bg-indigo-400'); 
                
                addBadge(match.tm1, 'ğŸ¥‡ ë‹¨ì²´ì „ 1ìœ„', 'bg-teal-600'); 
                addBadge(match.tm2, 'ğŸ¥ˆ ë‹¨ì²´ì „ 2ìœ„', 'bg-teal-500'); 
                addBadge(match.tm3, 'ğŸ¥‰ ë‹¨ì²´ì „ 3ìœ„', 'bg-teal-400'); 
                
                // ê¸°ì¡´ ê¸°ë¡ íƒ­ì—ì„œ ëˆ„ë½ë˜ì—ˆë˜ ê¸°ë³¸ í† ë„ˆë¨¼íŠ¸(tn) ë Œë”ë§ ë³µêµ¬
                addBadge(match.tn1, 'ğŸ¥‡ ê¸°ë³¸ í† ë„ˆë¨¼íŠ¸ 1ìœ„', 'bg-blue-600'); 
                addBadge(match.tn2, 'ğŸ¥ˆ ê¸°ë³¸ í† ë„ˆë¨¼íŠ¸ 2ìœ„', 'bg-blue-500'); 
                addBadge(match.tn3, 'ğŸ¥‰ ê¸°ë³¸ í† ë„ˆë¨¼íŠ¸ 3ìœ„', 'bg-blue-400'); 

                addBadge(match.utn1, 'ğŸ† ìƒìœ„ í† ë„ˆë¨¼íŠ¸ 1ìœ„', 'bg-purple-600'); 
                addBadge(match.utn2, 'ğŸ¥ˆ ìƒìœ„ í† ë„ˆë¨¼íŠ¸ 2ìœ„', 'bg-purple-500'); 
                addBadge(match.utn3, 'ğŸ¥‰ ìƒìœ„ í† ë„ˆë¨¼íŠ¸ 3ìœ„', 'bg-purple-400');          
                
                addBadge(match.ltn1, 'ğŸ† í•˜ìœ„ í† ë„ˆë¨¼íŠ¸ 1ìœ„', 'bg-fuchsia-600'); 
                addBadge(match.ltn2, 'ğŸ¥ˆ í•˜ìœ„ í† ë„ˆë¨¼íŠ¸ 2ìœ„', 'bg-fuchsia-500'); 
                addBadge(match.ltn3, 'ğŸ¥‰ í•˜ìœ„ í† ë„ˆë¨¼íŠ¸ 3ìœ„', 'bg-fuchsia-400'); 
                
                addBadge(match.db1, 'ğŸ¥‡ ë³µì‹ì „ 1ìœ„', 'bg-pink-600'); 
                addBadge(match.db2, 'ğŸ¥ˆ ë³µì‹ì „ 2ìœ„', 'bg-pink-500'); 
                addBadge(match.db3, 'ğŸ¥‰ ë³µì‹ì „ 3ìœ„', 'bg-pink-400'); 
                
                addBadge(match.ev1, 'ğŸ‰ ì´ë²¤íŠ¸ 1ìœ„', 'bg-amber-500');
                
                if(!winHtml) winHtml = '<div class="text-[11px] text-slate-400 font-medium py-1">ì…ìƒ ê¸°ë¡ ì—†ìŒ</div>'; 
                let lazyHtml = ''; 
                if(match.lazy && match.lazy.length > 0) { lazyHtml = `<div class="mt-2 pt-2 border-t border-slate-200/60 flex items-start gap-1"><span class="shrink-0 text-[10px] font-extrabold text-red-500 mr-0.5 mt-0.5">ğŸš¨ ë¶ˆì„±ì‹¤</span><span class="text-[11px] text-slate-600 font-bold leading-tight pt-0.5">${match.lazy.map(escapeHTML).join(', ')}</span></div>`; } 
                
                const adminButtons = isPastSeason ? '' : `<td class="px-2 py-4 admin-only-table-cell align-middle w-14"><div class="flex flex-col gap-1.5 items-center"><button onclick="openAnnouncement(${match.id})" class="w-full px-2 py-1.5 bg-indigo-50 text-indigo-700 text-[10px] rounded-lg border border-indigo-100 hover:bg-indigo-100 font-extrabold shadow-sm btn-press">ê³µì§€</button><button onclick="editMatch(${match.id})" class="w-full px-2 py-1.5 bg-white text-slate-600 text-[10px] rounded-lg border border-slate-200 hover:bg-slate-50 font-extrabold shadow-sm btn-press">ìˆ˜ì •</button><button onclick="deleteMatch(${match.id})" class="w-full px-2 py-1.5 bg-red-50 text-red-600 text-[10px] rounded-lg border border-red-100 hover:bg-red-100 font-extrabold shadow-sm btn-press">ì‚­ì œ</button></div></td>`; 
                let displayDate = match.date ? escapeHTML(match.date.substring(5)) : 'ë¯¸ì •'; 
                
                list.innerHTML += `<tr class="bg-white hover:bg-slate-50 border-b border-slate-100 transition-colors"><td class="px-2 py-4 text-center align-top whitespace-nowrap pt-5"><div class="font-extrabold text-slate-800 text-[13px]">${displayDate}</div><div class="text-[10px] mt-1.5"><span class="bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200 font-bold">${escapeHTML(match.type) || ''}</span></div></td><td class="px-2 py-4 text-left align-top"><div class="bg-slate-50 p-3 rounded-xl border border-slate-100 mb-2 shadow-inner"><div class="flex justify-between items-center mb-1.5"><span class="text-[10px] font-black text-slate-500">âœ… ì°¸ì„ì ëª…ë‹¨</span><span class="text-[10px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded font-bold">${(match.attend || []).length}ëª…</span></div><div class="text-[11px] text-slate-700 font-medium leading-relaxed break-keep">${(match.attend || []).map(escapeHTML).join(', ')}</div>${lazyHtml}</div><div class="bg-indigo-50/40 p-3 rounded-xl border border-indigo-50"><div class="text-[10px] font-black text-indigo-800 mb-2.5">ğŸ† ì…ìƒ ë‚´ì—­</div><div class="flex flex-col">${winHtml}</div></div></td>${adminButtons}</tr>`; 
            }); 
        }

        function downloadRankingExcel() { 
            try { 
                const selector = document.getElementById('season-selector');
                const isPastSeason = selector && selector.value !== "current";
                let targetMembers = [];
                let fileNameStr = "í˜„ì¬_ë­í‚¹";

                if (isPastSeason) {
                    const season = appConfig.pastSeasons[parseInt(selector.value)];
                    targetMembers = season.members;
                    fileNameStr = season.seasonName;
                } else {
                    targetMembers = members.filter(m => m.status !== 'inactive');
                }

                if(targetMembers.length === 0) return; 
                const data = targetMembers.map(m => ({"ìˆœìœ„": m.currentRank, "ì´ë¦„": m.name, "ë¶€ìˆ˜": m.handicap + "ë¶€", "ì†Œì†": m.affiliation, "ì´ì ": (m.score||0).toFixed(1), "ì—°ë½ì²˜": m.phone || "-"})); 
                const wb = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), fileNameStr); 
                XLSX.writeFile(wb, `íƒêµ¬ë¦¬ê·¸_${fileNameStr}_${new Date().toISOString().substring(0,10)}.xlsx`); 
            } catch(e) { alert("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"); } 
        }
        
// 2. ì ìˆ˜ í•©ì‚° ë¡œì§(recalculateAllScores)ì˜ ì² ì €í•œ ë°©ì–´ ì½”ë“œ
        function recalculateAllScores() { 
            members.forEach(m => {
                m.score = 0;
                m.attendCount = 0;
                m.sincereCount = 0;
                m.win1Count = 0;
                m.win2Count = 0;
                m.win3Count = 0;
            });
            const sortedMatches = [...matchHistory].sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0)); 
            if (sortedMatches.length === 0) { members.forEach(m => { m.prevRank = 1; m.currentRank = 1; }); return; } 
            
            sortedMatches.forEach((match, index) => { 
                const addScoreAndCount = (nameArr, points, place) => {
                    // ì „ë‹¬ë°›ì€ ì ìˆ˜ê°€ ìœ íš¨í•œ ìˆ«ìì¸ì§€ ì²´í¬í•˜ê³  ì•„ë‹ ê²½ìš° 0ìœ¼ë¡œ Fallback
                    let validPoints = Number(points) || 0;

                    (nameArr || []).forEach(name => {
                        const m = members.find(x => x.name === name);
                        if(m && m.type === 'ì—°íšŒì›') {
                            m.score += validPoints;
                            
                            // ìµœí›„ì˜ ì•ˆì „ì¥ì¹˜: í˜¹ì‹œë¼ë„ m.score ì—°ì‚° ê²°ê³¼ê°€ NaNì´ ë  ê²½ìš° ì¦‰ì‹œ 0ìœ¼ë¡œ ë¦¬ì…‹
                            if (isNaN(m.score)) m.score = 0;
                            
                            if(place === 1) m.win1Count = (m.win1Count || 0) + 1;
                            if(place === 2) m.win2Count = (m.win2Count || 0) + 1;
                            if(place === 3) m.win3Count = (m.win3Count || 0) + 1;
                        }
                    });
                };

                (match.attend || []).forEach(name => { 
                    const m = members.find(x => x.name === name); 
                    if(m && m.type === 'ì—°íšŒì›') { 
                        m.score += (Number(scoreRules.attend) || 0); 
                        if (isNaN(m.score)) m.score = 0;
                        m.attendCount = (m.attendCount || 0) + 1;
                        if(!(match.lazy || []).includes(name)) {
                            m.score += (Number(scoreRules.sincerity) || 0); 
                            if (isNaN(m.score)) m.score = 0;
                            m.sincereCount = (m.sincereCount || 0) + 1;
                        }
                    } 
                }); 
                
                addScoreAndCount(match.lg1, scoreRules.lg1, 1); 
                addScoreAndCount(match.lg2, scoreRules.lg2, 2); 
                addScoreAndCount(match.lg3, scoreRules.lg3, 3); 
                addScoreAndCount(match.tm1, scoreRules.tm1, 1); 
                addScoreAndCount(match.tm2, scoreRules.tm2, 2); 
                addScoreAndCount(match.tm3, scoreRules.tm3, 3); 
                addScoreAndCount(match.tn1, scoreRules.tn1, 1); 
                addScoreAndCount(match.tn2, scoreRules.tn2, 2); 
                addScoreAndCount(match.tn3, scoreRules.tn3, 3); 
                addScoreAndCount(match.utn1, scoreRules.utn1 ?? 2.5, 1); 
                addScoreAndCount(match.utn2, scoreRules.utn2 ?? 2.0, 2); 
                addScoreAndCount(match.utn3, scoreRules.utn3 ?? 1.5, 3); 
                addScoreAndCount(match.ltn1, scoreRules.ltn1 ?? 2.5, 1); 
                addScoreAndCount(match.ltn2, scoreRules.ltn2 ?? 2.0, 2); 
                addScoreAndCount(match.ltn3, scoreRules.ltn3 ?? 1.5, 3);
                addScoreAndCount(match.db1, scoreRules.db1, 1); 
                addScoreAndCount(match.db2, scoreRules.db2, 2); 
                // ë³µì‹ 3ìœ„ë¥¼ ë”í•  ë•Œ Fallback(1.0) ê°’ì„ ëª…ì‹œí•˜ì—¬ ì ˆëŒ€ undefinedê°€ ë„˜ì–´ê°€ì§€ ì•Šê²Œ ë°©ì–´
                addScoreAndCount(match.db3, scoreRules.db3 ?? 1.0, 3); 
                addScoreAndCount(match.ev1, scoreRules.ev1, 1); 
                
                if (index === sortedMatches.length - 2) { 
                    const tempSort = [...members].filter(m => m.type === 'ì—°íšŒì›').sort((a, b) => b.score - a.score); 
                    for (let i = 0; i < tempSort.length; i++) { 
                        if (i > 0 && tempSort[i].score === tempSort[i-1].score) tempSort[i].prevRank = tempSort[i-1].prevRank; 
                        else tempSort[i].prevRank = i + 1; 
                    } 
                } 
            }); 
            members.sort((a, b) => b.score - a.score); 
            let annualMembers = members.filter(m => m.type === 'ì—°íšŒì›'); 
            annualMembers.sort((a, b) => b.score - a.score); 
            for(let i=0; i<annualMembers.length; i++) { 
                if (i > 0 && annualMembers[i].score === annualMembers[i-1].score) annualMembers[i].currentRank = annualMembers[i-1].currentRank; 
                else annualMembers[i].currentRank = i + 1; 
            } 
            members.forEach(m => { if(m.type !== 'ì—°íšŒì›') m.currentRank = '-'; }); 
            if (sortedMatches.length === 1) { members.forEach(m => m.prevRank = m.currentRank); } 
        }
        
     function renderRanking() { 
    const selector = document.getElementById('season-selector');
    const mode = selector ? selector.value : "current";
    const tbody = document.getElementById('ranking-table-body'); 
    const instruction = document.getElementById('ranking-instruction');
    
    tbody.innerHTML = ''; 
    
    let displayMembers = [];
    let displayHistory = []; // ê¸°ì¤€ì¼ ì¶”ì¶œì„ ìœ„í•œ ê²½ê¸° ê¸°ë¡ ë°°ì—´
    let isPastSeason = mode !== "current";

    // 1. ìƒíƒœ ë° íƒ€ê²Ÿ ë°ì´í„° ê²°ì •
    if (isPastSeason) {
        const seasonIndex = parseInt(mode);
        if (appConfig.pastSeasons && appConfig.pastSeasons[seasonIndex]) {
            displayMembers = appConfig.pastSeasons[seasonIndex].members;
            displayHistory = appConfig.pastSeasons[seasonIndex].matchHistory || []; 
        }
        instruction.innerText = "ğŸ”’ ê³¼ê±° ì‹œì¦Œ (ì¡°íšŒ ì „ìš©)";
        instruction.className = "text-[11px] text-slate-500 font-bold bg-slate-100 backdrop-blur-sm px-2.5 py-1.5 rounded-lg border border-slate-200 shadow-sm";
    } else {
        displayMembers = members.filter(m => m.status !== 'inactive' && m.type === 'ì—°íšŒì›' && m.score > 0);
        displayHistory = matchHistory; 
        instruction.innerText = "ğŸ‘† ì´ë¦„ì„ í„°ì¹˜í•˜ë©´ ìƒì„¸ê¸°ë¡";
        instruction.className = "text-[11px] text-indigo-600 font-bold bg-white/80 backdrop-blur-sm px-2.5 py-1.5 rounded-lg border border-indigo-100 shadow-sm transition-all";
    }

    // --- 2. ê¸°ì¤€ì¼ ì¶”ì¶œ ë° UI ë™ì  ì£¼ì… ë¡œì§ ì‹œì‘ ---
    let referenceDateText = "ê¸°ë¡ ì—†ìŒ";
    if (displayHistory && displayHistory.length > 0) {
        // matchHistory ë°°ì—´ì—ì„œ date ê°’ë§Œ ë½‘ì•„ë‚´ì–´ ë‚´ë¦¼ì°¨ìˆœ(ìµœì‹ ìˆœ)ìœ¼ë¡œ ì •ë ¬ í›„ ê°€ì¥ ì²« ë²ˆì§¸ ê°’(ê°€ì¥ ìµœê·¼ ë‚ ì§œ) íšë“
        let latestDate = displayHistory.map(m => m.date).filter(Boolean).sort().reverse()[0];
        if (latestDate) {
            let parts = latestDate.split('-');
            if (parts.length === 3) {
                // '0' ì œê±° í¬ë§·íŒ…: 2026-01-17 -> 2026.1.17.
                referenceDateText = `${parts[0]}.${parseInt(parts[1], 10)}.${parseInt(parts[2], 10)}.`;
            } else {
                referenceDateText = latestDate;
            }
        }
    }
    
    // ìˆœìœ„í‘œ ìœ„ instruction ì˜ì—­ì˜ DOM êµ¬ì¡°ë¥¼ í”Œë ‰ìŠ¤(Flex)ë¡œ ë°”ê¾¸ê³  ê¸°ì¤€ì¼ì„ ì™¼ìª½ì— ì‚½ì…
    let refDateEl = document.getElementById('ranking-reference-date');
    if (!refDateEl) {
        const instructionContainer = instruction.parentElement; // div.mb-2.px-1.text-right
        instructionContainer.classList.remove('text-right');
        instructionContainer.classList.add('flex', 'justify-between', 'items-center');
        
        refDateEl = document.createElement('span');
        refDateEl.id = 'ranking-reference-date';
        // Tailwind CSS ì ìš©
        refDateEl.className = 'text-[10px] text-slate-500 font-bold tracking-tight bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-100 shadow-sm';
        instructionContainer.insertBefore(refDateEl, instructionContainer.firstChild);
    }
    refDateEl.innerText = `ê¸°ì¤€ì¼(${referenceDateText})`;
    // --- ê¸°ì¤€ì¼ ë¡œì§ ë ---

    // 3. ìˆœìœ„ í…Œì´ë¸” ë Œë”ë§
    if(displayMembers.length === 0) { 
        tbody.innerHTML = `<tr><td colspan="8" class="py-16 text-center"><div class="text-5xl mb-4 drop-shadow-sm">ğŸ“­</div><p class="font-extrabold text-slate-700 text-base">ì ìˆ˜ê°€ ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</p><p class="text-xs mt-2 text-slate-400">ê²½ê¸°ë¥¼ ì§„í–‰í•˜ë©´ ìˆœìœ„ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p></td></tr>`; 
        return; 
    } 

    displayMembers.sort((a, b) => b.score - a.score);
    
    displayMembers.forEach((m, index) => { 
        let rankDisplay = m.currentRank; 
        
        if (m.currentRank === 1) {
            rankDisplay = `<div class="w-7 h-7 mx-auto bg-gradient-to-br from-yellow-300 to-yellow-500 text-white rounded-full flex items-center justify-center font-extrabold shadow-[0_2px_10px_rgba(234,179,8,0.4)]">1</div>`; 
        } else if (m.currentRank === 2) {
            rankDisplay = `<div class="w-6 h-6 mx-auto bg-gradient-to-br from-slate-300 to-slate-400 text-white rounded-full flex items-center justify-center font-bold shadow-[0_2px_10px_rgba(148,163,184,0.4)]">2</div>`; 
        } else if (m.currentRank === 3) {
            rankDisplay = `<div class="w-6 h-6 mx-auto bg-gradient-to-br from-orange-400 to-orange-600 text-white rounded-full flex items-center justify-center font-bold shadow-[0_2px_10px_rgba(234,88,12,0.4)]">3</div>`; 
        } else if (index > 0 && displayMembers[index-1].currentRank === m.currentRank) {
            // ë™ë¥ (Tie) ì²˜ë¦¬: ì´ì „ íšŒì›ê³¼ ìˆœìœ„ê°€ ê°™ìœ¼ë©´ '-' í‘œì‹œ (4~10ìœ„ êµ¬ê°„ ë™ë¥  ì‹œì—ë„ ìš°ì„  ì ìš©)
            rankDisplay = `<span class="text-slate-300 font-medium">-</span>`; 
        } else if (m.currentRank >= 4 && m.currentRank <= 10) {
            // 4~10ìœ„: Top 10 ì „ìš© ë‘¥ê·¼ ë„¤ëª¨ ë±ƒì§€ ìŠ¤íƒ€ì¼
            rankDisplay = `<div class="w-6 h-6 mx-auto bg-indigo-50 border border-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center font-bold shadow-sm">${m.currentRank}</div>`;
        } else {
            // 11ìœ„ ì´í•˜: ì¼ë°˜ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼
            rankDisplay = `<span class="text-slate-500 font-extrabold">${m.currentRank}</span>`; 
        }
        
        let rankDiff = (m.prevRank === '-' || m.currentRank === '-') ? 0 : m.prevRank - m.currentRank; 
        let rankIcon = rankDiff > 0 ? `<span class="text-red-500">â–² ${rankDiff}</span>` : rankDiff < 0 ? `<span class="text-blue-500">â–¼ ${Math.abs(rankDiff)}</span>` : `<span class="text-slate-300">-</span>`; 
        
        let clickEvent = isPastSeason ? "" : `onclick="toggleMemberDetail(${m.id})"`;
        let hoverClass = isPastSeason ? "" : "hover:bg-indigo-50/50 cursor-pointer";

        tbody.innerHTML += `<tr class="bg-white ${hoverClass} transition-colors border-b border-slate-50" ${clickEvent}>
            <td class="px-0.5 py-3 text-center align-middle">${rankDisplay}</td>
            <td class="px-1 py-3 text-slate-800 font-extrabold text-[12px] whitespace-nowrap">${escapeHTML(m.name)}<span class="text-[9px] text-slate-400 font-medium ml-0.5 bg-slate-50 px-1 rounded">${m.handicap}ë¶€</span></td>
            <td class="px-1 py-3 text-center text-[11px] font-bold text-slate-600">${m.attendCount || 0}</td>
            <td class="px-1 py-3 text-center text-[11px] font-bold text-yellow-600">${m.win1Count || 0}</td>
            <td class="px-1 py-3 text-center text-[11px] font-bold text-slate-400">${m.win2Count || 0}</td>
            <td class="px-1 py-3 text-center text-[11px] font-bold text-orange-500">${m.win3Count || 0}</td>
            <td class="px-1 py-3 text-right font-black text-indigo-600 text-[13px] tracking-tight">${(m.score||0).toFixed(1)}</td>
            <td class="px-1 py-3 text-center text-[10px] font-extrabold">${rankIcon}</td>
        </tr>`;

        if (!isPastSeason) {
            tbody.innerHTML += `<tr id="detail-row-${m.id}" class="hidden detail-row"><td colspan="8" class="p-0 border-0" id="detail-content-${m.id}"></td></tr>`; 
        }
    }); 
}
        function renderAll() { 
            renderSeasonDropdown(); 
            recalculateAllScores(); 
            renderRanking(); 
            renderHistory(); 
            renderMembersList(); 
            renderPastSeasonList(); // ğŸ‘ˆ ì´ ì¤„ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
        }
        
        // ì´ˆê¸°í™”
        generateGroupSizeInputs(); 
        loadDataFromStorage();
    </script>
</body>
</html>













