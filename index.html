<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인천광역시 탁구동호회 토요리그</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;700;800;900&display=swap');
        body { font-family: 'Pretendard', -apple-system, sans-serif; background-color: #f1f5f9; letter-spacing: -0.02em; }
        ::-webkit-scrollbar { width: 4px; height: 4px; background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        body:not(.admin-mode-active) .admin-only { display: none !important; }
        body:not(.admin-mode-active) .admin-only-table-cell { display: none !important; }
        .member-inactive { opacity: 0.5; filter: grayscale(100%); }

        .tab-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-active { color: #4f46e5 !important; font-weight: 800; transform: translateY(-4px); }
        .tab-active::after { content: ''; position: absolute; bottom: -4px; width: 4px; height: 4px; background-color: #4f46e5; border-radius: 50%; }
        
        .btn-press { transition: transform 0.15s ease, box-shadow 0.15s ease; }
        .btn-press:active { transform: scale(0.96); box-shadow: none !important; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }

        .name-chip { display: inline-flex; align-items: center; background-color: #e0e7ff; color: #4338ca; font-size: 0.75rem; font-weight: bold; padding: 0.25rem 0.6rem; border-radius: 9999px; margin: 0.15rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .name-chip-empty { color: #9ca3af; font-size: 0.75rem; font-weight: 500; padding: 0.25rem; }
        
        .diagonal-strike { background: linear-gradient(to top right, transparent calc(50% - 1px), #cbd5e1, transparent calc(50% + 1px)); background-color: #e2e8f0; }
        
        .tourn-node { position: relative; }
        .tourn-node::after { content: ''; position: absolute; background-color: #94a3b8; z-index: 0; }
        .border-r-line { border-right: 2px solid #94a3b8; }
        .border-t-line { border-top: 2px solid #94a3b8; }
        .border-b-line { border-bottom: 2px solid #94a3b8; }

        /* 📸 캡처 모드 테두리 강화 개선 */
        .capture-mode { background: white !important; padding: 10px; border-radius: 0; }
        .capture-mode table, .capture-mode th, .capture-mode td { border: 2px solid #1e293b !important; }
        .capture-mode input { display: none !important; }
        .capture-mode .capture-text { display: block !important; width: 100%; height: 100%; text-align: center; color: #1e293b; font-weight: 800; font-size: 13px; }
        .capture-text { display: none; }
        
        /* 아코디언 관련 */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="mx-auto bg-slate-50 min-h-screen shadow-2xl relative pb-28 overflow-x-hidden transition-all duration-300 max-w-md" id="app-body">

    <header class="bg-gradient-to-r from-blue-700 to-indigo-600 p-4 text-white flex justify-between items-center relative z-20 shadow-md rounded-b-[2.5rem]">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight">🏓 인천광역시 탁구동호회</h1>
            <p class="text-[11px] opacity-80 font-medium mt-0.5">토요리그 통합 관리 시스템</p>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleViewMode()" id="btn-view-toggle" class="bg-white/20 hover:bg-white/30 text-white backdrop-blur-sm px-3 py-1.5 rounded-xl transition text-[11px] font-extrabold shadow-inner border border-white/20 btn-press">
                💻 PC화면
            </button>
            <button onclick="toggleAdmin()" id="btn-admin-lock" class="bg-white/20 hover:bg-white/30 text-white backdrop-blur-sm p-2 rounded-full transition w-9 h-9 flex items-center justify-center shadow-inner border border-white/20 btn-press">
                🔒
            </button>
        </div>
    </header>

    <div class="relative z-30 mt-4 px-4">
        
        <div id="view-ranking" class="animate-fade-in">
            <div class="flex justify-between items-center mb-3 px-1">
                <select id="season-selector" class="text-[11px] bg-white border border-indigo-200 text-indigo-700 font-extrabold px-2.5 py-1.5 rounded-lg shadow-sm outline-none focus:ring-2 focus:ring-indigo-500" onchange="changeSeason(this.value)">
                    <option value="current">📍 현재 진행중인 시즌</option>
                </select>
                <button onclick="downloadRankingExcel()" class="text-[11px] bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg border border-emerald-200 hover:bg-emerald-100 font-extrabold btn-press shadow-sm flex items-center gap-1">
                    📊 엑셀 다운로드
                </button>
            </div>
            <div class="shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 rounded-2xl bg-white overflow-hidden mb-2">
                <table class="w-full text-left text-slate-700" style="table-layout: fixed;">
                    <thead class="text-[10px] text-slate-400 uppercase bg-slate-50/80 border-b border-slate-100 font-bold tracking-wider">
                        <tr>
                            <th class="py-3 text-center w-8">순위</th>
                            <th class="px-1 py-3 w-16">선수명</th>
                            <th class="px-1 py-3 text-center w-8" title="출석 횟수">출석</th>
                            <th class="px-0 py-3 text-center w-14 tracking-tighter" title="1위/2위/3위 횟수">🥇🥈🥉</th>
                            <th class="px-1 py-3 text-right w-11">총점</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-table-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <p class="text-[10px] text-slate-400 text-right px-2 mb-6">※ 누적 0점 회원은 숨겨집니다. 연회원 등급만 산정.</p>
        </div>

        <div id="view-operation" class="hidden animate-fade-in pb-10">
            <div class="flex gap-2 mb-4">
                <button onclick="saveTempGroupData()" class="flex-1 bg-white border border-indigo-200 text-indigo-700 py-2.5 rounded-xl text-xs font-bold shadow-sm hover:bg-indigo-50 btn-press flex justify-center items-center gap-1.5">💾 작성중인 대진표 임시저장</button>
                <button onclick="loadTempGroupData()" class="flex-1 bg-white border border-emerald-200 text-emerald-700 py-2.5 rounded-xl text-xs font-bold shadow-sm hover:bg-emerald-50 btn-press flex justify-center items-center gap-1.5">📂 임시저장 불러오기</button>
            </div>

            <div class="bg-white p-4 rounded-2xl border border-indigo-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-6xl opacity-5">👥</div>
                <div class="flex justify-between items-center mb-3 border-b border-indigo-50 pb-2 relative z-10">
                    <div>
                        <h3 class="font-extrabold text-indigo-800 text-base">✅ 오늘 경기 참석자 명단</h3>
                        <p class="text-[10px] text-slate-500 font-medium mt-0.5">여기서 선택한 인원만 아래 편성 명단에 뜹니다.</p>
                    </div>
                    <button onclick="openSelector('opAttend', '오늘 경기 참석자 선택', false)" class="text-[11px] bg-indigo-600 text-white px-3 py-2 rounded-lg font-bold shadow-md btn-press">명단 선택</button>
                </div>
                <div id="ui-box-opAttend" class="min-h-[44px] bg-slate-50 rounded-xl p-2.5 border border-slate-200 cursor-pointer relative z-10" onclick="openSelector('opAttend', '오늘 경기 참석자 선택', false)">
                    <span class="name-chip-empty text-slate-400">👆 버튼을 눌러 오늘 경기 참석자를 먼저 선택하세요.</span>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                    <div>
                        <h3 class="font-extrabold text-slate-800 text-base">📝 예선 조별 리그전표</h3>
                        <p class="text-[10px] text-slate-400 font-medium mt-0.5">인원을 조정하고 생성 후 정렬을 눌러주세요.</p>
                    </div>
                </div>
                
                <div class="mb-4 bg-slate-50 p-3 rounded-xl border border-slate-200 space-y-3">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-slate-600">조 개수</span>
                        <select id="op-group-count" class="text-xs border border-slate-200 rounded p-1.5 font-bold text-indigo-700 bg-white" onchange="generateSizeInputs()"><option value="1">1조</option><option value="2" selected>2조</option><option value="3">3조</option><option value="4">4조</option><option value="5">5조</option><option value="6">6조</option><option value="7">7조</option><option value="8">8조</option></select>
                        <div class="ml-auto flex gap-1.5">
                            <button onclick="renderGroupTable()" class="text-[11px] bg-slate-800 text-white px-3 py-1.5 rounded-lg font-bold shadow-sm btn-press">표 생성</button>
                            <button onclick="sortGroupPlayers()" class="text-[11px] bg-emerald-600 text-white px-3 py-1.5 rounded-lg font-bold shadow-sm btn-press flex items-center gap-1">🔀 정렬</button>
                        </div>
                    </div>
                    <div class="border-t border-slate-200 pt-3">
                        <span class="block text-[10px] font-extrabold text-slate-500 mb-1.5">조별 인원 상세 배분 (수정 가능)</span>
                        <div id="op-group-sizes-container" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div id="op-group-container" class="w-full overflow-x-auto pb-4">
                    <div class="text-center text-slate-400 text-xs py-8 bg-slate-50 rounded-xl border border-dashed border-slate-200">조건을 선택하고 표 생성을 눌러주세요.</div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                    <div>
                        <h3 class="font-extrabold text-slate-800 text-base">⚔️ 본선 대진표 (스마트)</h3>
                        <p class="text-[10px] text-slate-400 font-medium mt-0.5">최대 128강까지 자동 생성 지원</p>
                    </div>
                    <button onclick="printTournament()" class="text-[11px] bg-rose-600 text-white px-3 py-2 rounded-lg font-bold shadow-md btn-press flex items-center gap-1">🖨️ 대진표 인쇄</button>
                </div>

                <div class="flex flex-wrap items-center gap-2 mb-4 bg-slate-50 p-2.5 rounded-xl border border-slate-200">
                    <div class="flex items-center gap-1.5">
                        <span class="text-xs font-bold text-slate-600">예선 조</span>
                        <select id="op-tourn-groups" class="text-xs border border-slate-200 rounded p-1 font-bold text-rose-600 bg-white"><option value="1">1조</option><option value="2">2조</option><option value="3">3조</option><option value="4" selected>4조</option><option value="5">5조</option><option value="6">6조</option><option value="7">7조</option><option value="8">8조</option></select>
                    </div>
                    <div class="w-px h-4 bg-slate-300"></div>
                    <div class="flex items-center gap-1.5">
                        <span class="text-xs font-bold text-slate-600">진출자(조당)</span>
                        <select id="op-tourn-adv" class="text-xs border border-slate-200 rounded p-1 font-bold text-rose-600 bg-white"><option value="1">1명</option><option value="2" selected>2명</option><option value="3">3명</option><option value="4">4명</option><option value="5">5명</option><option value="6">6명</option><option value="7">7명</option><option value="8">8명</option><option value="9">9명</option><option value="10">10명</option><option value="11">11명</option><option value="12">12명</option></select>
                    </div>
                    <button onclick="renderTournament()" class="ml-auto text-[11px] bg-slate-800 text-white px-3 py-1.5 rounded-lg font-bold shadow-sm btn-press">대진표 생성</button>
                </div>
                
                <div id="op-tourn-info" class="text-[11px] font-extrabold text-rose-700 bg-rose-50 p-2 rounded-lg mb-3 hidden text-center border border-rose-100"></div>

                <div id="op-tourn-container" class="w-full overflow-x-auto pb-4">
                    <div class="text-center text-slate-400 text-xs py-8 bg-slate-50 rounded-xl border border-dashed border-slate-200">조건을 선택하고 대진표 생성을 눌러주세요.</div>
                </div>
            </div>
        </div>

        <div id="view-history" class="hidden animate-fade-in"><h2 class="font-bold text-lg mb-4 text-gray-800 tracking-tight ml-1">저장된 경기 기록</h2><div class="shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 rounded-2xl bg-white overflow-hidden"><table class="w-full text-sm text-center text-slate-700"><thead class="text-xs text-slate-500 uppercase bg-gray-50 border-b border-gray-200"><tr><th class="px-2 py-3 w-20">날짜/종류</th><th class="px-2 py-3 text-left">참석 및 입상 내역</th><th class="px-2 py-3 admin-only-table-cell w-16">기능</th></tr></thead><tbody id="match-history-list" class="divide-y divide-slate-100"></tbody></table></div></div>
        
        <div id="view-input" class="hidden admin-only-block animate-fade-in"><div id="input-step-1" class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-4"><h2 id="input-form-title" class="font-extrabold text-xl mb-5 text-slate-800 tracking-tight">1. 모임 기본 정보 입력</h2><div class="mb-5"><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">날짜 선택</label><input type="date" id="match-date" class="block w-full border-0 bg-slate-100 p-3.5 rounded-xl font-medium text-slate-700 focus:ring-2 focus:ring-indigo-500 transition-all"></div><div class="mb-8"><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">모임 종류</label><select id="match-type" class="block w-full border-0 bg-slate-100 p-3.5 rounded-xl font-medium text-slate-700 focus:ring-2 focus:ring-indigo-500 transition-all"><option>정기모임</option><option>월례대회</option><option>교류전</option></select></div><button onclick="openInputStep2()" class="w-full bg-gradient-to-r from-indigo-500 to-violet-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-xl transition-all btn-press text-lg">다음 단계로 이동 👉</button></div><div id="input-step-2" class="hidden mt-2 bg-gray-50 p-4 rounded-xl border border-indigo-200 shadow-inner mb-6"><div class="flex justify-between items-center mb-4 pl-1"><h2 class="font-extrabold text-lg text-indigo-800">2. 상세 결과 선택</h2><span id="display-match-info" class="text-xs text-indigo-700 font-bold bg-indigo-100/50 px-3 py-1.5 rounded-full"></span></div><div class="mb-5 bg-white p-4 border rounded-xl border-gray-200 shadow-sm relative"><div class="flex justify-between items-center mb-2 border-b pb-2"><label class="block text-sm font-extrabold text-gray-800">✅ 오늘 참석자</label><div class="flex gap-1"><button onclick="generateTeams()" class="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-200 font-bold hover:bg-indigo-100 btn-press">🤖 조편성</button><button onclick="openSelector('attend', '오늘 참석자 선택', false)" class="text-[10px] bg-blue-600 text-white px-2 py-1 rounded shadow-sm font-bold btn-press">명단 선택</button></div></div><div id="ui-box-attend" class="min-h-[40px] bg-gray-50 rounded-lg p-2 border border-gray-200 cursor-pointer" onclick="openSelector('attend', '오늘 참석자 선택', false)"><span class="name-chip-empty">버튼을 눌러 참석자를 선택하세요.</span></div><div class="flex justify-between items-center mt-4 mb-2 border-b pb-2"><label class="block text-sm font-extrabold text-red-600">🚨 불성실자 (성실점수 제외)</label><button onclick="openSelector('lazy', '불성실자 선택', true)" class="text-[10px] bg-red-50 text-red-600 border border-red-200 px-2 py-1 rounded font-bold btn-press">선택</button></div><div id="ui-box-lazy" class="min-h-[30px] bg-red-50/50 rounded-lg p-2 border border-red-100 cursor-pointer" onclick="openSelector('lazy', '불성실자 선택', true)"><span class="name-chip-empty text-red-300">해당자 없음</span></div></div><div class="space-y-4"><div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">🏅</span> 개인 리그전</h3><div class="space-y-2.5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-lg1" onclick="openSelector('lg1', '리그전 1등 선택', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-lg2" onclick="openSelector('lg2', '리그전 2등 선택', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-lg3" onclick="openSelector('lg3', '리그전 3등 선택', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div></div></div><div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">🤝</span> 단체전</h3><div class="space-y-2.5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-tm1" onclick="openSelector('tm1', '단체전 1등 선택', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-tm2" onclick="openSelector('tm2', '단체전 2등 선택', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-tm3" onclick="openSelector('tm3', '단체전 3등 선택', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div></div></div><div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">⚔️</span> 토너먼트</h3><div class="space-y-2.5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-tn1" onclick="openSelector('tn1', '토너먼트 1등 선택', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-tn2" onclick="openSelector('tn2', '토너먼트 2등 선택', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-tn3" onclick="openSelector('tn3', '토너먼트 3등 선택', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div></div></div><div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">👥</span> 복식전</h3><div class="space-y-2.5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-db1" onclick="openSelector('db1', '복식 1등 선택', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-db2" onclick="openSelector('db2', '복식 2등 선택', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div></div></div><div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-4 border rounded-2xl border-yellow-200/60 shadow-[0_4px_20px_rgba(250,204,21,0.15)]"><h3 class="font-extrabold text-sm text-yellow-800 mb-3 flex items-center gap-2"><span class="text-lg">🎉</span> 이벤트전</h3><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-white flex justify-center items-center font-black text-yellow-600 shadow-sm">👑</div><div id="ui-box-ev1" onclick="openSelector('ev1', '이벤트 우승자 선택', true)" class="flex-1 min-h-[44px] border border-white rounded-xl bg-white/60 backdrop-blur-sm p-2 cursor-pointer flex items-center flex-wrap gap-1 shadow-sm hover:bg-white transition"></div></div></div></div><div class="flex gap-3 mt-8 sticky bottom-16 z-20 pb-2"><button onclick="cancelInputStep2()" class="flex-1 bg-white text-slate-700 py-4 rounded-2xl font-extrabold shadow-sm border border-slate-200 hover:bg-slate-50 btn-press">작성 취소</button><button onclick="saveMatch()" class="flex-[2] bg-gradient-to-r from-indigo-500 to-violet-500 text-white py-4 rounded-2xl font-extrabold shadow-lg shadow-indigo-200 btn-press text-lg border border-indigo-700">최종 점수 저장</button></div></div></div>
        
        <div id="view-member" class="hidden p-4 admin-only-block animate-fade-in"><div class="bg-white border border-indigo-100 p-5 rounded-2xl mb-6 shadow-sm"><h3 class="font-extrabold text-indigo-800 mb-3 text-sm flex items-center gap-1.5"><span class="text-lg">📊</span> 엑셀로 일괄 등록</h3><input type="file" id="excel-upload" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-5 file:rounded-xl file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition cursor-pointer mb-3" onchange="handleExcelUpload(event)"><button onclick="downloadExcelTemplate()" class="w-full bg-white border border-indigo-200 text-indigo-600 py-2.5 rounded-xl text-xs font-bold btn-press shadow-sm">등록용 엑셀 양식 다운로드</button></div><div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6" id="member-form-container"><h2 id="form-title" class="font-extrabold text-xl mb-5 text-slate-800">새 회원 개별 등록</h2><div class="mb-5 flex items-center gap-5 bg-slate-50 p-4 rounded-xl border border-slate-100"><div class="w-20 h-20 rounded-full overflow-hidden border-4 border-white shadow-md flex-shrink-0 bg-slate-200 relative"><img id="photo-preview" src="" class="w-full h-full object-cover hidden"><div id="photo-placeholder" class="w-full h-full flex flex-col items-center justify-center text-slate-400 text-xs font-bold"><span>📷</span><span>사진</span></div></div><div class="flex-1"><input type="file" id="mem-photo" accept="image/*" class="w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition cursor-pointer" onchange="handlePhotoUpload(event)"></div></div><div class="grid grid-cols-2 gap-4 mb-6 text-sm"><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">구분</label><select id="mem-affiliation" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition"><option value="시">시</option><option value="구">구</option><option value="레전드">레전드</option></select></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">부서</label><input type="text" id="mem-dept" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="예: 체육진흥과"></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">등급</label><select id="mem-type" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition"><option value="연회원" selected>연회원</option><option value="준회원">준회원</option><option value="비회원">비회원</option></select></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">직책</label><input type="text" id="mem-duty" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="예: 총무"></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">직급</label><input type="text" id="mem-rank" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="예: 주무관"></div><div><label class="block font-bold text-indigo-600 mb-1.5 text-xs">* 이름 (필수)</label><input type="text" id="mem-name" class="w-full border border-indigo-200 bg-indigo-50/50 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition font-bold" placeholder="홍길동"></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">* 부수 (필수)</label><select id="mem-handicap" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 font-bold text-indigo-700"><option value="1">1부</option><option value="2">2부</option><option value="3">3부</option><option value="4">4부</option><option value="5" selected>5부</option><option value="6">6부</option><option value="7">7부</option><option value="8">8부</option><option value="9">9부</option><option value="10">10부</option></select></div><div><label class="block font-bold text-slate-600 mb-1.5 text-xs">성별</label><select id="mem-gender" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition"><option value="남">남</option><option value="여">여</option></select></div><div class="col-span-2"><label class="block font-bold text-slate-600 mb-1.5 text-xs">상태</label><select id="mem-status" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition font-bold"><option value="active" selected>🟢 정상 활동</option><option value="inactive">🔴 휴면 (순위/명단에서 숨김)</option></select></div><div class="col-span-2"><label class="block font-bold text-slate-800 mb-1"><span class="bg-yellow-100 px-1.5 rounded">📞 연락처</span></label><input type="tel" id="mem-phone" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="010-0000-0000"></div></div><div class="flex gap-3"><button onclick="saveMember()" id="btn-save-member" class="flex-1 bg-slate-800 text-white py-4 rounded-xl font-extrabold shadow-md btn-press">회원 저장하기</button><button onclick="cancelEdit()" id="btn-cancel-edit" class="hidden flex-1 bg-slate-200 text-slate-700 py-4 rounded-xl font-extrabold btn-press">취소</button></div></div><div class="flex justify-between items-end mb-3 px-1"><h3 class="font-extrabold text-lg text-slate-800">전체 회원 목록</h3><span class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2.5 py-1 rounded-full border border-indigo-100" id="total-members-count">총 0명</span></div><ul id="member-list-display" class="text-sm divide-y divide-slate-100 bg-white border border-slate-100 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6 overflow-hidden"></ul></div>
        
        <div id="view-setting" class="hidden p-4 pb-20 admin-only-block animate-fade-in">
            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-2xl shadow-lg mb-6 text-white relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-8xl opacity-10">🌱</div>
                <h2 class="font-extrabold text-xl mb-2 relative z-10">새로운 시즌 시작</h2>
                <p class="text-[11px] text-emerald-50 mb-4 leading-relaxed relative z-10 font-medium">현재 기록을 <b>[시즌 보관소]</b>에 안전하게 저장하고, 모든 회원의 점수를 0점으로 리셋하여 새 기수를 시작합니다.</p>
                <div class="relative z-10 mb-4">
                    <input type="text" id="cfg-season-name" class="w-full bg-white/20 border border-white/40 text-white placeholder-emerald-100 p-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-white" placeholder="예: 25년 하반기 리그">
                </div>
                <button onclick="startNewSeason()" class="w-full bg-white text-emerald-700 py-3.5 rounded-xl font-extrabold shadow-md btn-press relative z-10">새 시즌 시작 및 기존 데이터 보관</button>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6"><h2 class="font-extrabold text-lg text-slate-800 mb-5 flex items-center gap-2"><span>🔢</span> 획득 점수 룰 설정</h2><div class="space-y-5 text-sm"><div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-xl"><div><label class="block font-bold text-slate-500 mb-1.5 text-xs text-center">기본 참석</label><input type="number" id="cfg-score-attend" step="0.5" class="w-full border-0 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 text-center font-extrabold text-slate-700 shadow-sm"></div><div><label class="block font-bold text-slate-500 mb-1.5 text-xs text-center">성실 점수</label><input type="number" id="cfg-score-sincerity" step="0.5" class="w-full border-0 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 text-center font-extrabold text-slate-700 shadow-sm"></div></div><div><div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">🏅 개인 리그전 입상</div><div class="grid grid-cols-3 gap-3"><div><input type="number" id="cfg-score-lg1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">1등</div></div><div><input type="number" id="cfg-score-lg2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">2등</div></div><div><input type="number" id="cfg-score-lg3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">3등</div></div></div></div><div><div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">🤝 단체전 입상</div><div class="grid grid-cols-3 gap-3"><div><input type="number" id="cfg-score-tm1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><input type="number" id="cfg-score-tm2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><input type="number" id="cfg-score-tm3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div></div></div><div><div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">⚔️ 토너먼트 입상</div><div class="grid grid-cols-3 gap-3"><div><input type="number" id="cfg-score-tn1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><input type="number" id="cfg-score-tn2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><input type="number" id="cfg-score-tn3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div></div></div><div class="grid grid-cols-3 gap-4 border-t pt-4"><div><div class="font-extrabold text-slate-700 mb-2 text-[10px]">👥 복식 1등</div><input type="number" id="cfg-score-db1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><div class="font-extrabold text-slate-700 mb-2 text-[10px]">👥 복식 2등</div><input type="number" id="cfg-score-db2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><div class="font-extrabold text-yellow-600 mb-2 text-[10px]">🎉 이벤트 우승</div><input type="number" id="cfg-score-ev1" step="0.5" class="w-full border border-yellow-200 p-2 rounded-lg text-center font-bold text-yellow-600 bg-yellow-50"></div></div><button onclick="saveScoreRules()" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold shadow-md mt-4 btn-press">룰 저장 및 즉시 재계산</button></div></div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6"><h2 class="font-extrabold text-lg text-slate-800 mb-4 flex items-center gap-2"><span>💬</span> 카톡 공지 템플릿</h2><div class="mb-4"><label class="block text-xs font-bold text-slate-500 mb-1.5">머릿말 (시작 문구)</label><textarea id="cfg-announce-prefix" rows="2" class="w-full border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition"></textarea></div><div class="mb-5"><label class="block text-xs font-bold text-slate-500 mb-1.5">꼬릿말 (안내/계좌 문구)</label><textarea id="cfg-announce-suffix" rows="3" class="w-full border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition"></textarea></div><div class="mb-5"><label class="block text-xs font-bold text-slate-500 mb-1.5">앱 접속 시 기본 화면</label><select id="cfg-default-tab" class="w-full border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition"><option value="ranking">🏆 전체 순위 화면</option><option value="history">📅 경기 기록 화면</option></select></div><button onclick="saveUIConfig()" class="w-full bg-slate-200 text-slate-700 py-3 rounded-xl font-bold btn-press">환경 설정 저장</button></div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6"><h2 class="font-extrabold text-lg text-slate-800 mb-4 flex items-center gap-2"><span>💾</span> 데이터 백업 및 복원</h2><p class="text-xs text-slate-500 mb-4 leading-relaxed">인터넷 불안정으로 저장이 안 될 때를 대비해 데이터를 기기에 파일로 저장하고 언제든 복원할 수 있습니다.</p><div class="flex gap-3"><button onclick="exportData()" class="flex-1 bg-indigo-50 text-indigo-700 py-3 rounded-xl font-bold border border-indigo-200 hover:bg-indigo-100 btn-press">📥 백업 저장</button><div class="flex-1 relative"><input type="file" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importData(event)"><div class="bg-emerald-50 text-emerald-700 py-3 rounded-xl font-bold border border-emerald-200 hover:bg-emerald-100 btn-press text-center flex items-center justify-center h-full">📤 백업 불러오기</div></div></div></div>
            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-4"><h2 class="font-extrabold text-lg text-slate-800 mb-4 flex items-center gap-2"><span>🔑</span> 보안 설정</h2><label class="block text-xs font-bold text-slate-500 mb-1.5">새로운 관리자 비밀번호 입력</label><div class="flex gap-2 mb-3"><input type="password" id="cfg-password" class="flex-1 border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-500 transition" placeholder="비밀번호 입력"><button onclick="changePassword()" class="bg-red-500 text-white px-5 rounded-xl font-bold shadow-md btn-press">변경</button></div></div>
            
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-4">
                <h2 class="font-extrabold text-lg text-slate-800 mb-4 flex items-center gap-2"><span>📢</span> 시스템 업데이트 내역</h2>
                <div class="space-y-3" id="changelog-container">
                    <details class="group bg-slate-50 rounded-xl border border-slate-200 cursor-pointer transition-all">
                        <summary class="font-bold text-sm p-4 list-none flex justify-between items-center group-open:border-b border-slate-200">
                            <div class="flex items-center gap-2"><span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-[10px] font-black tracking-tighter">26.02.22</span> v1.5 대규모 기능 개편</div>
                            <span class="text-slate-400 group-open:rotate-180 transition-transform text-xs">▼</span>
                        </summary>
                        <div class="p-4 text-[11px] text-slate-600 leading-relaxed space-y-1.5 bg-white rounded-b-xl shadow-inner">
                            <p>• <b>자동 순위 산출:</b> 3자 동률 시 세트 득실 계산 탁구 룰 완벽 적용</p>
                            <p>• <b>수동 인원 배분:</b> 조별 인원이 달라도 자유롭게 배분 가능</p>
                            <p>• <b>자동 정렬:</b> 리그전 생성 시 부수 및 이름순 자동 정렬 추가</p>
                            <p>• <b>임시 저장:</b> 대진표 작성 중 창이 닫혀도 데이터 복구 지원</p>
                            <p>• <b>시즌 보관소:</b> 과거 기수 기록 저장 및 지난 시즌 순위표 열람 기능</p>
                            <p>• <b>순위표 UI 개편:</b> 0점 숨김 처리, 출석/입상(🥇🥈🥉) 횟수 열 추가</p>
                        </div>
                    </details>
                </div>
            </div>

            <div class="bg-rose-50 p-5 rounded-2xl border border-rose-200 shadow-sm mt-8"><h2 class="font-extrabold text-lg text-rose-800 mb-2 flex items-center gap-2"><span>⚠️</span> 회원 명단 전체 초기화</h2><p class="text-xs text-rose-600 mb-4 leading-relaxed font-medium">등록된 모든 회원 명단을 완전히 삭제합니다. 이 작업은 되돌릴 수 없습니다.</p><button onclick="resetAllMembers()" class="w-full bg-rose-600 text-white py-3.5 rounded-xl font-bold shadow-md btn-press">회원 전체 삭제하기</button></div>
        </div>
    </div>

    <div id="print-option-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex justify-center items-center p-4 animate-fade-in" onclick="if(event.target === this) closePrintModal()">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl flex flex-col overflow-hidden"><div class="px-5 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><h3 class="font-extrabold text-lg text-slate-800" id="print-modal-title">🖨️ 인쇄 옵션</h3><button onclick="closePrintModal()" class="text-slate-400 hover:text-slate-600 text-2xl font-bold btn-press">&times;</button></div><div class="p-5 flex flex-col gap-3"><button onclick="executePrint('table')" class="w-full bg-indigo-50 text-indigo-700 py-3.5 rounded-xl font-extrabold border border-indigo-200 hover:bg-indigo-100 transition btn-press">📊 대진표만 인쇄</button><button onclick="executePrint('order')" class="w-full bg-emerald-50 text-emerald-700 py-3.5 rounded-xl font-extrabold border border-emerald-200 hover:bg-emerald-100 transition btn-press">🔄 게임순서만 인쇄</button><button onclick="executePrint('both')" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-extrabold shadow-md hover:bg-slate-700 transition btn-press">전체(대진표+게임순서) 함께 인쇄</button></div></div>
    </div>

    <div id="announcement-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex justify-center items-center p-4 animate-fade-in" onclick="if(event.target === this) closeAnnouncement()">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl flex flex-col overflow-hidden"><div class="px-5 py-4 flex justify-between items-center border-b border-slate-100 bg-indigo-50"><h3 class="font-extrabold text-lg text-indigo-800">💬 카카오톡 공지 복사</h3><button onclick="closeAnnouncement()" class="text-slate-400 hover:text-slate-600 text-2xl font-bold btn-press">&times;</button></div><div class="p-4 bg-slate-50 flex-1"><textarea id="announcement-text" class="w-full h-[40vh] p-3 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 resize-none bg-white font-medium" readonly></textarea><p class="text-[11px] text-slate-500 mt-2 text-center">머릿말/꼬릿말은 [설정] 탭에서 수정할 수 있습니다.</p></div><div class="p-4 border-t border-slate-100 bg-white"><button onclick="copyAnnouncement()" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-extrabold shadow-lg shadow-indigo-200 hover:bg-indigo-700 btn-press text-lg">카톡에 맞게 복사하기</button></div></div>
    </div>
    
    <div id="team-maker-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex justify-center items-end sm:items-center p-0 sm:p-4 animate-fade-in" onclick="if(event.target === this) closeTeamMaker()">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col max-h-[85vh]"><div class="sheet-handle sm:hidden"></div><div class="px-5 py-3 flex justify-between items-center shrink-0 border-b border-slate-100"><h3 class="font-extrabold text-lg text-slate-800">🤖 밸런스 조 편성 결과</h3><button onclick="closeTeamMaker()" class="text-slate-400 hover:text-slate-600 text-2xl font-bold">&times;</button></div><div class="p-5 flex-1 overflow-y-auto bg-slate-50/50"><div id="team-result-box" class="space-y-2 text-sm min-h-[150px]"></div></div><div class="p-4 shrink-0 border-t border-slate-100 bg-white flex gap-3 pb-8 sm:pb-4"><button onclick="generateTeams()" class="flex-1 bg-slate-100 text-slate-700 py-3.5 rounded-xl font-bold hover:bg-slate-200 btn-press">다시 섞기</button><button onclick="copyTeams()" class="flex-[2] bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 btn-press text-lg">결과 복사하기</button></div></div>
    </div>
    
    <div id="member-selector-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex justify-end flex-col animate-fade-in" onclick="if(event.target === this) closeSelector()">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-3xl shadow-2xl flex flex-col max-h-[85vh]"><div class="sheet-handle"></div><div class="px-5 pb-3 pt-1 border-b border-slate-100 flex justify-between items-center"><h3 class="font-extrabold text-xl text-slate-800" id="selector-title">명단 선택</h3><span id="selector-count" class="text-xs font-extrabold bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-full shadow-inner">0명 선택됨</span></div><div class="px-4 py-2 bg-slate-50 border-b border-slate-200"><input type="text" id="selector-search" placeholder="🔍 이름 검색 (터치하여 입력)" class="w-full bg-white border border-slate-200 p-2.5 rounded-xl text-sm outline-none font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 shadow-sm" oninput="filterSelector(this.value)"></div><div class="p-4 flex-1 overflow-y-auto bg-slate-50/50"><p id="selector-empty-msg" class="hidden text-sm text-slate-400 text-center py-10 font-medium">선택 가능한 회원이 없습니다.</p><div id="selector-list" class="grid grid-cols-3 gap-2.5"></div></div><div class="p-4 border-t border-slate-100 bg-white flex gap-3 pb-6"><button onclick="closeSelector()" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-xl font-bold btn-press">취소</button><button onclick="confirmSelector()" id="btn-selector-confirm" class="flex-[2] bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 btn-press text-lg">선택 완료</button></div></div>
    </div>

    <div class="fixed bottom-0 w-full border-t border-slate-200/50 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.08)] glass-panel z-50 px-3 py-2 pb-5 flex justify-between items-center text-[10px] text-slate-400 font-medium no-print transition-all duration-300 max-w-md mx-auto left-0 right-0" id="bottom-tab-bar">
        <button onclick="switchTab('ranking')" id="btn-ranking" class="tab-item flex-1 flex flex-col items-center justify-center py-2 relative tab-active btn-press"><span class="tab-icon">🏆</span><span class="mt-1">순위</span></button>
        <button onclick="switchTab('history')" id="btn-history" class="tab-item flex-1 flex flex-col items-center justify-center py-2 relative btn-press"><span class="tab-icon">📅</span><span class="mt-1">기록</span></button>
        <button onclick="switchTab('operation')" id="btn-operation" class="tab-item flex-1 flex flex-col items-center justify-center py-2 relative admin-only btn-press"><span class="tab-icon">🎮</span><span class="mt-1">운영</span></button>
        <button onclick="switchTab('input')" id="btn-input" class="tab-item flex-1 flex-col items-center justify-center py-2 relative admin-only btn-press"><span class="tab-icon">📝</span><span class="mt-1">입력</span></button>
        <button onclick="switchTab('member')" id="btn-member" class="tab-item flex-1 flex-col items-center justify-center py-2 relative admin-only btn-press"><span class="tab-icon">👥</span><span class="mt-1">회원</span></button>
        <button onclick="switchTab('setting')" id="btn-setting" class="tab-item flex-1 flex-col items-center justify-center py-2 relative admin-only btn-press"><span class="tab-icon">⚙️</span><span class="mt-1">설정</span></button>
    </div>

    <script>
        // -------------------------------------------------------------
        // 🔴 Firebase 연동 부분 (API 키 삽입 필요) 🔴
        // -------------------------------------------------------------
  const firebaseConfig = {
  apiKey: "AIzaSyC1t-mJJXV6GBZ7-kWcvpRd35vpPZU0wmA",
  authDomain: "table-tennis-6334b.firebaseapp.com",
  projectId: "table-tennis-6334b",
  storageBucket: "table-tennis-6334b.firebasestorage.app",
  messagingSenderId: "967760713131",
  appId: "1:967760713131:web:17288e738222768aa1aeee",
  measurementId: "G-V3FBQ4FZB7"
};

        // 📊 풀리그 대진표 매핑
        const ROUND_ROBIN_ORDERS = {
            2: [[1,2]], 3: [[2,3], [1,3], [1,2]], 4: [[1,4], [2,3], [1,3], [4,2], [1,2], [3,4]], 
            5: [[2,5], [3,4], [1,5], [2,3], [1,4], [5,3], [1,3], [4,2], [1,2], [4,5]], 
            6: [[1,6], [2,5], [3,4], [1,5], [6,4], [2,3], [1,4], [5,3], [6,2], [1,3], [4,2], [5,6], [1,2], [3,6], [4,5]], 
            7: [[2,7], [3,6], [4,5], [1,7], [2,5], [3,4], [1,6], [2,3], [5,7], [1,5], [3,7], [4,6], [1,4], [2,6], [3,5], [1,3], [2,4], [6,7], [1,2], [4,7], [5,6]], 
            8: [[1,8], [2,7], [3,6], [4,5], [1,7], [2,5], [3,4], [6,8], [1,6], [2,3], [4,8], [5,7], [1,5], [2,8], [3,7], [4,6], [1,4], [2,6], [3,5], [7,8], [1,3], [2,4], [5,8], [6,7], [1,2], [3,8], [4,7], [5,6]], 
            9: [[2,9], [3,8], [4,7], [5,6], [1,9], [2,7], [3,6], [4,5], [1,8], [2,5], [3,4], [7,9], [1,7], [2,3], [5,9], [6,8], [1,6], [3,9], [4,8], [5,7], [1,5], [2,8], [3,7], [4,6], [1,4], [2,6], [3,5], [8,9], [1,3], [2,4], [6,9], [7,8], [1,2], [4,9], [5,8], [6,7]], 
            10: [[1,10], [2,9], [3,8], [4,7], [5,6], [1,9], [2,7], [3,6], [4,5], [8,10], [1,8], [2,5], [3,4], [6,10], [7,9], [1,7], [2,3], [4,10], [5,9], [6,8], [1,6], [2,10], [3,9], [4,8], [5,7], [1,5], [2,8], [3,7], [4,6], [9,10], [1,4], [2,6], [3,5], [7,10], [8,9], [1,3], [2,4], [5,10], [6,9], [7,8], [1,2], [3,10], [4,9], [5,8], [6,7]], 
            11: [[2,11], [3,10], [4,9], [5,8], [6,7], [1,11], [2,9], [3,8], [4,7], [5,6], [1,10], [2,7], [3,6], [4,5], [9,11], [1,9], [2,5], [3,4], [7,11], [8,10], [1,8], [2,3], [5,11], [6,10], [7,9], [1,7], [3,11], [4,10], [5,9], [6,8], [1,6], [2,10], [3,9], [4,8], [5,7], [1,5], [2,8], [3,7], [4,6], [10,11], [1,4], [2,6], [3,5], [8,11], [9,10], [1,3], [2,4], [6,11], [7,10], [8,9], [1,2], [4,11], [5,10], [6,9], [7,8]], 
            12: [[1,12], [2,11], [3,10], [4,9], [5,8], [6,7], [1,11], [2,9], [3,8], [4,7], [5,6], [10,12], [1,10], [2,7], [3,6], [4,5], [8,12], [9,11], [1,9], [2,5], [3,4], [6,12], [7,11], [8,10], [1,8], [2,3], [4,12], [5,11], [6,10], [7,9], [1,7], [2,12], [3,11], [4,10], [5,9], [6,8], [1,6], [2,10], [3,9], [4,8], [5,7], [11,12], [1,5], [2,8], [3,7], [4,6], [9,12], [10,11], [1,4], [2,6], [3,5], [7,12], [8,11], [9,10], [1,3], [2,4], [5,12], [6,11], [7,10], [8,9], [1,2], [3,12], [4,11], [5,10], [6,9], [7,8]]
        };
        function getRoundRobinPairs(n) { return ROUND_ROBIN_ORDERS[n] || []; }

        let isAdmin = false; let editingMatchId = null; let editingMemberId = null; let currentPhotoBase64 = "";
        let defaultAppConfig = { password: "1156", defaultTab: "ranking", announcePrefix: "🏓 [ {date} {type} 결과 ]\n\n", announceSuffix: "\n모두 수고하셨습니다! 다음 모임에서 뵙겠습니다. 👏", pastSeasons: [] };
        let defaultScoreRules = { attend: 3.0, sincerity: 0.5, lg1: 2.5, lg2: 2.0, lg3: 1.5, tm1: 2.5, tm2: 2.0, tm3: 1.5, tn1: 2.5, tn2: 2.0, tn3: 1.5, db1: 2.0, db2: 1.5, ev1: 2.0 };
        let appConfig = {...defaultAppConfig}; let scoreRules = {...defaultScoreRules}; let members = []; let matchHistory = []; let nextMemberId = 1; let nextMatchId = 1; 
        
        let formState = { attend: [], lazy: [], lg1: [], lg2: [], lg3: [], tm1: [], tm2: [], tm3: [], tn1: [], tn2: [], tn3: [], db1: [], db2: [], ev1: [], opAttend: [] };
        let currentSelectorTarget = ''; let tempSelectorList = []; let isSinglePickMode = false;
        window.leaguePlayers = {}; 

        let isPcMode = sessionStorage.getItem('isPcMode') === 'true';
        let currentSeasonData = null; // 과거 시즌 열람용 객체

        function applyViewMode() {
            const body = document.getElementById('app-body'); const tabbar = document.getElementById('bottom-tab-bar');
            if(isPcMode) { body.classList.remove('max-w-md'); body.classList.add('max-w-[1200px]'); tabbar.classList.remove('max-w-md'); tabbar.classList.add('max-w-[1200px]'); document.getElementById('btn-view-toggle').innerText = "📱 모바일"; } 
            else { body.classList.add('max-w-md'); body.classList.remove('max-w-[1200px]'); tabbar.classList.add('max-w-md'); tabbar.classList.remove('max-w-[1200px]'); document.getElementById('btn-view-toggle').innerText = "💻 PC화면"; }
        }
        function toggleViewMode() { isPcMode = !isPcMode; sessionStorage.setItem('isPcMode', isPcMode); applyViewMode(); }
        function restoreAdminState() { if (sessionStorage.getItem('isAdminLoggedIn') === 'true') { isAdmin = true; document.getElementById('app-body').classList.add('admin-mode-active'); document.getElementById('btn-admin-lock').innerText = "🔓"; } applyViewMode(); }
        restoreAdminState();

        function applyParsedData(parsed) {
            members = parsed.members || []; 
            matchHistory = (parsed.matchHistory || []).map(m => ({...m, attend: m.attend||[], lazy: m.lazy||[], lg1: m.lg1||[], lg2: m.lg2||[], lg3: m.lg3||[], tm1: m.tm1||[], tm2: m.tm2||[], tm3: m.tm3||[], tn1: m.tn1||[], tn2: m.tn2||[], tn3: m.tn3||[], db1: m.db1||[], db2: m.db2||[], ev1: m.ev1||[] }));
            appConfig = parsed.appConfig || {...defaultAppConfig};
            if(!appConfig.pastSeasons) appConfig.pastSeasons = []; // 호환성 유지
            scoreRules = parsed.scoreRules || {...defaultScoreRules}; nextMemberId = parsed.nextMemberId || 1; nextMatchId = parsed.nextMatchId || 1;
            renderAll(); updateSeasonSelector(); switchTab(appConfig.defaultTab); if (isAdmin) loadSettingsUI();
            generateSizeInputs(); // 초기 UI 세팅
        }
        function loadLocalFallback() { try { const localData = localStorage.getItem('pingpongLocalData'); if(localData) { applyParsedData(JSON.parse(localData)); } else { injectSampleData(); } } catch(e) { injectSampleData(); } }
        function loadDataFromStorage() { if(isFirebaseActive && db) { db.collection("tableTennis").doc("leagueData").get().then((doc) => { if (doc.exists) applyParsedData(doc.data()); else loadLocalFallback(); }).catch((error) => { loadLocalFallback(); }); } else { loadLocalFallback(); } }
        function saveDataToStorage() { 
            try { localStorage.setItem('pingpongLocalData', JSON.stringify({ members, matchHistory, appConfig, scoreRules, nextMemberId, nextMatchId })); } catch(e) {}
            if(isFirebaseActive && db) { db.collection("tableTennis").doc("leagueData").set({ members, matchHistory, appConfig, scoreRules, nextMemberId, nextMatchId }).catch((error) => { console.error("FB 저장 오류"); }); }
        }
        function injectSampleData() { members = [{ id: 1, name: "박선행", handicap: 5, score: 0, prevRank: 1, status: "active", type: "연회원", affiliation: "시", dept: "혁신성장도시과", rank: "주무관", phone: "" }]; saveDataToStorage(); renderAll(); switchTab(appConfig.defaultTab); }
        document.getElementById('match-date').value = new Date().toISOString().substring(0, 10);
        
        function exportData() { try { const dataStr = JSON.stringify({ members, matchHistory, appConfig, scoreRules, nextMemberId, nextMatchId }, null, 2); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([dataStr], {type: "application/json"})); a.download = `탁구리그_백업_${new Date().toISOString().substring(0,10)}.json`; a.click(); } catch(e) { alert("백업 다운로드 실패"); } }
        function importData(event) { const file = event.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); applyParsedData(data); saveDataToStorage(); alert("데이터 복원이 완료되었습니다!"); } catch(err) { alert("잘못된 백업 파일입니다."); } event.target.value = ""; }; reader.readAsText(file); }
        
        function resetAllMembers() {
            if(confirm("⚠️ 경고: 등록된 모든 회원 명단이 삭제됩니다.\n\n정말 진행하시겠습니까?")) {
                const check = prompt("진행을 원하시면 '초기화' 라고 입력해주세요.");
                if(check === "초기화") { members = []; nextMemberId = 1; renderAll(); saveDataToStorage(); alert("모든 회원 명단이 초기화되었습니다."); switchTab('member'); } else { alert("초기화가 취소되었습니다."); }
            }
        }

        function toggleAdmin() {
            if (isAdmin) { isAdmin = false; sessionStorage.removeItem('isAdminLoggedIn'); document.getElementById('app-body').classList.remove('admin-mode-active'); document.getElementById('btn-admin-lock').innerText = "🔒"; if(!['ranking', 'history'].includes(getCurrentTab())) switchTab('ranking'); } 
            else { const pw = prompt("관리자 비밀번호를 입력하세요.\n(기본: 1156)"); if (pw === appConfig.password) { isAdmin = true; sessionStorage.setItem('isAdminLoggedIn', 'true'); document.getElementById('app-body').classList.add('admin-mode-active'); document.getElementById('btn-admin-lock').innerText = "🔓"; loadSettingsUI(); generateSizeInputs(); } else if (pw !== null) alert("비밀번호가 틀렸습니다."); }
            renderAll(); 
        }
        function getCurrentTab() { return ['ranking', 'input', 'history', 'member', 'setting', 'operation'].find(t => document.getElementById(`btn-${t}`).classList.contains('tab-active')); }
        function switchTab(tabName) {
            ['ranking', 'input', 'history', 'member', 'setting', 'operation'].forEach(name => {
                document.getElementById(`view-${name}`).classList.add('hidden'); document.getElementById(`btn-${name}`).classList.remove('tab-active');
                if(name === tabName) { document.getElementById(`view-${name}`).classList.remove('hidden'); document.getElementById(`btn-${name}`).classList.add('tab-active'); }
            });
            if(tabName === 'input' && !editingMatchId) cancelInputStep2(); if(tabName === 'member' && editingMemberId) cancelEdit(); window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- 🌟 기능 추가: 조별 수동 인원 조정 ---
        function generateSizeInputs() {
            const count = parseInt(document.getElementById('op-group-count').value);
            const totalAttendees = (formState.opAttend || []).length;
            const container = document.getElementById('op-group-sizes-container');
            container.innerHTML = '';
            
            let defaultSize = totalAttendees > 0 ? Math.ceil(totalAttendees / count) : 4;
            let remaining = totalAttendees;
            
            for(let i=1; i<=count; i++) {
                let size = defaultSize;
                if(totalAttendees > 0) {
                    size = Math.min(defaultSize, remaining);
                    remaining -= size;
                }
                if(size < 0) size = 0;
                
                container.innerHTML += `<div class="flex items-center gap-1"><span class="text-[10px] font-bold text-slate-600 bg-white px-1.5 py-1 rounded shadow-sm border border-slate-200">${i}조</span><input type="number" id="op-size-g${i}" value="${size}" min="0" max="15" class="w-10 text-center text-xs border border-slate-200 rounded p-1 font-bold text-indigo-700 bg-white"></div>`;
            }
        }

        // --- 🎮 경기 운영 (리그전표 및 대진표) ---
        function renderGroupTable(preserveData = false) {
            const count = parseInt(document.getElementById('op-group-count').value); 
            
            if (!preserveData) window.leaguePlayers = {}; 
            
            let html = `<div class="flex flex-wrap gap-6 justify-center w-full">`; 

            for(let g=1; g<=count; g++) {
                let sizeInput = document.getElementById(`op-size-g${g}`);
                let currentSize = sizeInput ? parseInt(sizeInput.value) : 4;
                if(currentSize < 2) currentSize = 2; // 최소 2인 제한
                
                // preserveData 상태일때는 테이블에 그려진 인원수를 유지
                if (preserveData) {
                    let pCount = 0;
                    while(window.leaguePlayers[`g${g}_p${pCount+1}`] !== undefined) pCount++;
                    currentSize = pCount > 0 ? pCount : currentSize;
                }

                html += `<div class="border border-slate-300 rounded-xl overflow-hidden bg-white flex-1 min-w-[320px] max-w-full shadow-md">
                    <div class="bg-slate-100 p-2 flex justify-end items-center gap-1.5 border-b border-slate-200">
                        <span class="text-xs font-bold text-slate-500 mr-auto ml-1">${g}조 관리</span>
                        <button onclick="copyGroupTableImage(${g})" id="btn-copy-g${g}" class="text-[10px] bg-emerald-500 hover:bg-emerald-400 text-white px-2 py-1 rounded font-bold transition-colors btn-press no-print shadow-sm flex items-center">📸 카톡 복사</button>
                    </div>
                    <div id="table-container-g${g}" class="bg-white relative p-1 pb-2">
                        <div class="bg-slate-800 p-2.5 text-white flex items-center justify-between rounded-t-lg">
                            <div class="flex items-center gap-1.5">
                                <span class="font-extrabold text-sm tracking-wide">${g}조 예선 리그</span>
                                <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded font-bold ml-1">${currentSize}명 풀리그</span>
                            </div>
                            <button onclick="autoCalculateRank(${g})" class="text-[10px] bg-indigo-500 hover:bg-indigo-400 text-white px-2 py-1 rounded font-bold transition-colors btn-press shadow-sm flex items-center no-print">🧮 자동 순위</button>
                        </div>
                        <table class="w-full text-center text-xs border-collapse border border-slate-300" id="table-g${g}">
                            <thead>
                                <tr class="bg-slate-50 border-b-2 border-slate-300 text-slate-700 font-extrabold">
                                    <th class="p-2 border-r border-slate-300 bg-slate-100 w-24 whitespace-nowrap">선수명</th>`;
                
                for(let i=1; i<=currentSize; i++) {
                    let player = window.leaguePlayers[`g${g}_p${i}`];
                    let headerName = player ? escapeHTML(player.name) : `${i}번`;
                    html += `<th class="p-1 border-r border-slate-300 font-bold break-keep text-[11px]" id="th-g${g}-p${i}">${headerName}</th>`;
                }
                
                html += `<th class="p-2 border-r border-slate-300 w-11 whitespace-nowrap bg-indigo-50/50">승/패</th><th class="p-2 border-r border-slate-300 w-11 whitespace-nowrap bg-indigo-50/50">득/실</th><th class="p-2 w-9 bg-rose-50 text-rose-600 whitespace-nowrap border-l border-slate-300">순위</th></tr></thead><tbody>`;
                
                for(let i=1; i<=currentSize; i++) {
                    let player = window.leaguePlayers[`g${g}_p${i}`];
                    let displayVal = player ? escapeHTML(player.display) : '';
                    let placeholderVal = player ? displayVal : '터치👉';
                    
                    html += `<tr class="border-b border-slate-300">
                        <td class="p-0 border-r border-slate-300 bg-slate-50" id="td-g${g}-p${i}">
                            <input type="text" value="${displayVal}" class="w-full h-full text-center outline-none cursor-pointer hover:bg-indigo-50 font-bold text-[11px] text-slate-700 p-2 break-keep bg-transparent" placeholder="터치👉" readonly onclick="selectLeaguePlayer(this, ${g}, ${i})">
                            <span class="capture-text">${placeholderVal}</span>
                        </td>`;
                    for(let j=1; j<=currentSize; j++) { 
                        if(i === j) html += `<td class="border-r border-slate-300 diagonal-strike"></td>`; 
                        else html += `<td class="border-r border-slate-300 p-0"><input type="text" id="input-g${g}-p${i}-p${j}" class="w-full h-full p-2 text-center bg-transparent outline-none font-medium text-slate-700 focus:bg-yellow-50" placeholder="" oninput="syncText(this)"><span class="capture-text bg-white"></span></td>`; 
                    }
                    html += `<td class="border-r border-slate-300 p-0 bg-indigo-50/20"><input type="text" id="wl-g${g}-p${i}" class="w-full h-full p-2 text-center outline-none font-bold text-slate-700 bg-transparent" placeholder="/" oninput="syncText(this)"><span class="capture-text bg-indigo-50/20">/</span></td><td class="border-r border-slate-300 p-0 bg-indigo-50/20"><input type="text" id="sd-g${g}-p${i}" class="w-full h-full p-2 text-center outline-none font-bold text-slate-700 bg-transparent" placeholder="/" oninput="syncText(this)"><span class="capture-text bg-indigo-50/20">/</span></td><td class="bg-rose-50/40 p-0 border-l border-slate-300"><input type="text" id="rnk-g${g}-p${i}" class="w-full h-full p-2 text-center outline-none font-black text-rose-600 text-sm bg-transparent" placeholder="" oninput="syncText(this)"><span class="capture-text bg-rose-50/40 text-rose-600"></span></td></tr>`;
                }
                html += `</tbody></table></div><div class="bg-slate-50 border-t border-slate-200 text-[11px] text-left no-print rounded-b-xl"><div class="p-2.5 flex justify-between items-center cursor-pointer font-extrabold text-slate-700 bg-slate-100 hover:bg-slate-200 transition-colors" onclick="toggleOrder(${g})"><span>🔄 게임 순서 접기/펼치기</span><span id="order-icon-${g}" class="text-xs">▼</span></div><div id="order-content-${g}" class="hidden p-3 leading-loose break-keep bg-slate-50 shadow-inner"></div></div></div>`;
            }
            html += `</div>`; document.getElementById('op-group-container').innerHTML = html; 
            
            for(let g=1; g<=count; g++) { const tableEl = document.getElementById(`table-g${g}`); if(tableEl) { updateMatchOrderDisplay(g, tableEl.querySelectorAll('tbody tr').length); } }
        }

        // 🌟 기능 추가: 대진표 작성 내용 로컬스토리지 임시저장
        function saveTempGroupData() {
            try {
                const count = parseInt(document.getElementById('op-group-count').value); 
                let inputsData = {};
                for(let g=1; g<=count; g++) {
                    const tableEl = document.getElementById(`table-g${g}`);
                    if(!tableEl) continue;
                    let size = tableEl.querySelectorAll('tbody tr').length;
                    for(let i=1; i<=size; i++) {
                        for(let j=1; j<=size; j++) {
                            if(i===j) continue;
                            let el = document.getElementById(`input-g${g}-p${i}-p${j}`);
                            if(el) inputsData[`input-g${g}-p${i}-p${j}`] = el.value;
                        }
                        let wl = document.getElementById(`wl-g${g}-p${i}`); if(wl) inputsData[`wl-g${g}-p${i}`] = wl.value;
                        let sd = document.getElementById(`sd-g${g}-p${i}`); if(sd) inputsData[`sd-g${g}-p${i}`] = sd.value;
                        let rnk = document.getElementById(`rnk-g${g}-p${i}`); if(rnk) inputsData[`rnk-g${g}-p${i}`] = rnk.value;
                    }
                }
                const sizesArray = [];
                for(let i=1; i<=count; i++) {
                    let sz = document.getElementById(`op-size-g${i}`);
                    sizesArray.push(sz ? sz.value : 4);
                }

                const tempData = {
                    groupCount: count,
                    groupSizes: sizesArray,
                    leaguePlayers: window.leaguePlayers,
                    inputs: inputsData
                };
                localStorage.setItem('pingpongTempGroup', JSON.stringify(tempData));
                alert("현재까지 작성된 리그전표가 임시저장 되었습니다.");
            } catch(e) {
                alert("임시 저장 중 오류가 발생했습니다.");
            }
        }

        function loadTempGroupData() {
            try {
                const dataStr = localStorage.getItem('pingpongTempGroup');
                if(!dataStr) { alert("저장된 임시 데이터가 없습니다."); return; }
                const tempData = JSON.parse(dataStr);
                
                document.getElementById('op-group-count').value = tempData.groupCount;
                generateSizeInputs();
                tempData.groupSizes.forEach((size, idx) => {
                    let el = document.getElementById(`op-size-g${idx+1}`);
                    if(el) el.value = size;
                });

                window.leaguePlayers = tempData.leaguePlayers || {};
                renderGroupTable(true); // 보존 모드로 렌더링

                // 입력값 복원
                for (let key in tempData.inputs) {
                    let el = document.getElementById(key);
                    if(el) {
                        el.value = tempData.inputs[key];
                        syncText(el);
                    }
                }
                alert("임시저장 데이터를 불러왔습니다.");
            } catch(e) {
                alert("데이터 복원 중 오류가 발생했습니다.");
            }
        }

        // 🌟 기능 개선: 탁구 공식 룰을 따르는 3자 동률 세트 득실 자동 순위 산출
        function autoCalculateRank(g) {
            const table = document.getElementById(`table-g${g}`);
            if(!table) return;
            const size = table.querySelectorAll('tbody tr').length;
            let playersStats = [];

            // 1. 모든 셀의 입력값 파싱
            for(let i=1; i<=size; i++) {
                let stats = { id: i, matchWins: 0, matchLosses: 0, setWins: 0, setLosses: 0, matches: {} };
                for(let j=1; j<=size; j++) {
                    if(i===j) continue;
                    let cell = document.getElementById(`input-g${g}-p${i}-p${j}`);
                    let val = cell ? cell.value.trim() : "";
                    
                    let w = 0, l = 0;
                    // "3/1", "3:1", "3-1" 등의 정규식 파싱
                    let match = val.match(/(\d+)[\/\:\-](\d+)/);
                    if(match) { w = parseInt(match[1]); l = parseInt(match[2]); }
                    else if(!isNaN(parseInt(val))) { w = parseInt(val); l = 0; } // "3" 등 숫자 하나만 입력시 승리 세트로 간주

                    if(w > l) { stats.matchWins++; }
                    else if(l > w) { stats.matchLosses++; }

                    stats.setWins += w;
                    stats.setLosses += l;
                    stats.matches[j] = { w: w, l: l };
                }
                playersStats.push(stats);
            }

            // 2. 동률 판단 및 순위 배정 로직 (탁구 룰)
            let currentRank = 1;
            
            // 다승 순으로 그룹핑
            let grouped = {};
            playersStats.forEach(p => {
                if(!grouped[p.matchWins]) grouped[p.matchWins] = [];
                grouped[p.matchWins].push(p);
            });

            // 승수가 많은 그룹부터 순위 결정
            let sortedWins = Object.keys(grouped).map(Number).sort((a,b)=>b-a);
            
            sortedWins.forEach(winCount => {
                let group = grouped[winCount];
                if(group.length === 1) {
                    // 단독 순위
                    group[0].rank = currentRank++;
                } else if(group.length === 2) {
                    // 2명 동률: 승자승 원칙
                    let p1 = group[0], p2 = group[1];
                    let p1_vs_p2 = p1.matches[p2.id];
                    if(p1_vs_p2.w > p1_vs_p2.l) {
                        p1.rank = currentRank++; p2.rank = currentRank++;
                    } else if(p1_vs_p2.l > p1_vs_p2.w) {
                        p2.rank = currentRank++; p1.rank = currentRank++;
                    } else {
                        // 맞대결 결과가 없거나 비겼으면(탁구엔 비김이 없지만) 전체 득실로
                        let diff1 = p1.setWins - p1.setLosses;
                        let diff2 = p2.setWins - p2.setLosses;
                        if(diff1 >= diff2) { p1.rank = currentRank++; p2.rank = currentRank++; }
                        else { p2.rank = currentRank++; p1.rank = currentRank++; }
                    }
                } else {
                    // 3명 이상 동률: 🚨 해당 동률 그룹간의 세트 득실만 계산 (탁구 공식 룰)
                    group.forEach(p => {
                        p.tiedSetWins = 0; p.tiedSetLosses = 0;
                        group.forEach(op => {
                            if(p.id !== op.id) {
                                p.tiedSetWins += p.matches[op.id].w;
                                p.tiedSetLosses += p.matches[op.id].l;
                            }
                        });
                        p.tiedSetDiff = p.tiedSetWins - p.tiedSetLosses;
                    });
                    
                    // 동률 그룹 내부 정렬
                    group.sort((a,b) => {
                        if(b.tiedSetDiff !== a.tiedSetDiff) return b.tiedSetDiff - a.tiedSetDiff;
                        // 세트 득실도 같을 경우 전체 세트 득실로 비교 (최후의 보루)
                        return (b.setWins - b.setLosses) - (a.setWins - a.setLosses);
                    });
                    
                    group.forEach(p => { p.rank = currentRank++; });
                }
            });

            // 3. UI에 결과 입력
            playersStats.forEach(p => {
                let wlCell = document.getElementById(`wl-g${g}-p${p.id}`);
                let sdCell = document.getElementById(`sd-g${g}-p${p.id}`);
                let rnkCell = document.getElementById(`rnk-g${g}-p${p.id}`);
                
                wlCell.value = `${p.matchWins}/${p.matchLosses}`;
                sdCell.value = `${p.setWins}/${p.setLosses}`;
                rnkCell.value = p.rank;
                
                syncText(wlCell); syncText(sdCell); syncText(rnkCell);
            });
        }

        // 🌟 완벽한 상태 보존 자동 정렬
        function sortGroupPlayers() {
            const count = parseInt(document.getElementById('op-group-count').value); 
            for(let g=1; g<=count; g++) {
                const tableEl = document.getElementById(`table-g${g}`);
                if(!tableEl) continue;
                
                let currentSize = tableEl.querySelectorAll('tbody tr').length;
                let groupPlayers = [];
                
                for(let p=1; p<=currentSize; p++) {
                    let player = window.leaguePlayers[`g${g}_p${p}`];
                    if (player) groupPlayers.push(player);
                }
                
                // 정렬 (부수 오름차순 -> 이름 오름차순)
                groupPlayers.sort((a, b) => {
                    if (a.handicap !== b.handicap) return a.handicap - b.handicap;
                    return a.name.localeCompare(b.name);
                });
                
                for(let p=1; p<=currentSize; p++) {
                    if (groupPlayers[p-1]) { window.leaguePlayers[`g${g}_p${p}`] = groupPlayers[p-1]; } 
                    else { window.leaguePlayers[`g${g}_p${p}`] = null; }
                }
            }
            renderGroupTable(true);
        }

        function syncText(inputElem) { inputElem.nextElementSibling.innerText = inputElem.value || inputElem.placeholder; }

        async function copyGroupTableImage(g) {
            const target = document.getElementById(`table-container-g${g}`); 
            const btn = document.getElementById(`btn-copy-g${g}`); btn.innerText = "⏳ 복사중...";
            
            target.querySelectorAll('input').forEach(input => { syncText(input); });
            target.classList.add('capture-mode');

            try {
                const canvas = await html2canvas(target, { scale: 3, backgroundColor: '#ffffff', logging: false, useCORS: true });
                canvas.toBlob(async (blob) => { 
                    try { 
                        const item = new ClipboardItem({ 'image/png': blob }); 
                        await navigator.clipboard.write([item]); 
                        alert(`✅ ${g}조 예선표가 클립보드에 완벽하게 복사되었습니다.\n카카오톡 채팅창에 붙여넣기(Ctrl+V) 하세요!`); 
                    } catch(err) { 
                        alert("❌ 클립보드 권한이 없거나 지원하지 않는 브라우저입니다."); 
                    } 
                    btn.innerText = "📸 카톡 복사"; 
                    target.classList.remove('capture-mode');
                }, 'image/png');
            } catch(e) { 
                alert("❌ 이미지 생성 중 오류가 발생했습니다."); 
                btn.innerText = "📸 카톡 복사"; 
                target.classList.remove('capture-mode');
            }
        }

        function selectLeaguePlayer(inputElem, g, p) {
            isSinglePickMode = true; document.getElementById('selector-title').innerText = `${g}조 ${p}번 선수 선택`; document.getElementById('selector-count').classList.add('hidden'); document.getElementById('btn-selector-confirm').classList.add('hidden'); document.getElementById('selector-search').value = ""; 
            
            let excludedNames = []; 
            for (let key in window.leaguePlayers) { 
                if (key !== `g${g}_p${p}` && window.leaguePlayers[key]) excludedNames.push(window.leaguePlayers[key].name); 
            }
            
            // 🌟 기능 개선: 오늘 참석자(opAttend)에서만 선택하도록 필터링 (true 옵션 전달)
            if(renderSelectorList(true, 'opAttend', excludedNames) === false) return; 
            document.getElementById('member-selector-modal').classList.remove('hidden');
            
            window.singlePickCallback = function(memberId) {
                const m = members.find(x => x.id == memberId);
                if(m) { 
                    const displayName = `${m.name}(${m.handicap})`; 
                    window.leaguePlayers[`g${g}_p${p}`] = { id: m.id, name: m.name, display: displayName, handicap: m.handicap }; 
                    inputElem.value = displayName; 
                    inputElem.nextElementSibling.innerText = displayName; 
                    document.getElementById(`th-g${g}-p${p}`).innerText = m.name; 
                    const size = document.getElementById(`table-g${g}`).querySelectorAll('tbody tr').length;
                    updateMatchOrderDisplay(g, size); 
                }
            };
        }

        function toggleOrder(g) { const content = document.getElementById(`order-content-${g}`); const icon = document.getElementById(`order-icon-${g}`); if(content.classList.contains('hidden')) { content.classList.remove('hidden'); icon.innerText = '▲'; } else { content.classList.add('hidden'); icon.innerText = '▼'; } }
        function updateMatchOrderDisplay(g, size) {
            let pairs = getRoundRobinPairs(size); 
            let blocks = pairs.map((pair, idx) => { let p1Obj = window.leaguePlayers[`g${g}_p${pair[0]}`]; let p2Obj = window.leaguePlayers[`g${g}_p${pair[1]}`]; let n1 = p1Obj ? escapeHTML(p1Obj.name) : `${pair[0]}번`; let n2 = p2Obj ? escapeHTML(p2Obj.name) : `${pair[1]}번`; return `<span class="inline-flex items-center bg-white border border-slate-200 px-2 py-1 rounded shadow-sm mr-1.5 mb-1.5 font-bold text-slate-700 text-[11px]"><span class="text-indigo-600 bg-indigo-50 px-1 rounded mr-1.5">${idx+1}경기</span> ${n1} <span class="text-slate-300 font-normal mx-1 text-[9px]">vs</span> ${n2}</span>`; });
            document.getElementById(`order-content-${g}`).innerHTML = blocks.join('');
        }

        let currentPrintGroup = null;
        function openPrintModal(g) { currentPrintGroup = g; document.getElementById('print-modal-title').innerText = `🖨️ ${g}조 인쇄 옵션`; document.getElementById('print-option-modal').classList.remove('hidden'); }
        function closePrintModal() { document.getElementById('print-option-modal').classList.add('hidden'); }
        function executePrint(mode) {
            closePrintModal(); const g = currentPrintGroup; let printHtml = ''; 
            const target = document.getElementById(`table-container-g${g}`); target.querySelectorAll('input').forEach(input => { syncText(input); }); target.classList.add('capture-mode'); const tableHtml = target.outerHTML; target.classList.remove('capture-mode');
            const size = document.getElementById(`table-g${g}`).querySelectorAll('tbody tr').length; let pairs = getRoundRobinPairs(size); 
            let orderHtml = `<div style="margin-top: 20px; page-break-inside: avoid;"><h3 style="font-size:18px; margin-bottom:12px; font-weight:bold; color:#1e293b;">🔄 ${g}조 게임 순서</h3><div style="line-height: 2.5;">`;
            let blocks = pairs.map((pair, idx) => { let p1Obj = window.leaguePlayers[`g${g}_p${pair[0]}`]; let p2Obj = window.leaguePlayers[`g${g}_p${pair[1]}`]; let n1 = p1Obj ? escapeHTML(p1Obj.name) : `${pair[0]}번`; let n2 = p2Obj ? escapeHTML(p2Obj.name) : `${pair[1]}번`; return `<span style="display:inline-block; border:1px solid #94a3b8; padding:6px 10px; border-radius:6px; margin-right:10px; margin-bottom:10px; font-weight:bold; font-size:14px; background:#f8fafc;"><span style="color:#4f46e5; font-size:12px; margin-right:6px;">${idx+1}경기</span> ${n1} <span style="font-weight:normal; color:#94a3b8; margin:0 6px;">vs</span> ${n2}</span>`; }); orderHtml += blocks.join('') + `</div></div>`;
            if(mode === 'table') printHtml = tableHtml; else if(mode === 'order') printHtml = orderHtml; else if(mode === 'both') printHtml = tableHtml + orderHtml;
            const printWindow = window.open('', '', 'width=900,height=700'); printWindow.document.write(`<html><head><title>${g}조 인쇄</title><style>body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; color: #333; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;} h1 { text-align: center; font-size: 26px; margin-bottom: 20px; color: #1e293b;} table { width: 100%; border-collapse: collapse; margin-bottom: 5px; font-size: 14px; text-align: center; } th, td { border: 1px solid #94a3b8; padding: 12px; } th { background-color: #f1f5f9; font-weight: bold; } .capture-mode input { display: none !important; } .capture-text { display: block !important; width: 100%; text-align: center; font-size: 14px; font-weight: bold; color: black;} .diagonal-strike { background: linear-gradient(to top right, transparent calc(50% - 1px), #cbd5e1, transparent calc(50% + 1px)); background-color: #e2e8f0 !important; } @media print { @page { size: landscape; margin: 10mm; } }</style></head><body><h1>🏓 ${g}조 예선 리그</h1>${printHtml}</body></html>`); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        function openSinglePickerForTourn(elem) { isSinglePickMode = true; document.getElementById('selector-title').innerText = "본선 진출자 선택"; document.getElementById('selector-count').classList.add('hidden'); document.getElementById('btn-selector-confirm').classList.add('hidden'); document.getElementById('selector-search').value = ""; if(renderSelectorList(true, 'tourn') === false) return; document.getElementById('member-selector-modal').classList.remove('hidden'); window.singlePickCallback = function(memberId) { const m = members.find(x => x.id == memberId); if(m) { elem.value = `${m.name}(${m.handicap})`; syncText(elem); } }; }
        function renderTournament() {
            const groups = parseInt(document.getElementById('op-tourn-groups').value); const adv = parseInt(document.getElementById('op-tourn-adv').value); const totalPlayers = groups * adv;
            let size = 2; while(size < totalPlayers) size *= 2;
            const infoBox = document.getElementById('op-tourn-info'); infoBox.classList.remove('hidden'); infoBox.innerHTML = `✅ ${groups}조 × ${adv}명 = <b>${totalPlayers}명 진출</b> 👉 <b>${size}강 토너먼트 자동 생성</b> (부전승 ${size - totalPlayers}명)`;
            let players = []; for (let rank = 1; rank <= adv; rank++) { let grpArr = Array.from({length: groups}, (_, i) => i + 1); if (rank % 2 === 0) { grpArr = grpArr.slice(groups/2).concat(grpArr.slice(0, groups/2)); grpArr.reverse(); } for (let g of grpArr) players.push(`${g}조${rank}위`); }
            let seeds = [1, 2]; for (let i = 2; i < size; i *= 2) { let temp = []; for (let j = 0; j < seeds.length; j++) { temp.push(seeds[j]); temp.push(2 * i + 1 - seeds[j]); } seeds = temp; }
            let bracketPlayers = new Array(size).fill(null); for(let i=0; i<size; i++) { let seedVal = seeds[i]; if(seedVal <= totalPlayers) bracketPlayers[i] = players[seedVal - 1]; else bracketPlayers[i] = "부전승(BYE)"; }
            let rounds = Math.log2(size); let html = `<div class="flex w-max min-w-full font-bold text-sm bg-white p-4 rounded-xl shadow-sm border border-slate-200">`;
            for(let r=0; r<=rounds; r++) {
                let numNodes = size / Math.pow(2, r); html += `<div class="flex flex-col justify-around" style="width: ${r===rounds ? '120px' : '150px'};">`;
                for(let n=0; n<numNodes; n++) {
                    let isTop = n % 2 === 0; let content = '';
                    if (r === rounds) { content = `<div class="bg-yellow-100 border-2 border-yellow-400 p-2 rounded-xl text-center shadow-lg z-10 w-28 mx-auto"><div class="text-[10px] text-rose-600 mb-0.5 font-black">👑 최종 우승</div><input class="w-full text-center bg-transparent outline-none font-black text-sm text-yellow-700 cursor-pointer" placeholder="우승자" readonly onclick="openSinglePickerForTourn(this)" oninput="syncText(this)"><span class="capture-text font-black text-sm text-yellow-700">우승자</span></div>`; } 
                    else if (r === 0) { let name = bracketPlayers[n]; let isBye = name === "부전승(BYE)"; content = `<div class="flex items-center justify-center relative w-full h-12"><div class="border ${isBye ? 'border-dashed border-slate-300 bg-slate-50 text-slate-400' : 'border-slate-300 bg-white shadow-sm'} p-1.5 rounded w-28 z-10 flex flex-col justify-center h-10">${isBye ? `<div class="text-[10px] text-center w-full font-medium">${name}</div>` : `<div class="text-[9px] text-rose-500 font-black mb-0.5">${name}</div><input class="w-full text-center outline-none text-[11px] font-extrabold cursor-pointer bg-transparent text-slate-700" placeholder="터치선택" readonly onclick="openSinglePickerForTourn(this)" oninput="syncText(this)"><span class="capture-text font-extrabold text-[11px] text-slate-700">터치선택</span>`}</div>${r < rounds ? `<div class="absolute w-1/2 h-[2px] bg-slate-400 right-0 top-1/2 -z-0"></div>` : ''}</div>`; } 
                    else { content = `<div class="flex items-center justify-center relative w-full h-full min-h-[48px]"><div class="border border-indigo-200 bg-indigo-50 p-1.5 rounded w-28 z-10 shadow-sm h-10 flex items-center"><input class="w-full text-center outline-none text-[12px] font-extrabold cursor-pointer bg-transparent text-indigo-700" placeholder="승자 선택" readonly onclick="openSinglePickerForTourn(this)" oninput="syncText(this)"><span class="capture-text font-extrabold text-[12px] text-indigo-700">승자 선택</span></div><div class="absolute w-1/2 h-[2px] bg-slate-400 left-0 top-1/2 -z-0"></div>${r < rounds ? `<div class="absolute w-1/2 h-[2px] bg-slate-400 right-0 top-1/2 -z-0"></div>` : ''}</div>`; }
                    let borderClass = ""; if(r < rounds && r >= 0) { if(isTop) borderClass = "border-r-line border-b-line rounded-br-lg"; else borderClass = "border-r-line border-t-line rounded-tr-lg"; }
                    html += `<div class="flex-1 flex flex-col justify-center relative tourn-node">${r < rounds ? `<div class="absolute right-0 w-1/2 ${borderClass}" style="height: 50%; ${isTop ? 'bottom: 0;' : 'top: 0;'}"></div>` : ''}${content}</div>`;
                } html += `</div>`;
            } html += `</div>`; document.getElementById('op-tourn-container').innerHTML = html;
        }

        function printTournament() {
            const target = document.getElementById('op-tourn-container'); target.querySelectorAll('input').forEach(input => syncText(input)); target.classList.add('capture-mode'); const printContent = target.innerHTML; target.classList.remove('capture-mode');
            const printWindow = window.open('', '', 'width=900,height=700');
            printWindow.document.write(`<html><head><title>본선 대진표 인쇄</title><style>body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; color: #333; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;} h1 { text-align: center; font-size: 26px; margin-bottom: 20px; color: #1e293b;} .capture-mode input { display: none !important; } .capture-text { display: block !important; width: 100%; text-align: center; font-size: 14px; font-weight: bold; color: black;} .flex { display: flex; } .justify-between { justify-content: space-between; } .items-center { align-items: center; } .justify-center { justify-content: center; } .flex-col { flex-direction: column; } .w-full { width: 100%; } .h-full { height: 100%; } .border-r-line { border-right: 2px solid #64748b; } .border-t-line { border-top: 2px solid #64748b; } .border-b-line { border-bottom: 2px solid #64748b; } .bg-slate-400 { background-color: #64748b !important; } .bg-yellow-100 { background-color: #fef9c3 !important; border: 2px solid #eab308; padding: 10px; border-radius: 8px;} .relative { position: relative; } .absolute { position: absolute; } .z-10 { z-index: 10; } .top-1\\/2 { top: 50%; } .right-0 { right: 0; } .left-0 { left: 0; } .bg-white { background-color: white !important; border: 1px solid #cbd5e1; } .bg-indigo-50 { background-color: #eef2ff !important; border: 1px solid #c7d2fe; } .text-rose-500 { color: #f43f5e !important; } .text-rose-600 { color: #e11d48 !important; } .rounded-br-lg { border-bottom-right-radius: 8px; } .rounded-tr-lg { border-top-right-radius: 8px; } @media print { @page { size: landscape; margin: 5mm; } }</style></head><body><h1>🏓 본선 토너먼트 대진표</h1><div class="capture-mode">${printContent}</div></body></html>`);
            printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        function filterSelector(keyword) { const btns = document.querySelectorAll('#selector-list button'); btns.forEach(b => { if(b.innerText.toLowerCase().includes(keyword.toLowerCase())) b.classList.remove('hidden'); else b.classList.add('hidden'); }); }
        
        function renderSelectorList(onlyAttendees, target, extraExcludedNames = []) {
            let candidates = []; 
            if (target === 'opAttend') { candidates = members.filter(m => m.status === 'active'); } 
            else if(onlyAttendees) { 
                if(formState.opAttend && formState.opAttend.length > 0) candidates = members.filter(m => formState.opAttend.includes(m.name)); 
                else if(formState.attend && formState.attend.length > 0) candidates = members.filter(m => formState.attend.includes(m.name)); 
                else { alert('먼저 [운영] 또는 [입력] 탭에서 오늘 참석자를 선택해 주세요.'); return false; } 
            } else candidates = members.filter(m => m.status === 'active');

            let excludedNames = []; const prefix = target.substring(0, 2);
            if (['lg', 'tm', 'tn'].includes(prefix)) { ['1', '2', '3'].forEach(num => { if (prefix + num !== target && formState[prefix + num]) excludedNames.push(...formState[prefix + num]); }); } else if (prefix === 'db') { ['1', '2'].forEach(num => { if (prefix + num !== target && formState[prefix + num]) excludedNames.push(...formState[prefix + num]); }); }
            candidates = candidates.filter(m => !excludedNames.includes(m.name) && !extraExcludedNames.includes(m.name));
            
            const listEl = document.getElementById('selector-list'); const emptyMsg = document.getElementById('selector-empty-msg'); listEl.innerHTML = '';
            if(candidates.length === 0) { listEl.classList.add('hidden'); emptyMsg.classList.remove('hidden'); } else { listEl.classList.remove('hidden'); emptyMsg.classList.add('hidden'); 
                candidates.sort((a,b) => { if (a.handicap !== b.handicap) return a.handicap - b.handicap; return a.name.localeCompare(b.name); }).forEach(m => { 
                    const isSelected = !isSinglePickMode && tempSelectorList.includes(m.name); 
                    const bgClass = isSelected ? 'bg-indigo-600 text-white border-indigo-700 shadow-inner' : 'bg-white text-slate-600 border-slate-200 shadow-sm hover:bg-slate-50'; 
                    listEl.innerHTML += `<button onclick="${isSinglePickMode ? `window.singlePickCallback('${m.id}'); closeSelector();` : `toggleSelect('${escapeHTML(m.name)}')`}" id="sel-btn-${escapeHTML(m.name)}" class="py-3 px-1 border rounded-xl text-[12px] font-extrabold transition-all btn-press ${bgClass}">${escapeHTML(m.name)} <span class="text-[9px] ${isSelected?'text-indigo-200':'text-slate-400'} block mt-0.5 font-medium">${m.handicap}부</span></button>`; 
                }); 
            } return true;
        }
        function openSelector(target, title, onlyAttendees) { isSinglePickMode = false; document.getElementById('selector-count').classList.remove('hidden'); document.getElementById('btn-selector-confirm').classList.remove('hidden'); document.getElementById('selector-search').value = ""; currentSelectorTarget = target; document.getElementById('selector-title').innerText = title; tempSelectorList = [...(formState[target] || [])]; if(renderSelectorList(onlyAttendees, target) !== false) { updateSelectorCount(); document.getElementById('member-selector-modal').classList.remove('hidden'); } }
        function toggleSelect(name) { const idx = tempSelectorList.indexOf(name); const btn = document.getElementById(`sel-btn-${name}`); if(idx > -1) { tempSelectorList.splice(idx, 1); btn.className = "py-3 px-1 border rounded-xl text-[12px] font-extrabold transition-all bg-white text-slate-600 border-slate-200 shadow-sm hover:bg-slate-50 btn-press"; btn.querySelector('span').className = "text-[9px] text-slate-400 block mt-0.5 font-medium"; } else { tempSelectorList.push(name); btn.className = "py-3 px-1 border rounded-xl text-[12px] font-extrabold transition-all bg-indigo-600 text-white border-indigo-700 shadow-inner btn-press"; btn.querySelector('span').className = "text-[9px] text-indigo-200 block mt-0.5 font-medium"; } updateSelectorCount(); }
        function updateSelectorCount() { document.getElementById('selector-count').innerText = `${tempSelectorList.length}명 선택됨`; }
        function closeSelector() { document.getElementById('member-selector-modal').classList.add('hidden'); }
        function confirmSelector() { formState[currentSelectorTarget] = [...tempSelectorList]; if(currentSelectorTarget === 'attend' || currentSelectorTarget === 'opAttend') { for(let key in formState) { if(key !== 'attend' && key !== 'opAttend') formState[key] = (formState[key]||[]).filter(name => formState[currentSelectorTarget].includes(name)); } } updateFormUI(); closeSelector(); }
        function initFormState() { for(let key in formState) if(key !== 'opAttend') formState[key] = []; updateFormUI(); }
        function updateFormUI() { for(let key in formState) { const el = document.getElementById(`ui-box-${key}`); if(!el) continue; if((formState[key]||[]).length === 0) { let emptyMsg = (key === 'attend' || key === 'opAttend') ? '👇 버튼을 눌러 명단을 선택하세요' : (key === 'lazy' ? '해당자 없음' : '선택'); el.innerHTML = `<span class="name-chip-empty ${key === 'lazy' ? 'text-red-300' : ''}">${emptyMsg}</span>`; } else el.innerHTML = formState[key].map(name => `<span class="name-chip shadow-sm">${escapeHTML(name)}</span>`).join(''); } }
        
        function downloadExcelTemplate() { try { const ws_data = [['구분', '부서', '등급', '직책', '직급', '이름(*필수)', '부수(*필수,숫자)', '성별', '상태(활동/휴면)', '연락처'],['시', '체육진흥과', '연회원', '총무', '주무관', '홍길동', '5', '남', '활동', '010-0000-0000']]; const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ws_data), "회원등록양식"); XLSX.writeFile(wb, "탁구리그_회원일괄등록_양식.xlsx"); } catch(e) { alert("다운로드 실패"); } }
        
        function handleExcelUpload(event) { 
            const file = event.target.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                try { 
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'}); 
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, defval: ""}); 
                    if(jsonData.length < 2) throw new Error("데이터가 없습니다.");
                    const headers = jsonData[0].map(h => String(h).trim());
                    const idxName = headers.findIndex(h => h.includes('이름')) > -1 ? headers.findIndex(h => h.includes('이름')) : 5;
                    const idxHandi = headers.findIndex(h => h.includes('부수')) > -1 ? headers.findIndex(h => h.includes('부수')) : 6;
                    const idxAffil = headers.findIndex(h => h.includes('구분')) > -1 ? headers.findIndex(h => h.includes('구분')) : 0;
                    const idxDept = headers.findIndex(h => h.includes('부서')) > -1 ? headers.findIndex(h => h.includes('부서')) : 1;
                    const idxType = headers.findIndex(h => h.includes('등급')) > -1 ? headers.findIndex(h => h.includes('등급')) : 2;
                    const idxDuty = headers.findIndex(h => h.includes('직책')) > -1 ? headers.findIndex(h => h.includes('직책')) : 3;
                    const idxRank = headers.findIndex(h => h.includes('직급')) > -1 ? headers.findIndex(h => h.includes('직급')) : 4;
                    const idxGender = headers.findIndex(h => h.includes('성별')) > -1 ? headers.findIndex(h => h.includes('성별')) : 7;
                    const idxStatus = headers.findIndex(h => h.includes('상태')) > -1 ? headers.findIndex(h => h.includes('상태')) : 8;
                    const idxPhone = headers.findIndex(h => h.includes('연락처')) > -1 ? headers.findIndex(h => h.includes('연락처')) : 9;

                    let addedCount = 0; 
                    for (let i = 1; i < jsonData.length; i++) { 
                        const row = jsonData[i]; 
                        if (!row || row.length === 0) continue; 
                        const name = String(row[idxName] || '').trim(); 
                        const handicapStr = String(row[idxHandi] || '').trim(); 
                        if (name !== '' && handicapStr !== '') { 
                            let rawStatus = String(row[idxStatus] || '').trim(); 
                            let statusVal = (rawStatus === '휴면' || rawStatus === 'inactive') ? 'inactive' : 'active'; 
                            members.push({ 
                                id: nextMemberId++, affiliation: String(row[idxAffil] || '시').trim(), dept: String(row[idxDept] || '').trim(), type: String(row[idxType] || '연회원').trim(), duty: String(row[idxDuty] || '').trim(), rank: String(row[idxRank] || '').trim(), name: name, handicap: parseInt(handicapStr) || 5, gender: String(row[idxGender] || '남').trim(), status: statusVal, phone: String(row[idxPhone] || '').trim(), photo: '', score: 0.0, prevRank: members.length + 1 
                            }); 
                            addedCount++; 
                        } 
                    } 
                    if(addedCount > 0) { alert(`${addedCount}명 업로드 됨`); saveDataToStorage(); renderAll(); } else { alert("유효한 데이터 없음"); } 
                } catch(err) { alert("오류 발생: 올바른 양식인지 확인해주세요."); } 
                document.getElementById('excel-upload').value = ""; 
            }; 
            reader.readAsArrayBuffer(file); 
        }

        function toggleMemberInfo(id) { const infoRow = document.getElementById(`member-info-${id}`); document.querySelectorAll('[id^="member-info-"]').forEach(row => { if (row.id !== `member-info-${id}`) row.classList.add('hidden'); }); if (infoRow.classList.contains('hidden')) { infoRow.classList.remove('hidden'); } else { infoRow.classList.add('hidden'); } }
        function renderMembersList() { const list = document.getElementById('member-list-display'); const activeCount = members.filter(m=>m.status !== 'inactive').length; document.getElementById('total-members-count').innerText = `총 ${members.length}명 (활동 ${activeCount}명)`; list.innerHTML = ''; [...members].sort((a, b) => a.name.localeCompare(b.name)).forEach(m => { const adminButtons = isAdmin ? `<div class="flex gap-1 shrink-0 mt-2 sm:mt-0"><button onclick="event.stopPropagation(); editMember(${m.id})" class="px-3 py-1.5 bg-slate-100 text-slate-700 text-xs rounded-lg font-bold hover:bg-slate-200 btn-press">수정</button><button onclick="event.stopPropagation(); deleteMember(${m.id})" class="px-3 py-1.5 bg-red-50 text-red-600 text-xs rounded-lg font-bold hover:bg-red-100 btn-press">삭제</button></div>` : ''; const photoHtml = m.photo ? `<img src="${escapeHTML(m.photo)}" class="w-11 h-11 rounded-full object-cover border border-slate-200 shadow-sm">` : `<div class="w-11 h-11 rounded-full default-avatar border border-slate-200 shadow-inner">👤</div>`; const infoStr = [m.affiliation, m.dept, m.rank].filter(Boolean).map(escapeHTML).join(' '); const inactiveClass = m.status === 'inactive' ? 'member-inactive' : ''; const badge = m.status === 'inactive' ? `<span class="text-[9px] bg-red-50 text-red-500 px-1.5 py-0.5 rounded font-extrabold ml-1 border border-red-100">휴면</span>` : ''; let phoneStr = m.phone ? escapeHTML(m.phone) : '미입력'; let deptStr = m.dept ? escapeHTML(m.dept) : '-'; let dutyStr = m.duty ? escapeHTML(m.duty) : '-'; let rankStr = m.rank ? escapeHTML(m.rank) : '-'; let typeStr = m.type ? escapeHTML(m.type) : '-'; let genderStr = m.gender ? escapeHTML(m.gender) : '-'; let detailsHtml = `<div id="member-info-${m.id}" class="hidden animate-fade-in mt-3 pt-3 border-t border-slate-100 w-full"><div class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100/50"><div class="grid grid-cols-2 gap-3 text-[11px]"><div><span class="block text-slate-400 font-bold mb-0.5">📞 연락처</span><span class="font-extrabold text-slate-700">${phoneStr}</span></div><div><span class="block text-slate-400 font-bold mb-0.5">🏢 구분/부서</span><span class="font-extrabold text-slate-700">${escapeHTML(m.affiliation)} ${m.dept ? '> '+escapeHTML(m.dept) : ''}</span></div><div><span class="block text-slate-400 font-bold mb-0.5">💼 직급/직책</span><span class="font-extrabold text-slate-700">${rankStr}${m.duty ? ' ('+escapeHTML(m.duty)+')' : ''}</span></div><div><span class="block text-slate-400 font-bold mb-0.5">🏷️ 등급/성별</span><span class="font-extrabold text-slate-700">${typeStr} / ${genderStr}</span></div></div></div></div>`; list.innerHTML += `<li class="flex flex-col p-3.5 ${inactiveClass} hover:bg-slate-50 transition-colors border-b border-slate-50 cursor-pointer" onclick="toggleMemberInfo(${m.id})"><div class="flex justify-between items-center gap-3 flex-wrap sm:flex-nowrap w-full"><div class="flex items-center gap-3 flex-1">${photoHtml}<div><div class="flex items-center gap-1.5"><span class="font-extrabold text-slate-800 text-[13px]">${escapeHTML(m.name)}</span> <span class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-bold">${m.handicap}부</span>${badge}</div><div class="text-[11px] text-slate-400 mt-1 font-medium">${infoStr}</div></div></div>${adminButtons}</div>${detailsHtml}</li>`; }); }
        function editMember(id) { const member = members.find(m => m.id === id); if(!member) return; editingMemberId = id; document.getElementById('form-title').innerText = "✏️ 회원 정보 수정"; document.getElementById('btn-save-member').innerText = "수정 완료"; document.getElementById('btn-save-member').classList.replace('bg-slate-800', 'bg-indigo-600'); document.getElementById('btn-cancel-edit').classList.remove('hidden'); document.getElementById('mem-affiliation').value = member.affiliation || '시'; document.getElementById('mem-dept').value = member.dept || ''; document.getElementById('mem-type').value = member.type || '연회원'; document.getElementById('mem-duty').value = member.duty || ''; document.getElementById('mem-rank').value = member.rank || ''; document.getElementById('mem-name').value = member.name || ''; document.getElementById('mem-handicap').value = member.handicap || '5'; document.getElementById('mem-gender').value = member.gender || '남'; document.getElementById('mem-status').value = member.status || 'active'; document.getElementById('mem-phone').value = member.phone || ''; currentPhotoBase64 = member.photo || ''; if (currentPhotoBase64) { document.getElementById('photo-preview').src = currentPhotoBase64; document.getElementById('photo-preview').classList.remove('hidden'); document.getElementById('photo-placeholder').classList.add('hidden'); } else { document.getElementById('photo-preview').classList.add('hidden'); document.getElementById('photo-placeholder').classList.remove('hidden'); } document.getElementById('member-form-container').scrollIntoView({ behavior: 'smooth' }); }
        function saveMember() { const name = document.getElementById('mem-name').value; if(!name) { alert("이름을 입력해주세요."); return; } const handicapVal = document.getElementById('mem-handicap').value; const memberData = { name: name, affiliation: document.getElementById('mem-affiliation').value, dept: document.getElementById('mem-dept').value, type: document.getElementById('mem-type').value, duty: document.getElementById('mem-duty').value, rank: document.getElementById('mem-rank').value, handicap: parseInt(handicapVal) || 5, gender: document.getElementById('mem-gender').value, phone: document.getElementById('mem-phone').value, photo: currentPhotoBase64, status: document.getElementById('mem-status').value }; if (editingMemberId !== null) { const index = members.findIndex(m => m.id === editingMemberId); if(index !== -1) members[index] = { ...members[index], ...memberData }; alert('회원 정보가 수정되었습니다.'); } else { memberData.id = nextMemberId++; memberData.score = 0.0; memberData.prevRank = members.length + 1; members.push(memberData); alert('신규 회원이 등록되었습니다.'); } cancelEdit(); renderAll(); saveDataToStorage(); }
        function cancelEdit() { editingMemberId = null; document.getElementById('form-title').innerText = "회원 개별 등록"; document.getElementById('btn-save-member').innerText = "회원 저장하기"; document.getElementById('btn-save-member').classList.replace('bg-indigo-600', 'bg-slate-800'); document.getElementById('btn-cancel-edit').classList.add('hidden'); ['mem-name','mem-dept','mem-duty','mem-rank','mem-phone'].forEach(id => document.getElementById(id).value = ''); document.getElementById('mem-affiliation').value = '시'; document.getElementById('mem-type').value = '연회원'; document.getElementById('mem-handicap').value = '5'; document.getElementById('mem-gender').value = '남'; document.getElementById('mem-status').value = 'active'; currentPhotoBase64 = ''; document.getElementById('photo-preview').classList.add('hidden'); document.getElementById('photo-placeholder').classList.remove('hidden'); document.getElementById('mem-photo').value = ''; }
        
        function handlePhotoUpload(event) { 
            const file = event.target.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                const img = new Image(); 
                img.onload = function() { 
                    const canvas = document.createElement('canvas'); 
                    const MAX_WIDTH = 80; const MAX_HEIGHT = 80; 
                    let width = img.width; let height = img.height; 
                    if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } } 
                    canvas.width = width; canvas.height = height; 
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); 
                    currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.5); 
                    document.getElementById('photo-preview').src = currentPhotoBase64; document.getElementById('photo-preview').classList.remove('hidden'); document.getElementById('photo-placeholder').classList.add('hidden'); 
                }; 
                img.src = e.target.result; 
            }; 
            reader.readAsDataURL(file); 
        }

        function deleteMember(id) { const mem = members.find(m=>m.id===id); if(confirm(`⚠️ [${mem.name}] 회원을 완전히 삭제하시겠습니까?`)) { members = members.filter(m => m.id !== id); renderAll(); saveDataToStorage(); } }
        
        function downloadRankingExcel() { 
            try { 
                const targetMembers = currentSeasonData || members;
                const activeMembers = targetMembers.filter(m => m.status !== 'inactive'); 
                if(activeMembers.length === 0) return; 
                const data = activeMembers.map(m => ({"순위": m.currentRank, "이름": m.name, "부수": m.handicap + "부", "소속": m.affiliation, "총점": m.score.toFixed(1), "연락처": m.phone || "-"})); 
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "현재 랭킹"); XLSX.writeFile(wb, `탁구리그_순위_${new Date().toISOString().substring(0,10)}.xlsx`); 
            } catch(e) { alert("다운로드 실패"); } 
        }
        
        function saveMatch() { if(!formState.attend || formState.attend.length === 0) { alert("최소 1명 이상의 참석자가 선택되어야 합니다."); return; } let clonedState = {}; for(let k in formState) { clonedState[k] = [...(formState[k] || [])]; } const matchData = { id: editingMatchId ? editingMatchId : nextMatchId++, date: document.getElementById('match-date').value || new Date().toISOString().substring(0, 10), type: document.getElementById('match-type').value || '정기모임', ...clonedState }; if(editingMatchId) { const index = matchHistory.findIndex(m => m.id === editingMatchId); if(index !== -1) matchHistory[index] = matchData; alert('기록이 수정되었습니다!'); } else { matchHistory.push(matchData); alert('결과가 저장되었습니다!'); } editingMatchId = null; document.getElementById('input-form-title').innerText = "1. 모임 기본 정보 입력"; document.getElementById('input-step-1').classList.remove('hidden'); document.getElementById('input-step-2').classList.add('hidden'); initFormState(); renderAll(); saveDataToStorage(); switchTab('history'); }
        function openInputStep2() { const dateStr = document.getElementById('match-date').value; const typeStr = document.getElementById('match-type').value; document.getElementById('display-match-info').innerText = `${dateStr} | ${typeStr}`; document.getElementById('input-step-1').classList.add('hidden'); document.getElementById('input-step-2').classList.remove('hidden'); if(!editingMatchId) initFormState(); }
        function cancelInputStep2() { document.getElementById('input-step-1').classList.remove('hidden'); document.getElementById('input-step-2').classList.add('hidden'); if(editingMatchId) { editingMatchId = null; document.getElementById('input-form-title').innerText = "1. 모임 기본 정보 입력"; initFormState(); switchTab('history'); } }
        function editMatch(id) { const match = matchHistory.find(m => m.id === id); if(!match) return; editingMatchId = id; switchTab('input'); document.getElementById('input-form-title').innerText = "✏️ 모임 정보 수정"; document.getElementById('match-date').value = match.date; document.getElementById('match-type').value = match.type; for(let key in formState) { formState[key] = match[key] ? [...match[key]] : []; } updateFormUI(); openInputStep2(); }
        function deleteMatch(id) { if(confirm("이 경기 기록을 삭제하시겠습니까?\n이 경기로 얻은 점수들이 회원들의 총점에서 모두 차감됩니다.")) { matchHistory = matchHistory.filter(m => m.id !== id); renderAll(); saveDataToStorage(); alert('기록이 삭제되었습니다.'); } }
        function openAnnouncement(id) { const match = matchHistory.find(m => m.id === id); if(!match) return; let text = appConfig.announcePrefix.replace('{date}', match.date).replace('{type}', match.type); text += `\n[ 👥 참석자 명단 - 총 ${(match.attend||[]).length}명 ]\n`; text += `${(match.attend||[]).join(', ')}\n`; if(match.lazy && match.lazy.length > 0) { text += `\n[ 🚨 지각/불성실 ]\n${(match.lazy||[]).join(', ')}\n`; } let hasResults = false; let resultText = `\n[ 🏆 경기 결과 ]\n`; const addResult = (title, arr) => { if(arr && arr.length > 0) { resultText += `▪️ ${title} : ${arr.join(', ')}\n`; hasResults = true; } }; addResult("개인전 1위", match.lg1); addResult("개인전 2위", match.lg2); addResult("개인전 3위", match.lg3); addResult("단체전 1위", match.tm1); addResult("단체전 2위", match.tm2); addResult("단체전 3위", match.tm3); addResult("토너먼트 1위", match.tn1); addResult("토너먼트 2위", match.tn2); addResult("토너먼트 3위", match.tn3); addResult("복식 1위", match.db1); addResult("복식 2위", match.db2); addResult("이벤트 우승", match.ev1); if(hasResults) { text += resultText; } text += '\n' + appConfig.announceSuffix; document.getElementById('announcement-text').value = text; document.getElementById('announcement-modal').classList.remove('hidden'); }
        function closeAnnouncement() { document.getElementById('announcement-modal').classList.add('hidden'); }
        function copyAnnouncement() { const textToCopy = document.getElementById('announcement-text').value; if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(textToCopy).then(() => { alert('카카오톡용 공지가 복사되었습니다!\n카톡 대화창에 붙여넣기 해주세요.'); }); } else { const textArea = document.getElementById('announcement-text'); textArea.select(); document.execCommand('copy'); alert('카카오톡용 공지가 복사되었습니다!\n카톡 대화창에 붙여넣기 해주세요.'); } }
        function generateTeams() { if((formState.attend||[]).length < 2) { alert("조를 편성하려면 먼저 [입력]탭의 [오늘 참석자] 명단을 선택해 주세요."); return; } let players = formState.attend.map(name => { const member = members.find(m => m.name === name); return { name: name, handicap: member ? member.handicap : 5 }; }); players.sort((a, b) => a.handicap - b.handicap); let teams = []; let left = 0; let right = players.length - 1; while(left < right) { teams.push([players[left], players[right]]); left++; right--; } if (left === right) { teams.push([players[left]]); } let resultHtml = `<div class="font-extrabold mb-4 text-indigo-900 border-b border-indigo-200/50 pb-3 text-center bg-white rounded-xl p-3 shadow-sm text-sm">🔥 총 ${formState.attend.length}명 참여 / ${teams.length}개 조 편성 완료</div>`; teams.forEach((team, idx) => { const sumHandicap = team.reduce((sum, p) => sum + p.handicap, 0); const namesStr = team.map(p => `<span class="font-bold">${escapeHTML(p.name)}</span><span class="text-slate-400 font-normal">(${p.handicap})</span>`).join(' <span class="text-slate-300">+</span> '); resultHtml += `<div class="mb-2 bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm"><span class="font-black text-white bg-indigo-500 px-2 py-1 rounded-lg text-[11px] mr-2 shadow-sm">${idx+1}조</span> <span class="flex-1 text-right text-[13px] tracking-tight">${namesStr}</span> <span class="text-[10px] text-indigo-700 font-extrabold ml-3 bg-indigo-50 px-2 py-1 rounded-lg border border-indigo-100 whitespace-nowrap">합 ${sumHandicap}부</span></div>`; }); document.getElementById('team-result-box').innerHTML = resultHtml; document.getElementById('team-maker-modal').classList.remove('hidden'); }
        function closeTeamMaker() { document.getElementById('team-maker-modal').classList.add('hidden'); }
        function copyTeams() { const tempDiv = document.createElement("div"); tempDiv.innerHTML = document.getElementById('team-result-box').innerHTML.replace(/<\/div>/g, '\n').replace(/<[^>]*>?/gm, ''); const textArea = document.createElement("textarea"); textArea.value = tempDiv.textContent || tempDiv.innerText || ""; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); alert('조 편성 결과가 복사되었습니다!'); }
        function loadSettingsUI() { for (let key in scoreRules) { if(document.getElementById(`cfg-score-${key}`)) { document.getElementById(`cfg-score-${key}`).value = scoreRules[key]; } } document.getElementById('cfg-announce-prefix').value = appConfig.announcePrefix; document.getElementById('cfg-announce-suffix').value = appConfig.announceSuffix; document.getElementById('cfg-default-tab').value = appConfig.defaultTab; }
        function saveScoreRules() { for (let key in scoreRules) { let val = parseFloat(document.getElementById(`cfg-score-${key}`).value); if(!isNaN(val)) scoreRules[key] = val; } recalculateAllScores(); renderAll(); saveDataToStorage(); alert("점수 체계가 저장되었으며, 과거 기록이 새 규칙에 맞게 재계산되었습니다."); }
        function saveUIConfig() { appConfig.announcePrefix = document.getElementById('cfg-announce-prefix').value; appConfig.announceSuffix = document.getElementById('cfg-announce-suffix').value; appConfig.defaultTab = document.getElementById('cfg-default-tab').value; saveDataToStorage(); alert("환경 설정이 저장되었습니다."); }
        function changePassword() { const newPw = document.getElementById('cfg-password').value; if(newPw.trim() === '') { alert("비밀번호를 입력하세요."); return; } appConfig.password = newPw; document.getElementById('cfg-password').value = ''; saveDataToStorage(); alert("관리자 비밀번호가 성공적으로 변경되었습니다."); }
        
        // 🌟 기능 추가: 시즌 보관 및 드롭다운 관리
        function updateSeasonSelector() {
            const sel = document.getElementById('season-selector');
            sel.innerHTML = `<option value="current">📍 현재 진행중인 시즌</option>`;
            if(appConfig.pastSeasons && appConfig.pastSeasons.length > 0) {
                appConfig.pastSeasons.forEach((season, index) => {
                    sel.innerHTML += `<option value="${index}">📂 ${escapeHTML(season.name)}</option>`;
                });
            }
        }
        function changeSeason(val) {
            if(val === 'current') {
                currentSeasonData = null;
                renderRanking();
            } else {
                currentSeasonData = appConfig.pastSeasons[val].members;
                renderRanking(currentSeasonData);
            }
        }
        function startNewSeason() { 
            const sName = document.getElementById('cfg-season-name').value.trim();
            if(!sName) { alert("보관될 기존 시즌의 이름을 먼저 입력해주세요."); return; }
            if(confirm(`현재까지의 랭킹과 경기 기록을 [${sName}] 이라는 이름으로 보관소에 저장하고 새 시즌을 시작하시겠습니까?\n(모든 점수가 0으로 리셋됩니다.)`)) { 
                
                // 기존 데이터 딥카피하여 저장
                const archivedMembers = JSON.parse(JSON.stringify(members));
                const archivedMatches = JSON.parse(JSON.stringify(matchHistory));
                if(!appConfig.pastSeasons) appConfig.pastSeasons = [];
                appConfig.pastSeasons.push({ name: sName, members: archivedMembers, matchHistory: archivedMatches });

                // 리셋
                matchHistory = []; 
                members.forEach(m => { m.score = 0; m.prevRank = 1; m.currentRank = 1; m.stats = { attend:0, gold:0, silver:0, bronze:0 }; }); 
                
                document.getElementById('cfg-season-name').value = '';
                updateSeasonSelector();
                renderAll(); 
                saveDataToStorage(); 
                alert("새 시즌이 힘차게 시작되었습니다!"); 
                switchTab('ranking'); 
            } 
        }

        function recalculateAllScores() { 
            members.forEach(m => { 
                m.score = 0; 
                // 🌟 기능 추가: 출석 및 메달 통계 초기화
                m.stats = { attend: 0, gold: 0, silver: 0, bronze: 0, sincerityScore: 0, attendScore: 0, winScore: 0 }; 
            }); 
            
            const sortedMatches = [...matchHistory].sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0)); 
            if (sortedMatches.length === 0) { members.forEach(m => { m.prevRank = 1; m.currentRank = 1; }); return; } 
            
            sortedMatches.forEach((match, index) => { 
                const addScore = (nameArr, points, medalType) => { 
                    (nameArr || []).forEach(name => { 
                        const m = members.find(x => x.name === name); 
                        if(m) {
                            if (m.type === '연회원') { m.score += points; m.stats.winScore += points; }
                            if (medalType) m.stats[medalType]++;
                        }
                    }); 
                }; 
                
                (match.attend || []).forEach(name => { 
                    const m = members.find(x => x.name === name); 
                    if(m) {
                        m.stats.attend++;
                        if(m.type === '연회원') { 
                            m.score += scoreRules.attend; 
                            m.stats.attendScore += scoreRules.attend;
                            if(!(match.lazy || []).includes(name)) {
                                m.score += scoreRules.sincerity; 
                                m.stats.sincerityScore += scoreRules.sincerity;
                            }
                        }
                    }
                }); 
                
                // 1등: gold, 2등: silver, 3등: bronze 매핑
                addScore(match.lg1, scoreRules.lg1, 'gold'); addScore(match.lg2, scoreRules.lg2, 'silver'); addScore(match.lg3, scoreRules.lg3, 'bronze'); 
                addScore(match.tm1, scoreRules.tm1, 'gold'); addScore(match.tm2, scoreRules.tm2, 'silver'); addScore(match.tm3, scoreRules.tm3, 'bronze'); 
                addScore(match.tn1, scoreRules.tn1, 'gold'); addScore(match.tn2, scoreRules.tn2, 'silver'); addScore(match.tn3, scoreRules.tn3, 'bronze'); 
                addScore(match.db1, scoreRules.db1, 'gold'); addScore(match.db2, scoreRules.db2, 'silver'); 
                addScore(match.ev1, scoreRules.ev1, 'gold'); 
                
                if (index === sortedMatches.length - 2) { 
                    const tempSort = [...members].filter(m => m.type === '연회원').sort((a, b) => b.score - a.score); 
                    for (let i = 0; i < tempSort.length; i++) { 
                        if (i > 0 && tempSort[i].score === tempSort[i-1].score) tempSort[i].prevRank = tempSort[i-1].prevRank; 
                        else tempSort[i].prevRank = i + 1; 
                    } 
                } 
            }); 
            
            members.sort((a, b) => b.score - a.score); 
            let annualMembers = members.filter(m => m.type === '연회원'); 
            annualMembers.sort((a, b) => b.score - a.score); 
            for(let i=0; i<annualMembers.length; i++) { 
                if (i > 0 && annualMembers[i].score === annualMembers[i-1].score) annualMembers[i].currentRank = annualMembers[i-1].currentRank; 
                else annualMembers[i].currentRank = i + 1; 
            } 
            members.forEach(m => { if(m.type !== '연회원') m.currentRank = '-'; }); 
            if (sortedMatches.length === 1) { members.forEach(m => m.prevRank = m.currentRank); } 
        }

        // 🌟 랭킹 뷰 업데이트 (입상 및 통계 열 추가 / 0점 숨김)
        function renderRanking(targetMembers = null) { 
            const isPastSeason = targetMembers !== null;
            const dataToRender = targetMembers || members;

            const tbody = document.getElementById('ranking-table-body'); tbody.innerHTML = ''; 
            // 🌟 누적 0점 회원 숨김 처리 추가 (m.score > 0)
            const activeMembers = dataToRender.filter(m => m.status !== 'inactive' && m.type === '연회원' && m.score > 0); 
            
            if(activeMembers.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="5" class="py-16 text-center"><div class="text-5xl mb-4 drop-shadow-sm">📭</div><p class="font-extrabold text-slate-700 text-base">점수를 획득한 연회원이 없습니다</p><p class="text-xs mt-2 text-slate-400">경기 기록이 입력되면 표시됩니다.</p></td></tr>`; 
                return; 
            } 
            
            const topScore = activeMembers.length > 0 ? activeMembers[0].score : 0; 
            
            activeMembers.forEach((m, index) => { 
                let rankDisplay = m.currentRank; 
                if (m.currentRank === 1) rankDisplay = `<div class="w-7 h-7 mx-auto bg-gradient-to-br from-yellow-300 to-yellow-500 text-white rounded-full flex items-center justify-center font-extrabold shadow-[0_2px_10px_rgba(234,179,8,0.4)]">1</div>`; 
                else if (m.currentRank === 2) rankDisplay = `<div class="w-6 h-6 mx-auto bg-gradient-to-br from-slate-300 to-slate-400 text-white rounded-full flex items-center justify-center font-bold shadow-[0_2px_10px_rgba(148,163,184,0.4)]">2</div>`; 
                else if (m.currentRank === 3) rankDisplay = `<div class="w-6 h-6 mx-auto bg-gradient-to-br from-orange-400 to-orange-600 text-white rounded-full flex items-center justify-center font-bold shadow-[0_2px_10px_rgba(234,88,12,0.4)]">3</div>`; 
                else if(index > 0 && activeMembers[index-1].currentRank === m.currentRank) rankDisplay = `<span class="text-slate-300 font-medium">-</span>`; 
                else rankDisplay = `<span class="text-slate-500 font-extrabold">${m.currentRank}</span>`; 
                
                let stats = m.stats || { attend: 0, gold: 0, silver: 0, bronze: 0 };
                let medalsHtml = `<div class="flex flex-col items-center gap-0.5 text-[9px] font-bold"><span class="text-yellow-500">🥇${stats.gold}</span><span class="text-slate-400">🥈${stats.silver}</span><span class="text-orange-400">🥉${stats.bronze}</span></div>`;

                // 과거 시즌은 상세 정보 토글을 비활성화
                const onclickEvent = isPastSeason ? "" : `onclick="toggleMemberDetail(${m.id})" class="bg-white hover:bg-indigo-50/50 cursor-pointer transition-colors border-b border-slate-50"`;
                
                tbody.innerHTML += `<tr ${onclickEvent} ${isPastSeason ? 'class="bg-white border-b border-slate-50"' : ''}>
                    <td class="py-3.5 text-center align-middle">${rankDisplay}</td>
                    <td class="px-1 py-3.5 text-slate-800 font-extrabold text-[12px] whitespace-nowrap overflow-hidden text-ellipsis">${escapeHTML(m.name)}<span class="text-[9px] text-slate-400 font-medium ml-1 bg-slate-50 px-1 rounded">${m.handicap}부</span></td>
                    <td class="px-1 py-3.5 text-center font-bold text-slate-600 text-[11px]">${stats.attend}회</td>
                    <td class="px-0 py-3.5 align-middle">${medalsHtml}</td>
                    <td class="px-1 py-3.5 text-right font-black text-indigo-600 text-sm tracking-tighter">${m.score.toFixed(1)}</td>
                </tr>
                <tr id="detail-row-${m.id}" class="hidden detail-row"><td colspan="5" class="p-0 border-0" id="detail-content-${m.id}"></td></tr>`; 
            }); 
        }

        // 🌟 개인 통계 UI 개편 반영
        function toggleMemberDetail(id) { 
            const detailRow = document.getElementById(`detail-row-${id}`); 
            if (!detailRow.classList.contains('hidden')) { detailRow.classList.add('hidden'); return; } 
            
            document.querySelectorAll('.detail-row').forEach(row => row.classList.add('hidden')); 
            const member = members.find(m => m.id === id); 
            const memberMatches = matchHistory.filter(match => (match.attend||[]).includes(member.name)); 
            
            let attendScore = 0; let sincerityScore = 0; let winScore = 0; let winCount = 0; 
            let historyListHtml = ''; 
            
            if (memberMatches.length === 0) { 
                historyListHtml = `<p class="text-xs text-slate-400 py-6 text-center bg-white rounded-xl border border-slate-100">참여한 경기 기록이 없습니다.</p>`; 
            } else { 
                historyListHtml = `<ul class="space-y-2">`; 
                memberMatches.sort((a,b) => new Date(b.date||0) - new Date(a.date||0)).forEach(match => { 
                    let dAtt = scoreRules.attend; let dSin = 0.0; let dWin = 0.0; let achievements = []; 
                    if (member.type === '연회원') { 
                        dAtt = scoreRules.attend; 
                        if (!(match.lazy||[]).includes(member.name)) { dSin = scoreRules.sincerity; } 
                        else { achievements.push("<span class='text-red-500'>불성실</span>"); } 
                    } else { dAtt = 0; dSin = 0; } 
                    
                    const checkWin = (arr, pts, label) => { 
                        if(arr && arr.includes(member.name)) { achievements.push(label); if(member.type === '연회원') dWin += pts; winCount++; } 
                    }; 
                    checkWin(match.lg1, scoreRules.lg1, "리그 1등"); checkWin(match.lg2, scoreRules.lg2, "리그 2등"); checkWin(match.lg3, scoreRules.lg3, "리그 3등"); 
                    checkWin(match.tm1, scoreRules.tm1, "단체 1등"); checkWin(match.tm2, scoreRules.tm2, "단체 2등"); checkWin(match.tm3, scoreRules.tm3, "단체 3등"); 
                    checkWin(match.tn1, scoreRules.tn1, "토너 1등"); checkWin(match.tn2, scoreRules.tn2, "토너 2등"); checkWin(match.tn3, scoreRules.tn3, "토너 3등"); 
                    checkWin(match.db1, scoreRules.db1, "복식 1등"); checkWin(match.db2, scoreRules.db2, "복식 2등"); checkWin(match.ev1, scoreRules.ev1, "이벤트 우승"); 
                    
                    attendScore += dAtt; sincerityScore += dSin; winScore += dWin; 
                    
                    let achieveStr = achievements.length > 0 ? ` <span class="text-indigo-600 font-bold ml-1">(${achievements.join(', ')})</span>` : ""; 
                    historyListHtml += `<li class="flex flex-col bg-white p-3 rounded-xl border border-indigo-100 shadow-[0_2px_10px_rgb(0,0,0,0.02)]"><div class="flex justify-between items-center mb-1.5 border-b border-slate-50 pb-1.5"><div><span class="font-extrabold text-slate-800 text-[13px]">${(match.date||'').substring(5)}</span> <span class="text-[9px] text-slate-500 ml-1 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">${escapeHTML(match.type)}</span></div><div class="font-black text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-lg text-[13px]">+${(dAtt+dSin+dWin).toFixed(1)}</div></div><div class="text-[11px] text-slate-500 flex flex-wrap gap-x-2 gap-y-1 font-medium"><span>참석 <span class="font-bold text-slate-700">+${dAtt.toFixed(1)}</span></span><span class="text-slate-200">|</span><span>성실 <span class="font-bold ${dSin > 0 ? 'text-slate-700' : 'text-red-400'}">+${dSin.toFixed(1)}</span></span><span class="text-slate-200">|</span><span>입상 <span class="font-bold text-indigo-500">+${dWin.toFixed(1)}</span> ${achieveStr}</span></div></li>`; 
                }); 
                historyListHtml += `</ul>`; 
            } 
            
            let stats = member.stats || { attend:0 };
            let rankDiff = (member.prevRank === '-' || member.currentRank === '-') ? 0 : member.prevRank - member.currentRank; 
            let rankIcon = rankDiff > 0 ? `🔺 ${rankDiff} 상승` : rankDiff < 0 ? `🔻 ${Math.abs(rankDiff)} 하락` : "➖ 유지"; 
            
            let detailHtml = `<div class="p-3 bg-slate-100/50 border-b border-slate-200 shadow-inner animate-fade-in">
                <div class="bg-white rounded-2xl border border-slate-100 p-4 mb-3 shadow-[0_4px_20px_rgb(0,0,0,0.03)]">
                    <div class="flex justify-between items-center border-b border-slate-100 pb-2 mb-3">
                        <span class="font-extrabold text-slate-700 text-xs">📊 누적 점수 산출 근거</span>
                        <span class="font-black text-indigo-600 text-lg">${member.score.toFixed(1)}점</span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 text-center text-[10px] mb-3">
                        <div class="bg-slate-50 rounded-xl p-2 border border-slate-100">
                            <div class="text-slate-500 mb-1 font-bold">참석 ${stats.attend}회</div>
                            <div class="font-black text-slate-700 text-sm">${attendScore.toFixed(1)}점</div>
                        </div>
                        <div class="bg-slate-50 rounded-xl p-2 border border-slate-100">
                            <div class="text-slate-500 mb-1 font-bold">성실 ${stats.attend}회</div>
                            <div class="font-black text-slate-700 text-sm">${sincerityScore.toFixed(1)}점</div>
                        </div>
                        <div class="bg-indigo-50 rounded-xl p-2 border border-indigo-100">
                            <div class="text-indigo-600 mb-1 font-bold">입상 ${winCount}회</div>
                            <div class="font-black text-indigo-700 text-sm">${winScore.toFixed(1)}점</div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center text-[11px] bg-slate-50 p-2.5 rounded-xl font-medium border border-slate-100 mt-2">
                        <div><span class="text-slate-400">이전:</span> <span class="font-extrabold text-slate-600">${member.prevRank}위</span></div>
                        <div><span class="text-slate-400">현재:</span> <span class="font-black text-indigo-600">${member.currentRank}위</span></div>
                        <div class="font-extrabold ${rankDiff > 0 ? 'text-red-500' : rankDiff < 0 ? 'text-blue-500' : 'text-slate-400'} bg-white px-2.5 py-1 rounded-lg shadow-sm border border-slate-100">${rankIcon}</div>
                    </div>
                </div>
                <h4 class="font-extrabold text-slate-700 text-xs mb-2.5 pl-1">🔍 상세 경기 참석 내역</h4>
                ${historyListHtml}
            </div>`; 
            
            document.getElementById(`detail-content-${id}`).innerHTML = detailHtml; 
            detailRow.classList.remove('hidden'); 
        }

        function renderHistory() { const list = document.getElementById('match-history-list'); list.innerHTML = ''; if(matchHistory.length === 0) { list.innerHTML = `<tr><td colspan="3" class="text-center py-16"><div class="text-5xl mb-4 drop-shadow-sm opacity-80">🏓</div><p class="font-extrabold text-slate-700 text-base">아직 진행된 경기가 없습니다</p><p class="text-xs mt-2 text-slate-400">입력 탭에서 첫 경기를 기록해 보세요!</p></td></tr>`; return; } [...matchHistory].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)).forEach(match => { let winHtml = ''; const addBadge = (arr, label, bgClass) => { if(arr && arr.length > 0) { winHtml += `<div class="flex items-start gap-1.5 mb-1.5"><span class="shrink-0 text-[10px] font-extrabold text-white ${bgClass} px-1.5 py-0.5 rounded shadow-sm text-center">${label}</span> <span class="text-slate-700 font-bold text-[12px] break-keep leading-tight pt-0.5">${arr.map(escapeHTML).join(', ')}</span></div>`; } }; addBadge(match.lg1, '리그1위', 'bg-indigo-600'); addBadge(match.lg2, '리그2위', 'bg-indigo-500'); addBadge(match.lg3, '리그3위', 'bg-indigo-400'); addBadge(match.tm1, '단체1위', 'bg-teal-600'); addBadge(match.tm2, '단체2위', 'bg-teal-500'); addBadge(match.tm3, '단체3위', 'bg-teal-400'); addBadge(match.tn1, '토너1위', 'bg-violet-600'); addBadge(match.tn2, '토너2위', 'bg-violet-500'); addBadge(match.tn3, '토너3위', 'bg-violet-400'); addBadge(match.db1, '복식1위', 'bg-pink-600'); addBadge(match.db2, '복식2위', 'bg-pink-500'); addBadge(match.ev1, '이벤트', 'bg-amber-500'); if(!winHtml) winHtml = '<div class="text-[11px] text-slate-400 font-medium py-1">입상 기록 없음</div>'; let lazyHtml = ''; if(match.lazy && match.lazy.length > 0) { lazyHtml = `<div class="mt-2 pt-2 border-t border-slate-200/60 flex items-start gap-1"><span class="shrink-0 text-[10px] font-extrabold text-red-500 mr-0.5 mt-0.5">🚨 불성실</span><span class="text-[11px] text-slate-600 font-bold leading-tight pt-0.5">${match.lazy.map(escapeHTML).join(', ')}</span></div>`; } const adminButtons = `<div class="flex flex-col gap-1.5 items-center"><button onclick="openAnnouncement(${match.id})" class="w-full px-2 py-1.5 bg-indigo-50 text-indigo-700 text-[10px] rounded-lg border border-indigo-100 hover:bg-indigo-100 font-extrabold shadow-sm btn-press">공지</button><button onclick="editMatch(${match.id})" class="w-full px-2 py-1.5 bg-white text-slate-600 text-[10px] rounded-lg border border-slate-200 hover:bg-slate-50 font-extrabold shadow-sm btn-press">수정</button><button onclick="deleteMatch(${match.id})" class="w-full px-2 py-1.5 bg-red-50 text-red-600 text-[10px] rounded-lg border border-red-100 hover:bg-red-100 font-extrabold shadow-sm btn-press">삭제</button></div>`; let displayDate = match.date ? escapeHTML(match.date.substring(5)) : '미정'; list.innerHTML += `<tr class="bg-white hover:bg-slate-50 border-b border-slate-100 transition-colors"><td class="px-2 py-4 text-center align-top whitespace-nowrap pt-5"><div class="font-extrabold text-slate-800 text-[13px]">${displayDate}</div><div class="text-[10px] mt-1.5"><span class="bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200 font-bold">${escapeHTML(match.type) || ''}</span></div></td><td class="px-2 py-4 text-left align-top"><div class="bg-slate-50 p-3 rounded-xl border border-slate-100 mb-2 shadow-inner"><div class="flex justify-between items-center mb-1.5"><span class="text-[10px] font-black text-slate-500">✅ 참석자 명단</span><span class="text-[10px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded font-bold">${(match.attend || []).length}명</span></div><div class="text-[11px] text-slate-700 font-medium leading-relaxed break-keep">${(match.attend || []).map(escapeHTML).join(', ')}</div>${lazyHtml}</div><div class="bg-indigo-50/40 p-3 rounded-xl border border-indigo-50"><div class="text-[10px] font-black text-indigo-800 mb-2.5">🏆 입상 내역</div><div class="flex flex-col">${winHtml}</div></div></td><td class="px-2 py-4 admin-only-table-cell align-middle w-14">${adminButtons}</td></tr>`; }); }

        function renderAll() { recalculateAllScores(); renderRanking(currentSeasonData); renderHistory(); renderMembersList(); }
        loadDataFromStorage();
    </script>
</body>
</html>
