<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ì²œê´‘ì—­ì‹œ íƒêµ¬ë™í˜¸íšŒ í† ìš”ë¦¬ê·¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;700;800&display=swap');
        body { font-family: 'Pretendard', -apple-system, sans-serif; background-color: #f1f5f9; letter-spacing: -0.02em; }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .default-avatar { background-color: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.8rem; }
        
        body:not(.admin-mode-active) .admin-only { display: none !important; }
        body:not(.admin-mode-active) .admin-only-table-cell { display: none !important; }
        .member-inactive { opacity: 0.5; filter: grayscale(100%); }

        .tab-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-active { color: #4f46e5 !important; font-weight: 800; transform: translateY(-4px); }
        .tab-active::after { content: ''; position: absolute; bottom: -4px; width: 4px; height: 4px; background-color: #4f46e5; border-radius: 50%; }
        .tab-icon { font-size: 1.35rem; margin-bottom: 2px; transition: transform 0.2s; }
        .tab-active .tab-icon { transform: scale(1.15); }

        @keyframes slideUpFade { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: slideUpFade 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .btn-press { transition: transform 0.15s ease, box-shadow 0.15s ease; }
        .btn-press:active { transform: scale(0.96); box-shadow: none !important; }
        
        .sheet-handle { width: 40px; height: 5px; background-color: #cbd5e1; border-radius: 10px; margin: 8px auto 16px auto; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }

        .name-chip { display: inline-flex; align-items: center; background-color: #e0e7ff; color: #4338ca; font-size: 0.75rem; font-weight: bold; padding: 0.25rem 0.6rem; border-radius: 9999px; margin: 0.15rem; }
        .name-chip-empty { color: #9ca3af; font-size: 0.75rem; font-weight: 500; padding: 0.25rem; }

        /* ëŒ€ì§„í‘œìš© ìŠ¤íƒ€ì¼ */
        .bracket-line { border-right: 2px solid #cbd5e1; border-top: 2px solid #cbd5e1; border-bottom: 2px solid #cbd5e1; }
        .bracket-line-left { border-left: 2px solid #cbd5e1; border-top: 2px solid #cbd5e1; border-bottom: 2px solid #cbd5e1; }
        .diagonal-strike { background: linear-gradient(to top right, transparent calc(50% - 1px), #cbd5e1, transparent calc(50% + 1px)); background-color: #f1f5f9; }

        /* ì¸ì‡„ ì „ìš© ìŠ¤íƒ€ì¼ */
        @media print {
            body * { visibility: hidden; }
            #view-operation, #view-operation * { visibility: visible; }
            #view-operation { position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            header, .fixed.bottom-0 { display: none !important; }
        }
    </style>
</head>
<body class="max-w-md mx-auto bg-slate-50 min-h-screen shadow-2xl relative pb-28 overflow-x-hidden" id="app-body">

    <header class="bg-gradient-to-r from-blue-700 to-indigo-600 p-4 text-white flex justify-between items-center relative z-20 shadow-md rounded-b-[2.5rem]">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight">ğŸ“ ì¸ì²œê´‘ì—­ì‹œ íƒêµ¬ë™í˜¸íšŒ</h1>
            <p class="text-[11px] opacity-80 font-medium mt-0.5">í† ìš”ë¦¬ê·¸ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
        </div>
        <button onclick="toggleAdmin()" id="btn-admin-lock" class="bg-white/20 hover:bg-white/30 text-white backdrop-blur-sm p-2 rounded-full transition w-10 h-10 flex items-center justify-center shadow-inner border border-white/20">
            ğŸ”’
        </button>
    </header>

    <div class="relative z-30 mt-4 px-4">
        
        <div id="view-ranking" class="animate-fade-in">
            <div class="flex justify-between items-center mb-3 px-1">
                <span class="text-[11px] text-indigo-600 font-bold bg-white/80 backdrop-blur-sm px-2.5 py-1.5 rounded-lg border border-indigo-100 shadow-sm">ğŸ‘† ì´ë¦„ì„ í„°ì¹˜í•˜ë©´ ìƒì„¸ê¸°ë¡</span>
                <button onclick="downloadRankingExcel()" class="text-[11px] bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg border border-emerald-200 hover:bg-emerald-100 font-extrabold btn-press shadow-sm flex items-center gap-1">
                    ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
            <div class="shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 rounded-2xl bg-white overflow-hidden mb-2">
                <table class="w-full text-sm text-left text-slate-700">
                    <thead class="text-[10px] text-slate-400 uppercase bg-slate-50/80 border-b border-slate-100 font-bold tracking-wider">
                        <tr><th class="px-3 py-3 text-center w-12">ìˆœìœ„</th><th class="px-2 py-3">ì„ ìˆ˜ëª…</th><th class="px-2 py-3 text-right">ì´ì </th><th class="px-2 py-3 text-right w-16">ì ìˆ˜ì°¨</th><th class="px-3 py-3 text-center w-16">ë³€ë™</th></tr>
                    </thead>
                    <tbody id="ranking-table-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <p class="text-[10px] text-slate-400 text-right px-2">â€» ìˆœìœ„ëŠ” <b>ì—°íšŒì›</b> ë“±ê¸‰ë§Œ ì‚°ì •ë©ë‹ˆë‹¤.</p>
        </div>

        <div id="view-operation" class="hidden animate-fade-in pb-10">
            <div class="flex justify-between items-center mb-4 ml-1">
                <h2 class="font-bold text-lg text-gray-800 tracking-tight">ğŸ“ ê²½ê¸° ì§„í–‰ ë° ëŒ€ì§„í‘œ</h2>
                <button onclick="printBrackets()" class="text-[11px] bg-slate-800 text-white px-3 py-1.5 rounded-lg font-bold shadow-md btn-press no-print">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
            </div>
            
            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                    <h3 class="font-extrabold text-slate-700">ğŸ“ ì˜ˆì„  ë¦¬ê·¸ì „í‘œ</h3>
                    <div class="flex items-center gap-2 no-print">
                        <select id="op-group-size" class="text-xs border border-slate-200 rounded-lg p-1.5 bg-slate-50 font-bold">
                            <option value="3">3ëª…</option>
                            <option value="4" selected>4ëª…</option>
                            <option value="5">5ëª…</option>
                            <option value="6">6ëª…</option>
                        </select>
                        <button onclick="renderGroupTable()" class="text-[10px] bg-indigo-600 text-white px-3 py-1.5 rounded-lg font-bold shadow-sm btn-press">ìƒì„±</button>
                    </div>
                </div>
                <div id="op-group-container" class="overflow-x-auto">
                    <div class="text-center text-slate-400 text-xs py-8 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                        ì¸ì›ìˆ˜ë¥¼ ì„ íƒí•˜ê³  ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                    <h3 class="font-extrabold text-slate-700">âš”ï¸ ë³¸ì„  ëŒ€ì§„í‘œ</h3>
                    <div class="flex items-center gap-2 no-print">
                        <select id="op-tourn-size" class="text-xs border border-slate-200 rounded-lg p-1.5 bg-slate-50 font-bold">
                            <option value="4">4ê°•</option>
                            <option value="8" selected>8ê°•</option>
                            <option value="16">16ê°•</option>
                        </select>
                        <button onclick="renderTournament()" class="text-[10px] bg-rose-600 text-white px-3 py-1.5 rounded-lg font-bold shadow-sm btn-press">ìƒì„±</button>
                    </div>
                </div>
                <div id="op-tourn-container" class="overflow-x-auto min-h-[200px]">
                    <div class="text-center text-slate-400 text-xs py-8 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                        ê°•ìˆ˜ë¥¼ ì„ íƒí•˜ê³  ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                    </div>
                </div>
            </div>
        </div>

        <div id="view-history" class="hidden animate-fade-in">
            <h2 class="font-bold text-lg mb-4 text-gray-800 tracking-tight ml-1">ì €ì¥ëœ ê²½ê¸° ê¸°ë¡</h2>
            <div class="shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 rounded-2xl bg-white overflow-hidden">
                <table class="w-full text-sm text-center text-slate-700">
                    <thead class="text-xs text-slate-500 uppercase bg-gray-50 border-b border-gray-200">
                        <tr><th class="px-2 py-3 w-20">ë‚ ì§œ/ì¢…ë¥˜</th><th class="px-2 py-3 text-left">ì°¸ì„ ë° ì…ìƒ ë‚´ì—­</th><th class="px-2 py-3 admin-only-table-cell w-16">ê¸°ëŠ¥</th></tr>
                    </thead>
                    <tbody id="match-history-list" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <div id="view-input" class="hidden admin-only-block animate-fade-in">
            <div id="input-step-1" class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-4">
                <h2 id="input-form-title" class="font-extrabold text-xl mb-5 text-slate-800 tracking-tight">1. ëª¨ì„ ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>
                <div class="mb-5"><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ë‚ ì§œ ì„ íƒ</label><input type="date" id="match-date" class="block w-full border-0 bg-slate-100 p-3.5 rounded-xl font-medium text-slate-700 focus:ring-2 focus:ring-indigo-500 transition-all"></div>
                <div class="mb-8"><label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">ëª¨ì„ ì¢…ë¥˜</label><select id="match-type" class="block w-full border-0 bg-slate-100 p-3.5 rounded-xl font-medium text-slate-700 focus:ring-2 focus:ring-indigo-500 transition-all"><option>ì •ê¸°ëª¨ì„</option><option>ì›”ë¡€ëŒ€íšŒ</option><option>êµë¥˜ì „</option></select></div>
                <button onclick="openInputStep2()" class="w-full bg-gradient-to-r from-indigo-500 to-violet-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-xl transition-all btn-press text-lg">ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™ ğŸ‘‰</button>
            </div>
            
            <div id="input-step-2" class="hidden mt-2 bg-gray-50 p-4 rounded-xl border border-indigo-200 shadow-inner mb-6">
                <div class="flex justify-between items-center mb-4 pl-1"><h2 class="font-extrabold text-lg text-indigo-800">2. ìƒì„¸ ê²°ê³¼ ì„ íƒ</h2><span id="display-match-info" class="text-xs text-indigo-700 font-bold bg-indigo-100/50 px-3 py-1.5 rounded-full"></span></div>
                
                <div class="mb-5 bg-white p-4 border rounded-xl border-gray-200 shadow-sm relative">
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <label class="block text-sm font-extrabold text-gray-800">âœ… ì˜¤ëŠ˜ ì°¸ì„ì</label>
                        <div class="flex gap-1">
                            <button onclick="generateTeams()" class="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-200 font-bold hover:bg-indigo-100 btn-press">ğŸ¤– ì¡°í¸ì„±</button>
                            <button onclick="openSelector('attend', 'ì˜¤ëŠ˜ ì°¸ì„ì ì„ íƒ', false)" class="text-[10px] bg-blue-600 text-white px-2 py-1 rounded shadow-sm font-bold btn-press">ëª…ë‹¨ ì„ íƒ</button>
                        </div>
                    </div>
                    <div id="ui-box-attend" class="min-h-[40px] bg-gray-50 rounded-lg p-2 border border-gray-200 cursor-pointer" onclick="openSelector('attend', 'ì˜¤ëŠ˜ ì°¸ì„ì ì„ íƒ', false)"><span class="name-chip-empty">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì°¸ì„ìë¥¼ ì„ íƒí•˜ì„¸ìš”.</span></div>
                    
                    <div class="flex justify-between items-center mt-4 mb-2 border-b pb-2">
                        <label class="block text-sm font-extrabold text-red-600">ğŸš¨ ë¶ˆì„±ì‹¤ì (ì„±ì‹¤ì ìˆ˜ ì œì™¸)</label>
                        <button onclick="openSelector('lazy', 'ë¶ˆì„±ì‹¤ì ì„ íƒ', true)" class="text-[10px] bg-red-50 text-red-600 border border-red-200 px-2 py-1 rounded font-bold btn-press">ì„ íƒ</button>
                    </div>
                    <div id="ui-box-lazy" class="min-h-[30px] bg-red-50/50 rounded-lg p-2 border border-red-100 cursor-pointer" onclick="openSelector('lazy', 'ë¶ˆì„±ì‹¤ì ì„ íƒ', true)"><span class="name-chip-empty text-red-300">í•´ë‹¹ì ì—†ìŒ</span></div>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">ğŸ…</span> ê°œì¸ ë¦¬ê·¸ì „</h3><div class="space-y-2.5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-lg1" onclick="openSelector('lg1', 'ë¦¬ê·¸ì „ 1ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-lg2" onclick="openSelector('lg2', 'ë¦¬ê·¸ì „ 2ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-lg3" onclick="openSelector('lg3', 'ë¦¬ê·¸ì „ 3ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div></div></div>
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">ğŸ¤</span> ë‹¨ì²´ì „</h3><div class="space-y-2.5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-tm1" onclick="openSelector('tm1', 'ë‹¨ì²´ì „ 1ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-tm2" onclick="openSelector('tm2', 'ë‹¨ì²´ì „ 2ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-tm3" onclick="openSelector('tm3', 'ë‹¨ì²´ì „ 3ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div></div></div>
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">âš”ï¸</span> í† ë„ˆë¨¼íŠ¸</h3><div class="space-y-2.5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-tn1" onclick="openSelector('tn1', 'í† ë„ˆë¨¼íŠ¸ 1ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-tn2" onclick="openSelector('tn2', 'í† ë„ˆë¨¼íŠ¸ 2ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-orange-100 flex justify-center items-center font-black text-orange-600 border border-orange-200">3</div><div id="ui-box-tn3" onclick="openSelector('tn3', 'í† ë„ˆë¨¼íŠ¸ 3ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div></div></div>
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><h3 class="font-extrabold text-sm text-indigo-700 mb-3 flex items-center gap-2"><span class="text-lg">ğŸ‘¥</span> ë³µì‹ì „</h3><div class="space-y-2.5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-yellow-100 flex justify-center items-center font-black text-yellow-600 border border-yellow-200">1</div><div id="ui-box-db1" onclick="openSelector('db1', 'ë³µì‹ 1ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-slate-100 flex justify-center items-center font-black text-slate-500 border border-slate-200">2</div><div id="ui-box-db2" onclick="openSelector('db2', 'ë³µì‹ 2ë“± ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-slate-200 rounded-xl bg-slate-50 p-2 cursor-pointer flex items-center flex-wrap gap-1 hover:bg-slate-100"></div></div></div></div>
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-4 border rounded-2xl border-yellow-200/60 shadow-[0_4px_20px_rgba(250,204,21,0.15)]"><h3 class="font-extrabold text-sm text-yellow-800 mb-3 flex items-center gap-2"><span class="text-lg">ğŸ‰</span> ì´ë²¤íŠ¸ì „</h3><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-white flex justify-center items-center font-black text-yellow-600 shadow-sm">ğŸ‘‘</div><div id="ui-box-ev1" onclick="openSelector('ev1', 'ì´ë²¤íŠ¸ ìš°ìŠ¹ì ì„ íƒ', true)" class="flex-1 min-h-[44px] border border-white rounded-xl bg-white/60 backdrop-blur-sm p-2 cursor-pointer flex items-center flex-wrap gap-1 shadow-sm hover:bg-white transition"></div></div></div>
                </div>
                
                <div class="flex gap-3 mt-8 sticky bottom-16 z-20 pb-2">
                    <button onclick="cancelInputStep2()" class="flex-1 bg-white text-slate-700 py-4 rounded-2xl font-extrabold shadow-sm border border-slate-200 hover:bg-slate-50 btn-press">ì‘ì„± ì·¨ì†Œ</button>
                    <button onclick="saveMatch()" class="flex-[2] bg-gradient-to-r from-indigo-500 to-violet-500 text-white py-4 rounded-2xl font-extrabold shadow-lg shadow-indigo-200 btn-press text-lg border border-indigo-700">ìµœì¢… ì ìˆ˜ ì €ì¥</button>
                </div>
            </div>
        </div>

        <div id="view-member" class="hidden p-4 admin-only-block animate-fade-in">
            <div class="bg-white border border-indigo-100 p-5 rounded-2xl mb-6 shadow-sm">
                <h3 class="font-extrabold text-indigo-800 mb-3 text-sm flex items-center gap-1.5"><span class="text-lg">ğŸ“Š</span> ì—‘ì…€ë¡œ ì¼ê´„ ë“±ë¡</h3>
                <input type="file" id="excel-upload" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-5 file:rounded-xl file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition cursor-pointer mb-3" onchange="handleExcelUpload(event)">
                <button onclick="downloadExcelTemplate()" class="w-full bg-white border border-indigo-200 text-indigo-600 py-2.5 rounded-xl text-xs font-bold btn-press shadow-sm">ë“±ë¡ìš© ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            
            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6" id="member-form-container">
                <h2 id="form-title" class="font-extrabold text-xl mb-5 text-slate-800">ìƒˆ íšŒì› ê°œë³„ ë“±ë¡</h2>
                <div class="mb-5 flex items-center gap-5 bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <div class="w-20 h-20 rounded-full overflow-hidden border-4 border-white shadow-md flex-shrink-0 bg-slate-200 relative">
                        <img id="photo-preview" src="" class="w-full h-full object-cover hidden">
                        <div id="photo-placeholder" class="w-full h-full flex flex-col items-center justify-center text-slate-400 text-xs font-bold"><span>ğŸ“·</span><span>ì‚¬ì§„</span></div>
                    </div>
                    <div class="flex-1">
                        <input type="file" id="mem-photo" accept="image/*" class="w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition cursor-pointer" onchange="handlePhotoUpload(event)">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                    <div><label class="block font-bold text-slate-600 mb-1.5 text-xs">êµ¬ë¶„</label><select id="mem-affiliation" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition"><option value="ì‹œ">ì‹œ</option><option value="êµ¬">êµ¬</option><option value="ë ˆì „ë“œ">ë ˆì „ë“œ</option></select></div>
                    <div><label class="block font-bold text-slate-600 mb-1.5 text-xs">ë¶€ì„œ</label><input type="text" id="mem-dept" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="ì˜ˆ: ì²´ìœ¡ì§„í¥ê³¼"></div>
                    <div><label class="block font-bold text-slate-600 mb-1.5 text-xs">ë“±ê¸‰</label><select id="mem-type" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition"><option value="ì—°íšŒì›">ì—°íšŒì›</option><option value="ì¤€íšŒì›">ì¤€íšŒì›</option><option value="ë¹„íšŒì›">ë¹„íšŒì›</option></select></div>
                    <div><label class="block font-bold text-slate-600 mb-1.5 text-xs">ì§ì±…</label><input type="text" id="mem-duty" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="ì˜ˆ: ì´ë¬´"></div>
                    <div><label class="block font-bold text-slate-600 mb-1.5 text-xs">ì§ê¸‰</label><input type="text" id="mem-rank" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="ì˜ˆ: ì£¼ë¬´ê´€"></div>
                    <div><label class="block font-bold text-indigo-600 mb-1.5 text-xs">* ì´ë¦„ (í•„ìˆ˜)</label><input type="text" id="mem-name" class="w-full border border-indigo-200 bg-indigo-50/50 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition font-bold" placeholder="í™ê¸¸ë™"></div>
                    <div>
                        <label class="block font-bold text-slate-600 mb-1.5 text-xs">* ë¶€ìˆ˜ (í•„ìˆ˜)</label>
                        <select id="mem-handicap" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition font-bold text-indigo-700">
                            <option value="1">1ë¶€</option><option value="2">2ë¶€</option><option value="3">3ë¶€</option><option value="4">4ë¶€</option>
                            <option value="5" selected>5ë¶€</option><option value="6">6ë¶€</option><option value="7">7ë¶€</option><option value="8">8ë¶€</option>
                            <option value="9">9ë¶€</option><option value="10">10ë¶€</option>
                        </select>
                    </div>
                    <div><label class="block font-bold text-slate-600 mb-1.5 text-xs">ì„±ë³„</label><select id="mem-gender" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition"><option value="ë‚¨">ë‚¨</option><option value="ì—¬">ì—¬</option></select></div>
                    <div class="col-span-2"><label class="block font-bold text-slate-600 mb-1.5 text-xs">ìƒíƒœ</label>
                        <select id="mem-status" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition font-bold">
                            <option value="active" selected>ğŸŸ¢ ì •ìƒ í™œë™</option><option value="inactive">ğŸ”´ íœ´ë©´ (ìˆœìœ„/ëª…ë‹¨ì—ì„œ ìˆ¨ê¹€)</option>
                        </select>
                    </div>
                    <div class="col-span-2"><label class="block font-bold text-slate-800 mb-1"><span class="bg-yellow-100 px-1.5 rounded">ğŸ“ ì—°ë½ì²˜</span></label><input type="tel" id="mem-phone" class="w-full border-0 bg-slate-100 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 transition" placeholder="010-0000-0000"></div>
                </div>
                <div class="flex gap-3"><button onclick="saveMember()" id="btn-save-member" class="flex-1 bg-slate-800 text-white py-4 rounded-xl font-extrabold shadow-md btn-press">íšŒì› ì €ì¥í•˜ê¸°</button><button onclick="cancelEdit()" id="btn-cancel-edit" class="hidden flex-1 bg-slate-200 text-slate-700 py-4 rounded-xl font-extrabold btn-press">ì·¨ì†Œ</button></div>
            </div>
            
            <div class="flex justify-between items-end mb-3 px-1"><h3 class="font-extrabold text-lg text-slate-800">ì „ì²´ íšŒì› ëª©ë¡</h3><span class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2.5 py-1 rounded-full border border-indigo-100" id="total-members-count">ì´ 0ëª…</span></div>
            <ul id="member-list-display" class="text-sm divide-y divide-slate-100 bg-white border border-slate-100 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6 overflow-hidden"></ul>
        </div>

        <div id="view-setting" class="hidden p-4 pb-20 admin-only-block animate-fade-in">
            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-2xl shadow-lg mb-6 text-white relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-8xl opacity-10">ğŸŒ±</div>
                <h2 class="font-extrabold text-xl mb-2 relative z-10">ìƒˆë¡œìš´ ì‹œì¦Œ ì‹œì‘</h2>
                <p class="text-[11px] text-emerald-50 mb-5 leading-relaxed relative z-10 font-medium">í˜„ì¬ ë“±ë¡ëœ <b>íšŒì› ëª…ë‹¨ì€ ìœ ì§€</b>í•œ ì±„, ê¸°ì¡´ì˜ ê²½ê¸° ê¸°ë¡ê³¼ ì ìˆ˜ë¥¼ 0ì ìœ¼ë¡œ ë¦¬ì…‹í•˜ì—¬ ìƒˆë¡œìš´ ê¸°ìˆ˜ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</p>
                <button onclick="startNewSeason()" class="w-full bg-white text-emerald-700 py-3.5 rounded-xl font-extrabold shadow-md btn-press relative z-10">ìƒˆ ì‹œì¦Œ ì‹œì‘í•˜ê¸°</button>
            </div>

            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6">
                <h2 class="font-extrabold text-lg text-slate-800 mb-5 flex items-center gap-2"><span>ğŸ”¢</span> íšë“ ì ìˆ˜ ë£° ì„¤ì •</h2>
                <div class="space-y-5 text-sm">
                    <div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-xl">
                        <div><label class="block font-bold text-slate-500 mb-1.5 text-xs text-center">ê¸°ë³¸ ì°¸ì„</label><input type="number" id="cfg-score-attend" step="0.5" class="w-full border-0 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 text-center font-extrabold text-slate-700 shadow-sm"></div>
                        <div><label class="block font-bold text-slate-500 mb-1.5 text-xs text-center">ì„±ì‹¤ ì ìˆ˜</label><input type="number" id="cfg-score-sincerity" step="0.5" class="w-full border-0 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 text-center font-extrabold text-slate-700 shadow-sm"></div>
                    </div>
                    <div><div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">ğŸ… ê°œì¸ ë¦¬ê·¸ì „ ì…ìƒ</div><div class="grid grid-cols-3 gap-3"><div><input type="number" id="cfg-score-lg1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">1ë“±</div></div><div><input type="number" id="cfg-score-lg2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">2ë“±</div></div><div><input type="number" id="cfg-score-lg3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"><div class="text-[10px] text-center mt-1 text-slate-400 font-bold">3ë“±</div></div></div></div>
                    <div><div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">ğŸ¤ ë‹¨ì²´ì „ ì…ìƒ</div><div class="grid grid-cols-3 gap-3"><div><input type="number" id="cfg-score-tm1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><input type="number" id="cfg-score-tm2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><input type="number" id="cfg-score-tm3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div></div></div>
                    <div><div class="font-extrabold text-slate-700 mb-2.5 text-xs border-b pb-1">âš”ï¸ í† ë„ˆë¨¼íŠ¸ ì…ìƒ</div><div class="grid grid-cols-3 gap-3"><div><input type="number" id="cfg-score-tn1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><input type="number" id="cfg-score-tn2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><input type="number" id="cfg-score-tn3" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div></div></div>
                    <div class="grid grid-cols-3 gap-4 border-t pt-4"><div><div class="font-extrabold text-slate-700 mb-2 text-[10px]">ğŸ‘¥ ë³µì‹ 1ë“±</div><input type="number" id="cfg-score-db1" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><div class="font-extrabold text-slate-700 mb-2 text-[10px]">ğŸ‘¥ ë³µì‹ 2ë“±</div><input type="number" id="cfg-score-db2" step="0.5" class="w-full border border-slate-200 p-2 rounded-lg text-center font-bold text-indigo-600 bg-slate-50"></div><div><div class="font-extrabold text-yellow-600 mb-2 text-[10px]">ğŸ‰ ì´ë²¤íŠ¸ ìš°ìŠ¹</div><input type="number" id="cfg-score-ev1" step="0.5" class="w-full border border-yellow-200 p-2 rounded-lg text-center font-bold text-yellow-600 bg-yellow-50"></div></div>
                    <button onclick="saveScoreRules()" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold shadow-md mt-4 btn-press">ë£° ì €ì¥ ë° ì¦‰ì‹œ ì¬ê³„ì‚°</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-6">
                <h2 class="font-extrabold text-lg text-slate-800 mb-4 flex items-center gap-2"><span>ğŸ’¬</span> ì¹´í†¡ ê³µì§€ í…œí”Œë¦¿</h2>
                <div class="mb-4"><label class="block text-xs font-bold text-slate-500 mb-1.5">ë¨¸ë¦¿ë§ (ì‹œì‘ ë¬¸êµ¬)</label><textarea id="cfg-announce-prefix" rows="2" class="w-full border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition"></textarea></div>
                <div class="mb-5"><label class="block text-xs font-bold text-slate-500 mb-1.5">ê¼¬ë¦¿ë§ (ì•ˆë‚´/ê³„ì¢Œ ë¬¸êµ¬)</label><textarea id="cfg-announce-suffix" rows="3" class="w-full border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition"></textarea></div>
                <div class="mb-5"><label class="block text-xs font-bold text-slate-500 mb-1.5">ì•± ì ‘ì† ì‹œ ê¸°ë³¸ í™”ë©´</label><select id="cfg-default-tab" class="w-full border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition"><option value="ranking">ğŸ† ì „ì²´ ìˆœìœ„ í™”ë©´</option><option value="history">ğŸ“… ê²½ê¸° ê¸°ë¡ í™”ë©´</option></select></div>
                <button onclick="saveUIConfig()" class="w-full bg-slate-200 text-slate-700 py-3 rounded-xl font-bold btn-press">í™˜ê²½ ì„¤ì • ì €ì¥</button>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)] mb-4">
                <h2 class="font-extrabold text-lg text-slate-800 mb-4 flex items-center gap-2"><span>ğŸ”‘</span> ë³´ì•ˆ ì„¤ì •</h2>
                <label class="block text-xs font-bold text-slate-500 mb-1.5">ìƒˆë¡œìš´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</label>
                <div class="flex gap-2 mb-3">
                    <input type="password" id="cfg-password" class="flex-1 border-0 bg-slate-100 p-3 rounded-xl text-sm focus:ring-2 focus:ring-red-500 transition" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                    <button onclick="changePassword()" class="bg-red-500 text-white px-5 rounded-xl font-bold shadow-md btn-press">ë³€ê²½</button>
                </div>
            </div>
        </div>
    </div>

    <div id="announcement-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex justify-center items-center p-4 animate-fade-in">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="px-5 py-4 flex justify-between items-center border-b border-slate-100 bg-indigo-50">
                <h3 class="font-extrabold text-lg text-indigo-800">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ê³µì§€ ë³µì‚¬</h3>
                <button onclick="closeAnnouncement()" class="text-slate-400 hover:text-slate-600 text-2xl font-bold btn-press">&times;</button>
            </div>
            <div class="p-4 bg-slate-50 flex-1">
                <textarea id="announcement-text" class="w-full h-[40vh] p-3 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 resize-none bg-white font-medium" readonly></textarea>
                <p class="text-[11px] text-slate-500 mt-2 text-center">ë¨¸ë¦¿ë§/ê¼¬ë¦¿ë§ì€ [ì„¤ì •] íƒ­ì—ì„œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="p-4 border-t border-slate-100 bg-white">
                <button onclick="copyAnnouncement()" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-extrabold shadow-lg shadow-indigo-200 hover:bg-indigo-700 btn-press text-lg">ì¹´í†¡ì— ë§ê²Œ ë³µì‚¬í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="team-maker-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex justify-center items-end sm:items-center p-0 sm:p-4 animate-fade-in">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col max-h-[85vh]">
            <div class="sheet-handle sm:hidden"></div>
            <div class="px-5 py-3 flex justify-between items-center shrink-0 border-b border-slate-100">
                <h3 class="font-extrabold text-lg text-slate-800">ğŸ¤– ë°¸ëŸ°ìŠ¤ ì¡° í¸ì„± ê²°ê³¼</h3><button onclick="closeTeamMaker()" class="text-slate-400 hover:text-slate-600 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-5 flex-1 overflow-y-auto bg-slate-50/50">
                <div id="team-result-box" class="space-y-2 text-sm min-h-[150px]"></div>
            </div>
            <div class="p-4 shrink-0 border-t border-slate-100 bg-white flex gap-3 pb-8 sm:pb-4">
                <button onclick="generateTeams()" class="flex-1 bg-slate-100 text-slate-700 py-3.5 rounded-xl font-bold hover:bg-slate-200 btn-press">ë‹¤ì‹œ ì„ê¸°</button>
                <button onclick="copyTeams()" class="flex-[2] bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 btn-press text-lg">ê²°ê³¼ ë³µì‚¬í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="member-selector-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex justify-end flex-col animate-fade-in">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-3xl shadow-2xl flex flex-col max-h-[85vh]">
            <div class="sheet-handle"></div>
            <div class="px-5 pb-3 pt-1 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-extrabold text-xl text-slate-800" id="selector-title">ëª…ë‹¨ ì„ íƒ</h3>
                <span id="selector-count" class="text-xs font-extrabold bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-full shadow-inner">0ëª… ì„ íƒë¨</span>
            </div>
            <div class="p-4 flex-1 overflow-y-auto bg-slate-50/50">
                <p id="selector-empty-msg" class="hidden text-sm text-slate-400 text-center py-10 font-medium">ì„ íƒ ê°€ëŠ¥í•œ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <div id="selector-list" class="grid grid-cols-3 gap-2.5"></div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-white flex gap-3 pb-6">
                <button onclick="closeSelector()" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-xl font-bold btn-press">ì·¨ì†Œ</button>
                <button onclick="confirmSelector()" class="flex-[2] bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 btn-press text-lg">ì„ íƒ ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 max-w-md w-full border-t border-slate-200/50 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.08)] glass-panel z-50 px-3 py-2 pb-5 flex justify-between items-center text-[10px] text-slate-400 font-medium">
        <button onclick="switchTab('ranking')" id="btn-ranking" class="tab-item flex-1 flex flex-col items-center justify-center py-2 relative tab-active btn-press"><span class="tab-icon">ğŸ†</span><span class="mt-1">ìˆœìœ„</span></button>
        <button onclick="switchTab('history')" id="btn-history" class="tab-item flex-1 flex flex-col items-center justify-center py-2 relative btn-press"><span class="tab-icon">ğŸ“…</span><span class="mt-1">ê¸°ë¡</span></button>
        <button onclick="switchTab('operation')" id="btn-operation" class="tab-item flex-1 flex flex-col items-center justify-center py-2 relative btn-press"><span class="tab-icon">ğŸ®</span><span class="mt-1">ìš´ì˜</span></button>
        <button onclick="switchTab('input')" id="btn-input" class="tab-item flex-1 flex-col items-center justify-center py-2 relative admin-only btn-press"><span class="tab-icon">ğŸ“</span><span class="mt-1">ì…ë ¥</span></button>
        <button onclick="switchTab('member')" id="btn-member" class="tab-item flex-1 flex-col items-center justify-center py-2 relative admin-only btn-press"><span class="tab-icon">ğŸ‘¥</span><span class="mt-1">íšŒì›</span></button>
        <button onclick="switchTab('setting')" id="btn-setting" class="tab-item flex-1 flex-col items-center justify-center py-2 relative admin-only btn-press"><span class="tab-icon">âš™ï¸</span><span class="mt-1">ì„¤ì •</span></button>
    </div>

    <script>
        // -------------------------------------------------------------
        // ğŸ”´ [í•„ìˆ˜ ì„¤ì •] Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ë³¸ì¸ì˜ ì„¤ì •ê°’ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš” ğŸ”´
        // -------------------------------------------------------------
   const firebaseConfig = {
  apiKey: "AIzaSyC1t-mJJXV6GBZ7-kWcvpRd35vpPZU0wmA",
  authDomain: "table-tennis-6334b.firebaseapp.com",
  projectId: "table-tennis-6334b",
  storageBucket: "table-tennis-6334b.firebasestorage.app",
  messagingSenderId: "967760713131",
  appId: "1:967760713131:web:17288e738222768aa1aeee",
  measurementId: "G-V3FBQ4FZB7"
};
        
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // -------------------------------------------------------------

        let isAdmin = false; 
        let editingMatchId = null;
        let editingMemberId = null;
        let currentPhotoBase64 = "";

        let defaultAppConfig = { password: "1234", defaultTab: "ranking", announcePrefix: "ğŸ“ [ {date} {type} ê²°ê³¼ ]\n\n", announceSuffix: "\nëª¨ë‘ ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ë‹¤ìŒ ëª¨ì„ì—ì„œ ëµ™ê² ìŠµë‹ˆë‹¤. ğŸ‘" };
        let defaultScoreRules = { attend: 3.0, sincerity: 0.5, lg1: 2.5, lg2: 2.0, lg3: 1.5, tm1: 2.5, tm2: 2.0, tm3: 1.5, tn1: 2.5, tn2: 2.0, tn3: 1.5, db1: 2.0, db2: 1.5, ev1: 2.0 };
        
        let appConfig = {...defaultAppConfig};
        let scoreRules = {...defaultScoreRules};
        let members = [];
        let matchHistory = [];
        let nextMemberId = 1; let nextMatchId = 1; 

        let formState = { attend: [], lazy: [], lg1: [], lg2: [], lg3: [], tm1: [], tm2: [], tm3: [], tn1: [], tn2: [], tn3: [], db1: [], db2: [], ev1: [] };
        let currentSelectorTarget = ''; 
        let tempSelectorList = []; 

        // ğŸŒŸ í˜ì´ì§€ ë¡œë“œ ì‹œ ê´€ë¦¬ì ìƒíƒœ ë³µêµ¬
        function restoreAdminState() {
            if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                isAdmin = true;
                document.getElementById('app-body').classList.add('admin-mode-active');
                document.getElementById('btn-admin-lock').innerText = "ğŸ”“";
            }
        }
        restoreAdminState();

        // Firebaseì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadDataFromStorage() {
            db.collection("tableTennis").doc("leagueData").get().then((doc) => {
                if (doc.exists) {
                    const parsed = doc.data();
                    members = parsed.members || []; 
                    matchHistory = (parsed.matchHistory || []).map(m => ({
                        ...m, 
                        attend: m.attend || [], lazy: m.lazy || [], 
                        lg1: m.lg1 || [], lg2: m.lg2 || [], lg3: m.lg3 || [],
                        tm1: m.tm1 || [], tm2: m.tm2 || [], tm3: m.tm3 || [],
                        tn1: m.tn1 || [], tn2: m.tn2 || [], tn3: m.tn3 || [],
                        db1: m.db1 || [], db2: m.db2 || [], ev1: m.ev1 || []
                    }));
                    appConfig = parsed.appConfig || {...defaultAppConfig}; 
                    scoreRules = parsed.scoreRules || {...defaultScoreRules};
                    nextMemberId = parsed.nextMemberId || 1; 
                    nextMatchId = parsed.nextMatchId || 1;
                    
                    renderAll(); 
                    switchTab(appConfig.defaultTab);
                    if (isAdmin) loadSettingsUI();
                } else {
                    injectSampleData();
                }
            }).catch((error) => {
                console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
                renderAll();
            });
        }
        
        // Firebaseì— ë°ì´í„° ì €ì¥í•˜ê¸°
        function saveDataToStorage() { 
            db.collection("tableTennis").doc("leagueData").set({
                members: members,
                matchHistory: matchHistory,
                appConfig: appConfig,
                scoreRules: scoreRules,
                nextMemberId: nextMemberId,
                nextMatchId: nextMatchId
            }).catch((error) => {
                console.error("ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:", error);
                alert("ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ë°ì´í„°ê°€ ì €ì¥ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            });
        }

        function injectSampleData() {
            members = [
                { id: 1, name: "ë°•ì„ í–‰", handicap: 5, score: 0, prevRank: 1, status: "active", type: "ì—°íšŒì›", affiliation: "ì‹œ", dept: "í˜ì‹ ì„±ì¥ë„ì‹œê³¼", rank: "ì£¼ë¬´ê´€", phone: "" },
                { id: 2, name: "ë¯¼ë™ì¸", handicap: 4, score: 0, prevRank: 2, status: "active", type: "ì—°íšŒì›", affiliation: "ì‹œ", dept: "êµí†µì •ì±…ê³¼", rank: "ì£¼ë¬´ê´€", phone: "" },
                { id: 3, name: "ë¯¼ì°½ì‹", handicap: 4, score: 0, prevRank: 3, status: "active", type: "ì—°íšŒì›", affiliation: "ì‹œ", dept: "ì´ë¬´ê³¼", rank: "íŒ€ì¥", phone: "" },
                { id: 4, name: "ê¹€íƒêµ¬", handicap: 3, score: 0, prevRank: 4, status: "active", type: "ì¤€íšŒì›", affiliation: "êµ¬", dept: "ì²´ìœ¡ì§„í¥ê³¼", rank: "ì£¼ë¬´ê´€", phone: "" },
                { id: 5, name: "ì •ë“œë¼ì´ë¸Œ", handicap: 2, score: 0, prevRank: 5, status: "active", type: "ì—°íšŒì›", affiliation: "ë ˆì „ë“œ", dept: "ë„ì‹œê³„íšê³¼", rank: "ê³¼ì¥", phone: "" }
            ];
            saveDataToStorage();
            renderAll();
            switchTab(appConfig.defaultTab);
        }

        document.getElementById('match-date').value = new Date().toISOString().substring(0, 10);
        
        function toggleAdmin() {
            if (isAdmin) {
                isAdmin = false; 
                sessionStorage.removeItem('isAdminLoggedIn');
                document.getElementById('app-body').classList.remove('admin-mode-active'); 
                document.getElementById('btn-admin-lock').innerText = "ğŸ”’";
                if(!['ranking', 'history', 'operation'].includes(getCurrentTab())) switchTab('ranking');
            } else {
                const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n(ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸: 1234)");
                if (pw === appConfig.password) { 
                    isAdmin = true; 
                    sessionStorage.setItem('isAdminLoggedIn', 'true');
                    document.getElementById('app-body').classList.add('admin-mode-active'); 
                    document.getElementById('btn-admin-lock').innerText = "ğŸ”“"; 
                    loadSettingsUI(); 
                } else if (pw !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
            renderAll(); 
        }
        function getCurrentTab() { return ['ranking', 'input', 'history', 'member', 'setting', 'operation'].find(t => document.getElementById(`btn-${t}`).classList.contains('tab-active')); }
        
        function switchTab(tabName) {
            ['ranking', 'input', 'history', 'member', 'setting', 'operation'].forEach(name => {
                document.getElementById(`view-${name}`).classList.add('hidden'); document.getElementById(`btn-${name}`).classList.remove('tab-active');
                if(name === tabName) { document.getElementById(`view-${name}`).classList.remove('hidden'); document.getElementById(`btn-${name}`).classList.add('tab-active'); }
            });
            if(tabName === 'input' && !editingMatchId) cancelInputStep2();
            if(tabName === 'member' && editingMemberId) cancelEdit();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- ğŸ® ê²½ê¸° ìš´ì˜ ê´€ë ¨ í•¨ìˆ˜ (ì‹ ê·œ ì¶”ê°€) ---
        function renderGroupTable() {
            const size = parseInt(document.getElementById('op-group-size').value);
            let html = `
            <div class="border border-slate-200 rounded-lg overflow-hidden bg-white mb-4">
                <div class="bg-slate-100 p-2 border-b border-slate-200 flex justify-between items-center">
                    <span class="font-extrabold text-sm text-slate-700">1ì¡° (ì˜ˆì‹œ)</span>
                    <span class="text-xs bg-white border border-slate-200 px-2 py-0.5 rounded text-slate-500 font-bold">${size}ëª…</span>
                </div>
                <table class="w-full text-center text-xs border-collapse">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200 text-slate-500">
                            <th class="p-2 border-r border-slate-200 w-10">ì¡°</th>
                            <th class="p-2 border-r border-slate-200">ì„ ìˆ˜ëª…</th>
            `;
            // ìƒëŒ€ ì„ ìˆ˜ ë²ˆí˜¸ í—¤ë”
            for(let i=1; i<=size; i++) {
                html += `<th class="p-2 border-r border-slate-200 w-8">${i}</th>`;
            }
            html += `<th class="p-2 border-r border-slate-200 w-10">ìŠ¹/íŒ¨</th><th class="p-2 border-r border-slate-200 w-10">ë“/ì‹¤</th><th class="p-2 w-10 bg-orange-50 text-orange-600">ìˆœìœ„</th></tr></thead><tbody>`;

            // í…Œì´ë¸” í–‰ ìƒì„±
            for(let i=1; i<=size; i++) {
                html += `<tr class="border-b border-slate-100">
                    <td class="p-2 border-r border-slate-100 font-bold text-slate-400">${i}</td>
                    <td class="p-1 border-r border-slate-100"><input type="text" class="w-full text-center font-bold text-slate-700 bg-transparent outline-none" placeholder="ì´ë¦„"></td>`;
                
                // ëŒ€ê°ì„  ì²˜ë¦¬ ë° ì…ë ¥ì¹¸
                for(let j=1; j<=size; j++) {
                    if(i === j) {
                        html += `<td class="border-r border-slate-100 bg-slate-200 diagonal-strike"></td>`;
                    } else {
                        html += `<td class="border-r border-slate-100"><input type="text" class="w-full text-center bg-transparent outline-none text-[10px]" placeholder=""></td>`;
                    }
                }
                
                html += `
                    <td class="border-r border-slate-100"><input type="text" class="w-full text-center text-[10px] outline-none" placeholder="/"></td>
                    <td class="border-r border-slate-100"><input type="text" class="w-full text-center text-[10px] outline-none" placeholder="/"></td>
                    <td class="font-extrabold text-orange-600 bg-orange-50/30"><input type="text" class="w-full text-center bg-transparent outline-none" placeholder="-"></td>
                </tr>`;
            }
            html += `</tbody></table></div>`;
            document.getElementById('op-group-container').innerHTML = html;
        }

        function renderTournament() {
            const size = parseInt(document.getElementById('op-tourn-size').value);
            let html = `<div class="flex justify-between items-stretch gap-1 w-full text-xs font-bold text-white text-center">`;
            
            // 8ê°• ê¸°ì¤€ í…œí”Œë¦¿
            if (size === 8) {
                const block = (bg) => `<div class="flex-1 flex flex-col justify-around gap-1"><div class="${bg} p-2 rounded shadow-sm flex items-center justify-center min-h-[30px] border border-black/10"><input type="text" class="bg-transparent text-center w-full outline-none placeholder-white/50 text-xs" placeholder="ì´ë¦„"></div></div>`;
                
                // 8ê°• ëŒ€ì§„í‘œ êµ¬ì¡° (ì¢Œì¸¡ 4ëª…)
                html += `<div class="flex flex-col justify-between w-[25%] gap-2">`;
                html += `<div class="bg-orange-400 p-1.5 rounded shadow flex items-center justify-center h-8 mb-4 relative"><span class="absolute -right-2 top-1/2 w-2 h-0.5 bg-slate-300"></span><input class="bg-transparent text-center w-full text-white outline-none" placeholder="1-1"></div>`;
                html += `<div class="bg-orange-400 p-1.5 rounded shadow flex items-center justify-center h-8 mt-4 relative"><span class="absolute -right-2 top-1/2 w-2 h-0.5 bg-slate-300"></span><input class="bg-transparent text-center w-full text-white outline-none" placeholder="4-2"></div>`;
                html += `<div class="bg-orange-400 p-1.5 rounded shadow flex items-center justify-center h-8 mb-4 relative mt-8"><span class="absolute -right-2 top-1/2 w-2 h-0.5 bg-slate-300"></span><input class="bg-transparent text-center w-full text-white outline-none" placeholder="3-1"></div>`;
                html += `<div class="bg-orange-400 p-1.5 rounded shadow flex items-center justify-center h-8 mt-4 relative"><span class="absolute -right-2 top-1/2 w-2 h-0.5 bg-slate-300"></span><input class="bg-transparent text-center w-full text-white outline-none" placeholder="2-2"></div>`;
                html += `</div>`;

                // 4ê°• ì—°ê²°ì„  (ì¢Œì¸¡)
                html += `<div class="w-[10%] flex flex-col justify-around py-4">
                    <div class="h-16 border-r-2 border-t-2 border-b-2 border-slate-300 rounded-r-lg mb-8"></div>
                    <div class="h-16 border-r-2 border-t-2 border-b-2 border-slate-300 rounded-r-lg mt-8"></div>
                </div>`;

                // ì¤€ê²°ìŠ¹ (2ëª…) - ê²°ìŠ¹ - ì¤€ê²°ìŠ¹ (2ëª…)
                html += `<div class="w-[30%] flex flex-col justify-center gap-2 items-center relative">
                    <div class="w-full flex justify-between items-center mb-10"><div class="h-0.5 w-4 bg-slate-300"></div><div class="bg-indigo-500 p-2 rounded w-20 text-center z-10 shadow"><input class="bg-transparent text-center w-full text-white outline-none" placeholder="4ê°•"></div><div class="h-0.5 w-4 bg-slate-300"></div></div>
                    
                    <div class="h-20 w-full border-t-2 border-l-2 border-r-2 border-slate-300 rounded-t-xl absolute top-[25%] left-0 right-0 mx-auto" style="width: 80%;"></div>
                    <div class="bg-yellow-500 p-3 rounded-xl w-24 text-center z-20 shadow-lg font-black text-sm border-2 border-white"><input class="bg-transparent text-center w-full text-white outline-none" placeholder="ìš°ìŠ¹"></div>
                    
                    <div class="w-full flex justify-between items-center mt-10"><div class="h-0.5 w-4 bg-slate-300"></div><div class="bg-indigo-500 p-2 rounded w-20 text-center z-10 shadow"><input class="bg-transparent text-center w-full text-white outline-none" placeholder="4ê°•"></div><div class="h-0.5 w-4 bg-slate-300"></div></div>
                </div>`;

                // 4ê°• ì—°ê²°ì„  (ìš°ì¸¡)
                html += `<div class="w-[10%] flex flex-col justify-around py-4">
                    <div class="h-16 border-l-2 border-t-2 border-b-2 border-slate-300 rounded-l-lg mb-8"></div>
                    <div class="h-16 border-l-2 border-t-2 border-b-2 border-slate-300 rounded-l-lg mt-8"></div>
                </div>`;

                // 8ê°• ëŒ€ì§„í‘œ êµ¬ì¡° (ìš°ì¸¡ 4ëª…)
                html += `<div class="flex flex-col justify-between w-[25%] gap-2">`;
                html += `<div class="bg-orange-400 p-1.5 rounded shadow flex items-center justify-center h-8 mb-4 relative"><span class="absolute -left-2 top-1/2 w-2 h-0.5 bg-slate-300"></span><input class="bg-transparent text-center w-full text-white outline-none" placeholder="2-1"></div>`;
                html += `<div class="bg-orange-400 p-1.5 rounded shadow flex items-center justify-center h-8 mt-4 relative"><span class="absolute -left-2 top-1/2 w-2 h-0.5 bg-slate-300"></span><input class="bg-transparent text-center w-full text-white outline-none" placeholder="3-2"></div>`;
                html += `<div class="bg-orange-400 p-1.5 rounded shadow flex items-center justify-center h-8 mb-4 relative mt-8"><span class="absolute -left-2 top-1/2 w-2 h-0.5 bg-slate-300"></span><input class="bg-transparent text-center w-full text-white outline-none" placeholder="4-1"></div>`;
                html += `<div class="bg-orange-400 p-1.5 rounded shadow flex items-center justify-center h-8 mt-4 relative"><span class="absolute -left-2 top-1/2 w-2 h-0.5 bg-slate-300"></span><input class="bg-transparent text-center w-full text-white outline-none" placeholder="1-2"></div>`;
                html += `</div>`;
            } else {
                html += `<div class="w-full text-center text-slate-400 py-10 bg-slate-50 rounded-xl">8ê°• ì™¸ ëŒ€ì§„í‘œëŠ” ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.</div>`;
            }

            html += `</div>`;
            document.getElementById('op-tourn-container').innerHTML = html;
        }

        // ğŸŒŸ ì¸ì‡„ ê¸°ëŠ¥ ì¶”ê°€
        function printBrackets() {
            window.print();
        }

        // --- ê¸°ì¡´ í•¨ìˆ˜ë“¤ ---
        function downloadExcelTemplate() {
            try {
                const ws_data = [
                    ['êµ¬ë¶„', 'ë¶€ì„œ', 'ë“±ê¸‰', 'ì§ì±…', 'ì§ê¸‰', 'ì´ë¦„(*í•„ìˆ˜)', 'ë¶€ìˆ˜(*í•„ìˆ˜,ìˆ«ì)', 'ì„±ë³„', 'ìƒíƒœ(í™œë™/íœ´ë©´)', 'ì—°ë½ì²˜'],
                    ['ì‹œ', 'ì²´ìœ¡ì§„í¥ê³¼', 'ì—°íšŒì›', 'ì´ë¬´', 'ì£¼ë¬´ê´€', 'í™ê¸¸ë™', '5', 'ë‚¨', 'í™œë™', '010-0000-0000']
                ];
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ws_data), "íšŒì›ë“±ë¡ì–‘ì‹"); XLSX.writeFile(wb, "íƒêµ¬ë¦¬ê·¸_íšŒì›ì¼ê´„ë“±ë¡_ì–‘ì‹.xlsx");
            } catch(e) { alert("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ì¹´ì¹´ì˜¤í†¡ ë“± ë¸Œë¼ìš°ì €ì—ì„œëŠ” íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì°¨ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\ní™”ë©´ ìš°ì¸¡ í•˜ë‹¨ì˜ [ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°(Safari/Chrome)]ë¥¼ ì´ìš©í•´ ì£¼ì„¸ìš”."); }
        }

        function handleExcelUpload(event) {
            const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, defval: ""}); 
                    let addedCount = 0;
                    for (let i = 1; i < jsonData.length; i++) { 
                        const row = jsonData[i]; if (!row || row.length === 0) continue;
                        const name = String(row[5] || '').trim(); const handicapStr = String(row[6] || '').trim();
                        if (name !== '' && handicapStr !== '') {
                            let rawStatus = String(row[8] || '').trim(); let statusVal = (rawStatus === 'íœ´ë©´' || rawStatus === 'inactive') ? 'inactive' : 'active';
                            members.push({ id: nextMemberId++, affiliation: String(row[0] || 'ì‹œ').trim(), dept: String(row[1] || '').trim(), type: String(row[2] || 'ì—°íšŒì›').trim(), duty: String(row[3] || '').trim(), rank: String(row[4] || '').trim(), name: name, handicap: parseInt(handicapStr) || 5, gender: String(row[7] || 'ë‚¨').trim(), status: statusVal, phone: String(row[9] || '').trim(), photo: '', score: 0.0, prevRank: members.length + 1 }); 
                            addedCount++;
                        }
                    }
                    if(addedCount > 0) { alert(`${addedCount}ëª…ì˜ íšŒì› ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œ ë˜ì—ˆìŠµë‹ˆë‹¤.`); saveDataToStorage(); renderAll(); } 
                    else { alert("ë“±ë¡í•  ìœ íš¨í•œ íšŒì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¦„ê³¼ ë¶€ìˆ˜ê°€ ì •í™•íˆ ê¸°ì¬ë˜ì—ˆëŠ”ì§€ ì–‘ì‹ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”."); }
                } catch(err) { alert("ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œ ë°›ì€ ì •ì‹ ì–‘ì‹ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”."); }
                document.getElementById('excel-upload').value = ""; 
            }; reader.readAsArrayBuffer(file);
        }

        function toggleMemberInfo(id) {
            const infoRow = document.getElementById(`member-info-${id}`);
            document.querySelectorAll('[id^="member-info-"]').forEach(row => { if (row.id !== `member-info-${id}`) row.classList.add('hidden'); });
            if (infoRow.classList.contains('hidden')) { infoRow.classList.remove('hidden'); } else { infoRow.classList.add('hidden'); }
        }

        function renderMembersList() {
            const list = document.getElementById('member-list-display'); const activeCount = members.filter(m=>m.status !== 'inactive').length;
            document.getElementById('total-members-count').innerText = `ì´ ${members.length}ëª… (í™œë™ ${activeCount}ëª…)`; list.innerHTML = '';
            
            [...members].sort((a, b) => a.name.localeCompare(b.name)).forEach(m => {
                const adminButtons = isAdmin ? `<div class="flex gap-1 shrink-0 mt-2 sm:mt-0"><button onclick="event.stopPropagation(); editMember(${m.id})" class="px-3 py-1.5 bg-slate-100 text-slate-700 text-xs rounded-lg font-bold hover:bg-slate-200 btn-press">ìˆ˜ì •</button><button onclick="event.stopPropagation(); deleteMember(${m.id})" class="px-3 py-1.5 bg-red-50 text-red-600 text-xs rounded-lg font-bold hover:bg-red-100 btn-press">ì‚­ì œ</button></div>` : '';
                const photoHtml = m.photo ? `<img src="${m.photo}" class="w-11 h-11 rounded-full object-cover border border-slate-200 shadow-sm">` : `<div class="w-11 h-11 rounded-full default-avatar border border-slate-200 shadow-inner">ğŸ‘¤</div>`;
                const infoStr = [m.affiliation, m.dept, m.rank].filter(Boolean).join(' ');
                const inactiveClass = m.status === 'inactive' ? 'member-inactive' : '';
                const badge = m.status === 'inactive' ? `<span class="text-[9px] bg-red-50 text-red-500 px-1.5 py-0.5 rounded font-extrabold ml-1 border border-red-100">íœ´ë©´</span>` : '';
                let phoneStr = m.phone ? m.phone : 'ë¯¸ì…ë ¥'; let deptStr = m.dept ? m.dept : '-'; let dutyStr = m.duty ? m.duty : '-'; let rankStr = m.rank ? m.rank : '-'; let typeStr = m.type ? m.type : '-'; let genderStr = m.gender ? m.gender : '-';

                let detailsHtml = `<div id="member-info-${m.id}" class="hidden animate-fade-in mt-3 pt-3 border-t border-slate-100 w-full"><div class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100/50"><div class="grid grid-cols-2 gap-3 text-[11px]"><div><span class="block text-slate-400 font-bold mb-0.5">ğŸ“ ì—°ë½ì²˜</span><span class="font-extrabold text-slate-700">${phoneStr}</span></div><div><span class="block text-slate-400 font-bold mb-0.5">ğŸ¢ êµ¬ë¶„/ë¶€ì„œ</span><span class="font-extrabold text-slate-700">${m.affiliation} ${m.dept ? '> '+m.dept : ''}</span></div><div><span class="block text-slate-400 font-bold mb-0.5">ğŸ’¼ ì§ê¸‰/ì§ì±…</span><span class="font-extrabold text-slate-700">${rankStr}${m.duty ? ' ('+m.duty+')' : ''}</span></div><div><span class="block text-slate-400 font-bold mb-0.5">ğŸ·ï¸ ë“±ê¸‰/ì„±ë³„</span><span class="font-extrabold text-slate-700">${typeStr} / ${genderStr}</span></div></div></div></div>`;

                list.innerHTML += `<li class="flex flex-col p-3.5 ${inactiveClass} hover:bg-slate-50 transition-colors border-b border-slate-50 cursor-pointer" onclick="toggleMemberInfo(${m.id})"><div class="flex justify-between items-center gap-3 flex-wrap sm:flex-nowrap w-full"><div class="flex items-center gap-3 flex-1">${photoHtml}<div><div class="flex items-center gap-1.5"><span class="font-extrabold text-slate-800 text-[13px]">${m.name}</span> <span class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-bold">${m.handicap}ë¶€</span>${badge}</div><div class="text-[11px] text-slate-400 mt-1 font-medium">${infoStr}</div></div></div>${adminButtons}</div>${detailsHtml}</li>`;
            });
        }

        function editMember(id) {
            const member = members.find(m => m.id === id); if(!member) return; editingMemberId = id;
            document.getElementById('form-title').innerText = "âœï¸ íšŒì› ì •ë³´ ìˆ˜ì •"; document.getElementById('btn-save-member').innerText = "ìˆ˜ì • ì™„ë£Œ"; document.getElementById('btn-save-member').classList.replace('bg-slate-800', 'bg-indigo-600'); document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('mem-affiliation').value = member.affiliation || 'ì‹œ'; document.getElementById('mem-dept').value = member.dept || ''; document.getElementById('mem-type').value = member.type || 'ì—°íšŒì›'; document.getElementById('mem-duty').value = member.duty || ''; document.getElementById('mem-rank').value = member.rank || ''; document.getElementById('mem-name').value = member.name || ''; document.getElementById('mem-handicap').value = member.handicap || '5'; document.getElementById('mem-gender').value = member.gender || 'ë‚¨'; document.getElementById('mem-status').value = member.status || 'active'; document.getElementById('mem-phone').value = member.phone || '';
            currentPhotoBase64 = member.photo || ''; if (currentPhotoBase64) { document.getElementById('photo-preview').src = currentPhotoBase64; document.getElementById('photo-preview').classList.remove('hidden'); document.getElementById('photo-placeholder').classList.add('hidden'); } else { document.getElementById('photo-preview').classList.add('hidden'); document.getElementById('photo-placeholder').classList.remove('hidden'); }
            document.getElementById('member-form-container').scrollIntoView({ behavior: 'smooth' });
        }

        function saveMember() {
            const name = document.getElementById('mem-name').value; if(!name) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            const handicapVal = document.getElementById('mem-handicap').value;
            const memberData = { name: name, affiliation: document.getElementById('mem-affiliation').value, dept: document.getElementById('mem-dept').value, type: document.getElementById('mem-type').value, duty: document.getElementById('mem-duty').value, rank: document.getElementById('mem-rank').value, handicap: parseInt(handicapVal) || 5, gender: document.getElementById('mem-gender').value, phone: document.getElementById('mem-phone').value, photo: currentPhotoBase64, status: document.getElementById('mem-status').value };
            if (editingMemberId !== null) { const index = members.findIndex(m => m.id === editingMemberId); if(index !== -1) members[index] = { ...members[index], ...memberData }; alert('íšŒì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'); } else { memberData.id = nextMemberId++; memberData.score = 0.0; memberData.prevRank = members.length + 1; members.push(memberData); alert('ì‹ ê·œ íšŒì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
            cancelEdit(); renderAll(); saveDataToStorage();
        }

        function cancelEdit() {
            editingMemberId = null; document.getElementById('form-title').innerText = "íšŒì› ê°œë³„ ë“±ë¡"; document.getElementById('btn-save-member').innerText = "íšŒì› ì €ì¥í•˜ê¸°"; document.getElementById('btn-save-member').classList.replace('bg-indigo-600', 'bg-slate-800'); document.getElementById('btn-cancel-edit').classList.add('hidden');
            ['mem-name','mem-dept','mem-duty','mem-rank','mem-phone'].forEach(id => document.getElementById(id).value = ''); document.getElementById('mem-affiliation').value = 'ì‹œ'; document.getElementById('mem-type').value = 'ì—°íšŒì›'; document.getElementById('mem-handicap').value = '5'; document.getElementById('mem-gender').value = 'ë‚¨'; document.getElementById('mem-status').value = 'active'; currentPhotoBase64 = ''; document.getElementById('photo-preview').classList.add('hidden'); document.getElementById('photo-placeholder').classList.remove('hidden'); document.getElementById('mem-photo').value = '';
        }
        
        function handlePhotoUpload(event) { 
            const file = event.target.files[0];
            if (!file) return; 

            const reader = new FileReader(); 
            reader.onload = function(e) { 
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 200; 
                    const MAX_HEIGHT = 200; 
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6); 
                    
                    document.getElementById('photo-preview').src = currentPhotoBase64; 
                    document.getElementById('photo-preview').classList.remove('hidden'); 
                    document.getElementById('photo-placeholder').classList.add('hidden'); 
                };
                img.src = e.target.result;
            }; 
            reader.readAsDataURL(file); 
        }

        function deleteMember(id) { const mem = members.find(m=>m.id===id); if(confirm(`âš ï¸ [${mem.name}] íšŒì›ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì•ˆì „ì„ ìœ„í•´ 'ìˆ˜ì •'ì—ì„œ ìƒíƒœë¥¼ 'íœ´ë©´'ìœ¼ë¡œ ë°”ê¾¸ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.)`)) { members = members.filter(m => m.id !== id); renderAll(); saveDataToStorage(); } }

        function downloadRankingExcel() { 
            try {
                const activeMembers = members.filter(m => m.status !== 'inactive'); if(activeMembers.length === 0) return;
                const data = activeMembers.map(m => ({"ìˆœìœ„": m.currentRank, "ì´ë¦„": m.name, "ë¶€ìˆ˜": m.handicap + "ë¶€", "ì†Œì†": m.affiliation, "ì´ì ": m.score.toFixed(1), "ì—°ë½ì²˜": m.phone || "-"}));
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "í˜„ì¬ ë­í‚¹"); XLSX.writeFile(wb, `íƒêµ¬ë¦¬ê·¸_ì „ì²´ìˆœìœ„_${new Date().toISOString().substring(0,10)}.xlsx`);
            } catch(e) { alert("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"); }
        }

        function exportData() { try { const dataStr = JSON.stringify({ members, matchHistory, appConfig, scoreRules, nextMemberId, nextMatchId }, null, 2); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([dataStr], {type: "application/json"})); a.download = `íƒêµ¬ë¦¬ê·¸_ë°±ì—…_${new Date().toISOString().substring(0,10)}.json`; a.click(); } catch(e) { alert("ë°±ì—… ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"); } }

        function importData(event) {
            const file = event.target.files[0]; if(!file) return; const reader = new FileReader();
            reader.onload = function(e) {
                try { const data = JSON.parse(e.target.result); if(data.members) members = data.members; if(data.matchHistory) matchHistory = data.matchHistory; if(data.appConfig) Object.assign(appConfig, data.appConfig); if(data.scoreRules) Object.assign(scoreRules, data.scoreRules); if(data.nextMemberId) nextMemberId = data.nextMemberId; if(data.nextMatchId) nextMatchId = data.nextMatchId; recalculateAllScores(); renderAll(); loadSettingsUI(); saveDataToStorage(); alert("ë³µì› ì™„ë£Œ"); } catch(err) { alert("ì˜ëª»ëœ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤."); } event.target.value = ""; 
            }; reader.readAsText(file);
        }

        // ğŸŒŸ ìˆ˜ì •ë¨: 'ì—°íšŒì›'ë§Œ ì ìˆ˜ ê³„ì‚° ë¡œì§
        function recalculateAllScores() {
            members.forEach(m => m.score = 0);
            
            const sortedMatches = [...matchHistory].sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0));
            
            if (sortedMatches.length === 0) { 
                members.forEach(m => { m.prevRank = 1; m.currentRank = 1; }); 
                return; 
            }

            sortedMatches.forEach((match, index) => {
                const addScore = (nameArr, points) => { 
                    (nameArr || []).forEach(name => { 
                        const m = members.find(x => x.name === name); 
                        // ğŸŒŸ ì—¬ê¸°ì„œ 'ì—°íšŒì›'ì¸ì§€ í™•ì¸
                        if(m && m.type === 'ì—°íšŒì›') m.score += points; 
                    }); 
                };
                
                (match.attend || []).forEach(name => { 
                    const m = members.find(x => x.name === name); 
                    // ğŸŒŸ ì°¸ì„ ì ìˆ˜ë„ 'ì—°íšŒì›'ë§Œ
                    if(m && m.type === 'ì—°íšŒì›') { 
                        m.score += scoreRules.attend; 
                        if(!(match.lazy || []).includes(name)) m.score += scoreRules.sincerity; 
                    } 
                });
                
                addScore(match.lg1, scoreRules.lg1); addScore(match.lg2, scoreRules.lg2); addScore(match.lg3, scoreRules.lg3);
                addScore(match.tm1, scoreRules.tm1); addScore(match.tm2, scoreRules.tm2); addScore(match.tm3, scoreRules.tm3);
                addScore(match.tn1, scoreRules.tn1); addScore(match.tn2, scoreRules.tn2); addScore(match.tn3, scoreRules.tn3);
                addScore(match.db1, scoreRules.db1); addScore(match.db2, scoreRules.db2); addScore(match.ev1, scoreRules.ev1);

                if (index === sortedMatches.length - 2) {
                    const tempSort = [...members].filter(m => m.type === 'ì—°íšŒì›').sort((a, b) => b.score - a.score);
                    for (let i = 0; i < tempSort.length; i++) { if (i > 0 && tempSort[i].score === tempSort[i-1].score) tempSort[i].prevRank = tempSort[i-1].prevRank; else tempSort[i].prevRank = i + 1; }
                }
            });

            // ë­í‚¹ì€ ì „ì²´ ì •ë ¬í•˜ë˜ ì—°íšŒì› ìœ„ì£¼ë¡œ ë³´ì—¬ì¤Œ (ì‹¤ì œ í•„í„°ëŠ” renderRankingì—ì„œ)
            members.sort((a, b) => b.score - a.score);
            
            // ì—°íšŒì›ë¼ë¦¬ë§Œ ë­í‚¹ ì¬ì‚°ì •
            let annualMembers = members.filter(m => m.type === 'ì—°íšŒì›');
            annualMembers.sort((a, b) => b.score - a.score);
            for(let i=0; i<annualMembers.length; i++) {
                if (i > 0 && annualMembers[i].score === annualMembers[i-1].score) annualMembers[i].currentRank = annualMembers[i-1].currentRank; 
                else annualMembers[i].currentRank = i + 1;
            }
            // ë¹„íšŒì›/ì¤€íšŒì›ì€ ë­í‚¹ 0 ì²˜ë¦¬
            members.forEach(m => { if(m.type !== 'ì—°íšŒì›') m.currentRank = '-'; });

            if (sortedMatches.length === 1) { members.forEach(m => m.prevRank = m.currentRank); }
        }

        function renderRanking() {
            const tbody = document.getElementById('ranking-table-body'); tbody.innerHTML = '';
            // ğŸŒŸ í™”ë©´ì—ëŠ” 'ì—°íšŒì›'ë§Œ í‘œì‹œ
            const activeMembers = members.filter(m => m.status !== 'inactive' && m.type === 'ì—°íšŒì›');
            
            if(activeMembers.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="py-16 text-center"><div class="text-5xl mb-4 drop-shadow-sm">ğŸ“­</div><p class="font-extrabold text-slate-700 text-base">ë“±ë¡ëœ ì—°íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</p><p class="text-xs mt-2 text-slate-400">íšŒì› íƒ­ì—ì„œ íšŒì›ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.</p></td></tr>`; return; }
            const topScore = activeMembers.length > 0 ? activeMembers[0].score : 0;
            activeMembers.forEach((m, index) => {
                let rankDisplay = m.currentRank;
                if (m.currentRank === 1) rankDisplay = `<div class="w-7 h-7 mx-auto bg-gradient-to-br from-yellow-300 to-yellow-500 text-white rounded-full flex items-center justify-center font-extrabold shadow-[0_2px_10px_rgba(234,179,8,0.4)]">1</div>`;
                else if (m.currentRank === 2) rankDisplay = `<div class="w-6 h-6 mx-auto bg-gradient-to-br from-slate-300 to-slate-400 text-white rounded-full flex items-center justify-center font-bold shadow-[0_2px_10px_rgba(148,163,184,0.4)]">2</div>`;
                else if (m.currentRank === 3) rankDisplay = `<div class="w-6 h-6 mx-auto bg-gradient-to-br from-orange-400 to-orange-600 text-white rounded-full flex items-center justify-center font-bold shadow-[0_2px_10px_rgba(234,88,12,0.4)]">3</div>`;
                else if(index > 0 && activeMembers[index-1].currentRank === m.currentRank) rankDisplay = `<span class="text-slate-300 font-medium">-</span>`;
                else rankDisplay = `<span class="text-slate-500 font-extrabold">${m.currentRank}</span>`;

                let rankDiff = (m.prevRank === '-' || m.currentRank === '-') ? 0 : m.prevRank - m.currentRank; 
                let rankIcon = rankDiff > 0 ? `<span class="text-red-500">â–² ${rankDiff}</span>` : rankDiff < 0 ? `<span class="text-blue-500">â–¼ ${Math.abs(rankDiff)}</span>` : `<span class="text-slate-300">-</span>`; 
                let scoreDiff = (topScore - m.score).toFixed(1);
                
                tbody.innerHTML += `<tr class="bg-white hover:bg-indigo-50/50 cursor-pointer transition-colors border-b border-slate-50" onclick="toggleMemberDetail(${m.id})"><td class="px-1 py-3.5 text-center align-middle">${rankDisplay}</td><td class="px-2 py-3.5 text-slate-800 font-extrabold text-[13px]">${m.name} <span class="text-[10px] text-slate-400 font-medium ml-0.5 bg-slate-50 px-1 rounded">${m.handicap}ë¶€</span></td><td class="px-2 py-3.5 text-right font-black text-indigo-600 text-base tracking-tight">${m.score.toFixed(1)}</td><td class="px-2 py-3.5 text-right text-red-400 font-bold text-[10px] tracking-tight">${scoreDiff > 0 ? scoreDiff : ''}</td><td class="px-2 py-3.5 text-center text-[10px] font-extrabold">${rankIcon}</td></tr><tr id="detail-row-${m.id}" class="hidden detail-row"><td colspan="5" class="p-0 border-0" id="detail-content-${m.id}"></td></tr>`;
            });
        }

        function renderHistory() {
            const list = document.getElementById('match-history-list'); list.innerHTML = '';
            if(matchHistory.length === 0) { list.innerHTML = `<tr><td colspan="3" class="text-center py-16"><div class="text-5xl mb-4 drop-shadow-sm opacity-80">ğŸ“</div><p class="font-extrabold text-slate-700 text-base">ì•„ì§ ì§„í–‰ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p><p class="text-xs mt-2 text-slate-400">ì…ë ¥ íƒ­ì—ì„œ ì²« ê²½ê¸°ë¥¼ ê¸°ë¡í•´ ë³´ì„¸ìš”!</p></td></tr>`; return; }
            
            [...matchHistory].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0)).forEach(match => {
                let winHtml = '';
                const addBadge = (arr, label, bgClass) => {
                    if(arr && arr.length > 0) {
                        winHtml += `<div class="flex items-start gap-1.5 mb-1.5"><span class="shrink-0 text-[10px] font-extrabold text-white ${bgClass} px-1.5 py-0.5 rounded shadow-sm text-center">${label}</span> <span class="text-slate-700 font-bold text-[12px] break-keep leading-tight pt-0.5">${arr.join(', ')}</span></div>`;
                    }
                };

                addBadge(match.lg1, 'ë¦¬ê·¸1ìœ„', 'bg-indigo-600'); addBadge(match.lg2, 'ë¦¬ê·¸2ìœ„', 'bg-indigo-500'); addBadge(match.lg3, 'ë¦¬ê·¸3ìœ„', 'bg-indigo-400');
                addBadge(match.tm1, 'ë‹¨ì²´1ìœ„', 'bg-teal-600'); addBadge(match.tm2, 'ë‹¨ì²´2ìœ„', 'bg-teal-500'); addBadge(match.tm3, 'ë‹¨ì²´3ìœ„', 'bg-teal-400');
                addBadge(match.tn1, 'í† ë„ˆ1ìœ„', 'bg-violet-600'); addBadge(match.tn2, 'í† ë„ˆ2ìœ„', 'bg-violet-500'); addBadge(match.tn3, 'í† ë„ˆ3ìœ„', 'bg-violet-400');
                addBadge(match.db1, 'ë³µì‹1ìœ„', 'bg-pink-600'); addBadge(match.db2, 'ë³µì‹2ìœ„', 'bg-pink-500');
                addBadge(match.ev1, 'ì´ë²¤íŠ¸', 'bg-amber-500');

                if(!winHtml) winHtml = '<div class="text-[11px] text-slate-400 font-medium py-1">ì…ìƒ ê¸°ë¡ ì—†ìŒ</div>';

                let lazyHtml = '';
                if(match.lazy && match.lazy.length > 0) {
                    lazyHtml = `<div class="mt-2 pt-2 border-t border-slate-200/60 flex items-start gap-1"><span class="shrink-0 text-[10px] font-extrabold text-red-500 mr-0.5 mt-0.5">ğŸš¨ ë¶ˆì„±ì‹¤</span><span class="text-[11px] text-slate-600 font-bold leading-tight pt-0.5">${match.lazy.join(', ')}</span></div>`;
                }

                const adminButtons = `<div class="flex flex-col gap-1.5 items-center"><button onclick="openAnnouncement(${match.id})" class="w-full px-2 py-1.5 bg-indigo-50 text-indigo-700 text-[10px] rounded-lg border border-indigo-100 hover:bg-indigo-100 font-extrabold shadow-sm btn-press">ê³µì§€</button><button onclick="editMatch(${match.id})" class="w-full px-2 py-1.5 bg-white text-slate-600 text-[10px] rounded-lg border border-slate-200 hover:bg-slate-50 font-extrabold shadow-sm btn-press">ìˆ˜ì •</button><button onclick="deleteMatch(${match.id})" class="w-full px-2 py-1.5 bg-red-50 text-red-600 text-[10px] rounded-lg border border-red-100 hover:bg-red-100 font-extrabold shadow-sm btn-press">ì‚­ì œ</button></div>`;
                let displayDate = match.date ? match.date.substring(5) : 'ë¯¸ì •'; 
                
                list.innerHTML += `
                <tr class="bg-white hover:bg-slate-50 border-b border-slate-100 transition-colors">
                    <td class="px-2 py-4 text-center align-top whitespace-nowrap pt-5">
                        <div class="font-extrabold text-slate-800 text-[13px]">${displayDate}</div>
                        <div class="text-[10px] mt-1.5"><span class="bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200 font-bold">${match.type || ''}</span></div>
                    </td>
                    <td class="px-2 py-4 text-left align-top">
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 mb-2 shadow-inner">
                            <div class="flex justify-between items-center mb-1.5">
                                <span class="text-[10px] font-black text-slate-500">âœ… ì°¸ì„ì ëª…ë‹¨</span>
                                <span class="text-[10px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded font-bold">${(match.attend || []).length}ëª…</span>
                            </div>
                            <div class="text-[11px] text-slate-700 font-medium leading-relaxed break-keep">
                                ${(match.attend || []).join(', ')}
                            </div>
                            ${lazyHtml}
                        </div>
                        <div class="bg-indigo-50/40 p-3 rounded-xl border border-indigo-50">
                            <div class="text-[10px] font-black text-indigo-800 mb-2.5">ğŸ† ì…ìƒ ë‚´ì—­</div>
                            <div class="flex flex-col">
                                ${winHtml}
                            </div>
                        </div>
                    </td>
                    <td class="px-2 py-4 admin-only-table-cell align-middle w-14">
                        ${adminButtons}
                    </td>
                </tr>`;
            });
        }

        function initFormState() { for(let key in formState) formState[key] = []; updateFormUI(); }
        function updateFormUI() {
            for(let key in formState) {
                const el = document.getElementById(`ui-box-${key}`); if(!el) continue;
                if(formState[key].length === 0) {
                    let emptyMsg = key === 'attend' ? 'ğŸ‘‡ í„°ì¹˜í•˜ì—¬ ëª…ë‹¨ì„ ì„ íƒí•˜ì„¸ìš”' : (key === 'lazy' ? 'í•´ë‹¹ì ì—†ìŒ' : 'ì„ íƒ');
                    el.innerHTML = `<span class="name-chip-empty ${key === 'lazy' ? 'text-red-300' : ''}">${emptyMsg}</span>`;
                } else el.innerHTML = formState[key].map(name => `<span class="name-chip shadow-sm">${name}</span>`).join('');
            }
        }
        
        // ğŸŒŸ ìˆ˜ì •ë¨: ê²€ìƒ‰ì°½ì´ í¬í•¨ëœ ëª…ë‹¨ ì„ íƒ ëª¨ë‹¬
        function openSelector(target, title, onlyAttendees) {
            currentSelectorTarget = target; document.getElementById('selector-title').innerText = title; tempSelectorList = [...formState[target]]; 
            
            // ê²€ìƒ‰ì°½ ì¶”ê°€ ë¡œì§
            const headerEl = document.getElementById('member-selector-modal').querySelector('.px-5');
            let searchContainer = document.getElementById('selector-search-container');
            if(!searchContainer) {
                searchContainer = document.createElement('div');
                searchContainer.id = 'selector-search-container';
                searchContainer.className = 'px-4 pb-2';
                searchContainer.innerHTML = `<input type="text" id="selector-search-input" placeholder="ğŸ” ì´ë¦„ ì´ˆì„± ê²€ìƒ‰..." class="w-full bg-slate-100 border-0 p-3 rounded-xl text-sm outline-none font-bold text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-indigo-500 transition-all">`;
                headerEl.after(searchContainer);
                
                // ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                document.getElementById('selector-search-input').addEventListener('input', (e) => {
                    const keyword = e.target.value.toLowerCase();
                    const buttons = document.querySelectorAll('#selector-list button');
                    buttons.forEach(btn => {
                        const name = btn.innerText.toLowerCase();
                        if(name.includes(keyword)) btn.classList.remove('hidden');
                        else btn.classList.add('hidden');
                    });
                });
            } else {
                document.getElementById('selector-search-input').value = ''; // ì´ˆê¸°í™”
            }

            renderSelectorList(onlyAttendees, target);
            updateSelectorCount(); document.getElementById('member-selector-modal').classList.remove('hidden');
            // ëª¨ë‹¬ ì—´ë¦´ ë•Œ ê²€ìƒ‰ì°½ì— í¬ì»¤ìŠ¤
            setTimeout(() => document.getElementById('selector-search-input').focus(), 100);
        }

        function renderSelectorList(onlyAttendees, target) {
            let candidates = [];
            if(onlyAttendees) {
                if(formState.attend.length === 0) { alert('ë¨¼ì € [ì˜¤ëŠ˜ ì°¸ì„ì] ëª…ë‹¨ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
                candidates = members.filter(m => formState.attend.includes(m.name));
            } else candidates = members.filter(m => m.status === 'active');

            let excludedNames = [];
            const prefix = target.substring(0, 2);
            if (['lg', 'tm', 'tn'].includes(prefix)) {
                ['1', '2', '3'].forEach(num => { if (prefix + num !== target) excludedNames.push(...formState[prefix + num]); });
            } else if (prefix === 'db') {
                ['1', '2'].forEach(num => { if (prefix + num !== target) excludedNames.push(...formState[prefix + num]); });
            }
            candidates = candidates.filter(m => !excludedNames.includes(m.name));

            const listEl = document.getElementById('selector-list'); const emptyMsg = document.getElementById('selector-empty-msg'); listEl.innerHTML = '';
            if(candidates.length === 0) { listEl.classList.add('hidden'); emptyMsg.classList.remove('hidden'); } 
            else {
                listEl.classList.remove('hidden'); emptyMsg.classList.add('hidden');
                candidates.sort((a,b) => a.name.localeCompare(b.name)).forEach(m => {
                    const isSelected = tempSelectorList.includes(m.name);
                    const bgClass = isSelected ? 'bg-indigo-600 text-white border-indigo-700 shadow-inner' : 'bg-white text-slate-600 border-slate-200 shadow-sm hover:bg-slate-50';
                    listEl.innerHTML += `<button onclick="toggleSelect('${m.name}')" id="sel-btn-${m.name}" class="py-3.5 px-2 border rounded-xl text-[13px] font-extrabold transition-all btn-press ${bgClass}">${m.name}</button>`;
                });
            }
        }

        function toggleSelect(name) {
            const idx = tempSelectorList.indexOf(name); const btn = document.getElementById(`sel-btn-${name}`);
            if(idx > -1) { tempSelectorList.splice(idx, 1); btn.className = "py-3.5 px-2 border rounded-xl text-[13px] font-extrabold transition-all bg-white text-slate-600 border-slate-200 shadow-sm hover:bg-slate-50 btn-press"; } 
            else { tempSelectorList.push(name); btn.className = "py-3.5 px-2 border rounded-xl text-[13px] font-extrabold transition-all bg-indigo-600 text-white border-indigo-700 shadow-inner btn-press"; }
            updateSelectorCount();
        }
        function updateSelectorCount() { document.getElementById('selector-count').innerText = `${tempSelectorList.length}ëª… ì„ íƒë¨`; }
        function closeSelector() { document.getElementById('member-selector-modal').classList.add('hidden'); }
        function confirmSelector() {
            formState[currentSelectorTarget] = [...tempSelectorList];
            if(currentSelectorTarget === 'attend') { for(let key in formState) { if(key !== 'attend') formState[key] = formState[key].filter(name => formState.attend.includes(name)); } }
            updateFormUI(); closeSelector();
        }

        function saveMatch() {
            if(!formState.attend || formState.attend.length === 0) { alert("ìµœì†Œ 1ëª… ì´ìƒì˜ ì°¸ì„ìê°€ ì„ íƒë˜ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }
            
            let clonedState = {};
            for(let k in formState) { clonedState[k] = [...(formState[k] || [])]; }

            const matchData = { 
                id: editingMatchId ? editingMatchId : nextMatchId++, 
                date: document.getElementById('match-date').value || new Date().toISOString().substring(0, 10), 
                type: document.getElementById('match-type').value || 'ì •ê¸°ëª¨ì„', 
                ...clonedState 
            };
            
            if(editingMatchId) { 
                const index = matchHistory.findIndex(m => m.id === editingMatchId); 
                if(index !== -1) matchHistory[index] = matchData; 
                alert('ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!'); 
            } else { 
                matchHistory.push(matchData); 
                alert('ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!'); 
            }
            
            editingMatchId = null; 
            document.getElementById('input-form-title').innerText = "1. ëª¨ì„ ê¸°ë³¸ ì •ë³´ ì…ë ¥";
            document.getElementById('input-step-1').classList.remove('hidden'); 
            document.getElementById('input-step-2').classList.add('hidden'); 
            
            initFormState(); 
            renderAll(); 
            saveDataToStorage(); // Firebase ì €ì¥ ì¶”ê°€
            
            switchTab('history'); 
        }

        function openInputStep2() { const dateStr = document.getElementById('match-date').value; const typeStr = document.getElementById('match-type').value; document.getElementById('display-match-info').innerText = `${dateStr} | ${typeStr}`; document.getElementById('input-step-1').classList.add('hidden'); document.getElementById('input-step-2').classList.remove('hidden'); if(!editingMatchId) initFormState(); }
        function cancelInputStep2() { document.getElementById('input-step-1').classList.remove('hidden'); document.getElementById('input-step-2').classList.add('hidden'); if(editingMatchId) { editingMatchId = null; document.getElementById('input-form-title').innerText = "1. ëª¨ì„ ê¸°ë³¸ ì •ë³´ ì…ë ¥"; initFormState(); switchTab('history'); } }
        function editMatch(id) { const match = matchHistory.find(m => m.id === id); if(!match) return; editingMatchId = id; switchTab('input'); document.getElementById('input-form-title').innerText = "âœï¸ ëª¨ì„ ì •ë³´ ìˆ˜ì •"; document.getElementById('match-date').value = match.date; document.getElementById('match-type').value = match.type; for(let key in formState) { formState[key] = match[key] ? [...match[key]] : []; } updateFormUI(); openInputStep2(); }
        function deleteMatch(id) { if(confirm("ì´ ê²½ê¸° ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ê²½ê¸°ë¡œ ì–»ì€ ì ìˆ˜ë“¤ì´ íšŒì›ë“¤ì˜ ì´ì ì—ì„œ ëª¨ë‘ ì°¨ê°ë©ë‹ˆë‹¤.")) { matchHistory = matchHistory.filter(m => m.id !== id); renderAll(); saveDataToStorage(); alert('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); } }

        function openAnnouncement(id) {
            const match = matchHistory.find(m => m.id === id); if(!match) return;
            
            let text = appConfig.announcePrefix.replace('{date}', match.date).replace('{type}', match.type);
            text += `\n[ ğŸ‘¥ ì°¸ì„ì ëª…ë‹¨ - ì´ ${(match.attend||[]).length}ëª… ]\n`;
            text += `${(match.attend||[]).join(', ')}\n`;
            
            if(match.lazy && match.lazy.length > 0) { text += `\n[ ğŸš¨ ì§€ê°/ë¶ˆì„±ì‹¤ ]\n${(match.lazy||[]).join(', ')}\n`; }
            
            let hasResults = false; let resultText = `\n[ ğŸ† ê²½ê¸° ê²°ê³¼ ]\n`;
            const addResult = (title, arr) => { if(arr && arr.length > 0) { resultText += `â–ªï¸ ${title} : ${arr.join(', ')}\n`; hasResults = true; } };

            addResult("ê°œì¸ì „ 1ìœ„", match.lg1); addResult("ê°œì¸ì „ 2ìœ„", match.lg2); addResult("ê°œì¸ì „ 3ìœ„", match.lg3);
            addResult("ë‹¨ì²´ì „ 1ìœ„", match.tm1); addResult("ë‹¨ì²´ì „ 2ìœ„", match.tm2); addResult("ë‹¨ì²´ì „ 3ìœ„", match.tm3);
            addResult("í† ë„ˆë¨¼íŠ¸ 1ìœ„", match.tn1); addResult("í† ë„ˆë¨¼íŠ¸ 2ìœ„", match.tn2); addResult("í† ë„ˆë¨¼íŠ¸ 3ìœ„", match.tn3);
            addResult("ë³µì‹ 1ìœ„", match.db1); addResult("ë³µì‹ 2ìœ„", match.db2); addResult("ì´ë²¤íŠ¸ ìš°ìŠ¹", match.ev1);

            if(hasResults) { text += resultText; }
            text += '\n' + appConfig.announceSuffix; 
            
            document.getElementById('announcement-text').value = text; 
            document.getElementById('announcement-modal').classList.remove('hidden');
        }
        
        function closeAnnouncement() { document.getElementById('announcement-modal').classList.add('hidden'); }
        
        function copyAnnouncement() { 
            const textToCopy = document.getElementById('announcement-text').value;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => { alert('ì¹´ì¹´ì˜¤í†¡ìš© ê³µì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´í†¡ ëŒ€í™”ì°½ì— ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.'); });
            } else {
                const textArea = document.getElementById('announcement-text'); textArea.select(); document.execCommand('copy'); alert('ì¹´ì¹´ì˜¤í†¡ìš© ê³µì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´í†¡ ëŒ€í™”ì°½ì— ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.');
            }
        }
        
        function generateTeams() {
            if(formState.attend.length < 2) { alert("ì¡°ë¥¼ í¸ì„±í•˜ë ¤ë©´ ë¨¼ì € ì°¸ì„ìë¥¼ ìµœì†Œ 2ëª… ì´ìƒ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
            let players = formState.attend.map(name => { const member = members.find(m => m.name === name); return { name: name, handicap: member ? member.handicap : 5 }; });
            players.sort((a, b) => a.handicap - b.handicap);
            let teams = []; let left = 0; let right = players.length - 1;
            while(left < right) { teams.push([players[left], players[right]]); left++; right--; }
            if (left === right) { teams.push([players[left]]); }

            let resultHtml = `<div class="font-extrabold mb-4 text-indigo-900 border-b border-indigo-200/50 pb-3 text-center bg-white rounded-xl p-3 shadow-sm text-sm">ğŸ”¥ ì´ ${formState.attend.length}ëª… ì°¸ì—¬ / ${teams.length}ê°œ ì¡° í¸ì„± ì™„ë£Œ</div>`;
            teams.forEach((team, idx) => {
                const sumHandicap = team.reduce((sum, p) => sum + p.handicap, 0);
                const namesStr = team.map(p => `<span class="font-bold">${p.name}</span><span class="text-slate-400 font-normal">(${p.handicap})</span>`).join(' <span class="text-slate-300">+</span> ');
                resultHtml += `<div class="mb-2 bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm"><span class="font-black text-white bg-indigo-500 px-2 py-1 rounded-lg text-[11px] mr-2 shadow-sm">${idx+1}ì¡°</span> <span class="flex-1 text-right text-[13px] tracking-tight">${namesStr}</span> <span class="text-[10px] text-indigo-700 font-extrabold ml-3 bg-indigo-50 px-2 py-1 rounded-lg border border-indigo-100 whitespace-nowrap">í•© ${sumHandicap}ë¶€</span></div>`;
            });

            if(teams.length >= 2) {
                resultHtml += `<div class="mt-6 mb-3 font-extrabold text-[11px] text-slate-500 flex items-center gap-2"><span class="h-px bg-slate-200 flex-1"></span>ğŸ’¡ í•¸ë””ìº¡ ê°€ì´ë“œ (ì°¸ê³ ìš©)<span class="h-px bg-slate-200 flex-1"></span></div><div class="space-y-1.5">`;
                for(let i=0; i<teams.length; i+=2) {
                    if(i+1 < teams.length) {
                        let t1Sum = teams[i].reduce((s,p)=>s+p.handicap,0); let t2Sum = teams[i+1].reduce((s,p)=>s+p.handicap,0);
                        let diff = Math.abs(t1Sum - t2Sum); let receiver = t1Sum > t2Sum ? (i+1) : (i+2); 
                        resultHtml += `<div class="text-[11px] flex justify-between items-center bg-white p-2.5 rounded-xl border border-dashed border-slate-300 shadow-sm"><span class="font-extrabold text-slate-700 bg-slate-100 px-2 py-0.5 rounded">${i+1}ì¡° <span class="text-xs">âš”ï¸</span> ${i+2}ì¡°</span>`;
                        if(diff === 0) resultHtml += `<span class="text-emerald-600 font-extrabold bg-emerald-50 px-2.5 py-1 rounded-md">í•¸ë””ìº¡ ì—†ìŒ (ë™ì )</span></div>`;
                        else resultHtml += `<span class="text-rose-600 font-extrabold bg-rose-50 px-2.5 py-1 rounded-md shadow-sm">ğŸ‘‰ ${receiver}ì¡°ê°€ +${diff}ì </span></div>`;
                    }
                }
                resultHtml += `</div>`;
            }
            document.getElementById('team-result-box').innerHTML = resultHtml; document.getElementById('team-maker-modal').classList.remove('hidden');
        }
        function closeTeamMaker() { document.getElementById('team-maker-modal').classList.add('hidden'); }
        function copyTeams() { const tempDiv = document.createElement("div"); tempDiv.innerHTML = document.getElementById('team-result-box').innerHTML.replace(/<\/div>/g, '\n').replace(/<[^>]*>?/gm, ''); const textArea = document.createElement("textarea"); textArea.value = tempDiv.textContent || tempDiv.innerText || ""; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); alert('ì¡° í¸ì„± ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'); }

        function loadSettingsUI() { for (let key in scoreRules) { if(document.getElementById(`cfg-score-${key}`)) { document.getElementById(`cfg-score-${key}`).value = scoreRules[key]; } } document.getElementById('cfg-announce-prefix').value = appConfig.announcePrefix; document.getElementById('cfg-announce-suffix').value = appConfig.announceSuffix; document.getElementById('cfg-default-tab').value = appConfig.defaultTab; }
        function saveScoreRules() { for (let key in scoreRules) { let val = parseFloat(document.getElementById(`cfg-score-${key}`).value); if(!isNaN(val)) scoreRules[key] = val; } recalculateAllScores(); renderAll(); saveDataToStorage(); alert("ì ìˆ˜ ì²´ê³„ê°€ ì €ì¥ë˜ì—ˆìœ¼ë©°, ê³¼ê±° ê¸°ë¡ì´ ìƒˆ ê·œì¹™ì— ë§ê²Œ ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤."); }
        function saveUIConfig() { appConfig.announcePrefix = document.getElementById('cfg-announce-prefix').value; appConfig.announceSuffix = document.getElementById('cfg-announce-suffix').value; appConfig.defaultTab = document.getElementById('cfg-default-tab').value; saveDataToStorage(); alert("í™˜ê²½ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); }
        function changePassword() { const newPw = document.getElementById('cfg-password').value; if(newPw.trim() === '') { alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; } appConfig.password = newPw; document.getElementById('cfg-password').value = ''; saveDataToStorage(); alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); }
        function resetAllData() { if(confirm("âš ï¸ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { members = []; matchHistory = []; recalculateAllScores(); renderAll(); saveDataToStorage(); alert("ì´ˆê¸°í™” ì™„ë£Œ"); } }
        function resetMatchData() { if(confirm("ê²½ê¸° ê¸°ë¡ë§Œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { matchHistory = []; recalculateAllScores(); renderAll(); saveDataToStorage(); alert("ì´ˆê¸°í™” ì™„ë£Œ"); } }
        function startNewSeason() { if(confirm("ìƒˆ ì‹œì¦Œì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì ìˆ˜ê°€ 0ìœ¼ë¡œ ë¦¬ì…‹ë©ë‹ˆë‹¤.")) { matchHistory = []; members.forEach(m => { m.score = 0; m.prevRank = 1; m.currentRank = 1; }); renderAll(); saveDataToStorage(); alert("ìƒˆ ì‹œì¦Œ ì‹œì‘!"); switchTab('ranking'); } }

        function toggleMemberDetail(id) {
            const detailRow = document.getElementById(`detail-row-${id}`); if (!detailRow.classList.contains('hidden')) { detailRow.classList.add('hidden'); return; }
            document.querySelectorAll('.detail-row').forEach(row => row.classList.add('hidden'));

            const member = members.find(m => m.id === id); const memberMatches = matchHistory.filter(match => (match.attend||[]).includes(member.name));
            let attendScore = 0; let sincerityScore = 0; let winScore = 0; let winCount = 0; 

            let historyListHtml = '';
            if (memberMatches.length === 0) { historyListHtml = `<p class="text-xs text-slate-400 py-6 text-center bg-white rounded-xl border border-slate-100">ì°¸ì—¬í•œ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`; } 
            else {
                historyListHtml = `<ul class="space-y-2">`;
                memberMatches.sort((a,b) => new Date(b.date||0) - new Date(a.date||0)).forEach(match => {
                    let dAtt = scoreRules.attend; let dSin = 0.0; let dWin = 0.0; let achievements = [];
                    if (member.type === 'ì—°íšŒì›') { // ì—°íšŒì›ì¼ë•Œë§Œ ì ìˆ˜ í‘œì‹œ ë¡œì§
                        dAtt = scoreRules.attend; 
                        if (!(match.lazy||[]).includes(member.name)) { dSin = scoreRules.sincerity; } else { achievements.push("<span class='text-red-500'>ë¶ˆì„±ì‹¤</span>"); }
                    } else {
                        dAtt = 0; dSin = 0; // ë¹„íšŒì›ì€ ì ìˆ˜ 0
                    }
                    
                    const checkWin = (arr, pts, label) => { if(arr && arr.includes(member.name)) { achievements.push(label); if(member.type === 'ì—°íšŒì›') dWin += pts; winCount++; } };
                    checkWin(match.lg1, scoreRules.lg1, "ë¦¬ê·¸ 1ë“±"); checkWin(match.lg2, scoreRules.lg2, "ë¦¬ê·¸ 2ë“±"); checkWin(match.lg3, scoreRules.lg3, "ë¦¬ê·¸ 3ë“±");
                    checkWin(match.tm1, scoreRules.tm1, "ë‹¨ì²´ 1ë“±"); checkWin(match.tm2, scoreRules.tm2, "ë‹¨ì²´ 2ë“±"); checkWin(match.tm3, scoreRules.tm3, "ë‹¨ì²´ 3ë“±");
                    checkWin(match.tn1, scoreRules.tn1, "í† ë„ˆ 1ë“±"); checkWin(match.tn2, scoreRules.tn2, "í† ë„ˆ 2ë“±"); checkWin(match.tn3, scoreRules.tn3, "í† ë„ˆ 3ë“±");
                    checkWin(match.db1, scoreRules.db1, "ë³µì‹ 1ë“±"); checkWin(match.db2, scoreRules.db2, "ë³µì‹ 2ë“±"); checkWin(match.ev1, scoreRules.ev1, "ì´ë²¤íŠ¸ ìš°ìŠ¹");
                    
                    attendScore += dAtt; sincerityScore += dSin; winScore += dWin;
                    let achieveStr = achievements.length > 0 ? ` <span class="text-indigo-600 font-bold ml-1">(${achievements.join(', ')})</span>` : "";
                    
                    historyListHtml += `<li class="flex flex-col bg-white p-3 rounded-xl border border-indigo-100 shadow-[0_2px_10px_rgb(0,0,0,0.02)]"><div class="flex justify-between items-center mb-1.5 border-b border-slate-50 pb-1.5"><div><span class="font-extrabold text-slate-800 text-[13px]">${(match.date||'').substring(5)}</span> <span class="text-[9px] text-slate-500 ml-1 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">${match.type}</span></div><div class="font-black text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-lg text-[13px]">+${(dAtt+dSin+dWin).toFixed(1)}</div></div><div class="text-[11px] text-slate-500 flex flex-wrap gap-x-2 gap-y-1 font-medium"><span>ì°¸ì„ <span class="font-bold text-slate-700">+${dAtt.toFixed(1)}</span></span><span class="text-slate-200">|</span><span>ì„±ì‹¤ <span class="font-bold ${dSin > 0 ? 'text-slate-700' : 'text-red-400'}">+${dSin.toFixed(1)}</span></span><span class="text-slate-200">|</span><span>ì…ìƒ <span class="font-bold text-indigo-500">+${dWin.toFixed(1)}</span> ${achieveStr}</span></div></li>`;
                });
                historyListHtml += `</ul>`;
            }

            let winRate = memberMatches.length > 0 ? Math.round((winCount / memberMatches.length) * 100) : 0;
            let rankDiff = (member.prevRank === '-' || member.currentRank === '-') ? 0 : member.prevRank - member.currentRank;
            let rankIcon = rankDiff > 0 ? `ğŸ”º ${rankDiff} ìƒìŠ¹` : rankDiff < 0 ? `ğŸ”» ${Math.abs(rankDiff)} í•˜ë½` : "â– ìœ ì§€";

            let detailHtml = `<div class="p-3 bg-slate-100/50 border-b border-slate-200 shadow-inner animate-fade-in"><div class="bg-white rounded-2xl border border-slate-100 p-4 mb-3 shadow-[0_4px_20px_rgb(0,0,0,0.03)]"><div class="flex justify-between items-center border-b border-slate-100 pb-2 mb-3"><span class="font-extrabold text-slate-700 text-xs">ğŸ“Š ê°œì¸ í†µê³„ ë° ì‚°ì¶œ ê·¼ê±°</span><span class="font-black text-indigo-600 text-lg">${member.score.toFixed(1)}ì </span></div><div class="grid grid-cols-4 text-center text-[10px] divide-x divide-slate-100 border-b border-slate-100 pb-3 mb-3"><div><div class="text-slate-400 mb-1 font-medium">ì…ìƒë¥ </div><div class="font-black text-indigo-500 text-sm">${winRate}%</div></div><div><div class="text-slate-400 mb-1 font-medium">ì°¸ì„ ì´ì </div><div class="font-extrabold text-slate-700 text-sm">${attendScore.toFixed(1)}</div></div><div><div class="text-slate-400 mb-1 font-medium">ì„±ì‹¤ ì´ì </div><div class="font-extrabold text-slate-700 text-sm">${sincerityScore.toFixed(1)}</div></div><div><div class="text-slate-400 mb-1 font-medium">ì…ìƒ ì´ì </div><div class="font-black text-indigo-600 text-sm">${winScore.toFixed(1)}</div></div></div><div class="flex justify-between items-center text-[11px] bg-slate-50 p-2.5 rounded-xl font-medium"><div><span class="text-slate-400">ì´ì „:</span> <span class="font-extrabold text-slate-600">${member.prevRank}ìœ„</span></div><div><span class="text-slate-400">í˜„ì¬:</span> <span class="font-black text-indigo-600">${member.currentRank}ìœ„</span></div><div class="font-extrabold ${rankDiff > 0 ? 'text-red-500' : rankDiff < 0 ? 'text-blue-500' : 'text-slate-400'} bg-white px-2.5 py-1 rounded-lg shadow-sm border border-slate-100">${rankIcon}</div></div></div><h4 class="font-extrabold text-slate-700 text-xs mb-2.5 pl-1">ğŸ” ìƒì„¸ ê²½ê¸° ì°¸ì„ ë‚´ì—­</h4>${historyListHtml}</div>`;
            document.getElementById(`detail-content-${id}`).innerHTML = detailHtml; detailRow.classList.remove('hidden');
        }

        function renderAll() { recalculateAllScores(); renderRanking(); renderHistory(); renderMembersList(); }
        
        // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘
        loadDataFromStorage();
    </script>
</body>
</html>
